DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (111.3ms)[0m  [1m[35mCREATE DATABASE "terminal_dnd_development" ENCODING = 'unicode'[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (8.5ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[35m (3.7ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (1.5ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2025-11-20 05:13:42.517675', '2025-11-20 05:13:42.517677') RETURNING "key"[0m
Migrating to CreateActionLogs (20251119192157)
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.8ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateActionLogs (20251119192157)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK[0m
  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.8ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateActionLogs (20251119192157)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.9ms)[0m  [1m[35mCREATE TABLE "action_logs" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "action_type" character varying NOT NULL, "description" text, "metadata" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192157') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateActiveEffects (20251119192158)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "active_effects" ("id" bigserial primary key, "combatant_id" integer NOT NULL, "effect_type" character varying NOT NULL, "name" character varying, "description" text, "value" integer, "duration_rounds" integer, "save_dc" integer, "trigger" character varying, "metadata" jsonb DEFAULT '{}', "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (2.0ms)[0m  [1m[35mCREATE INDEX "index_active_effects_on_discarded_at" ON "active_effects" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192158') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAdventureTemplates (20251119192159)
  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateAdventureTemplates (20251119192159)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.0ms)[0m  [1m[35mCREATE TABLE "adventure_templates" ("id" bigserial primary key, "title" character varying NOT NULL, "description" text, "difficulty" character varying DEFAULT 'medium', "estimated_duration" integer, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "category" character varying, "status" character varying DEFAULT 'draft', "template_data" jsonb DEFAULT '{}', "creator_id" integer, "completion_count" integer DEFAULT 0, "usage_count" integer DEFAULT 0, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE INDEX "index_adventure_templates_on_discarded_at" ON "adventure_templates" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192159') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAlignments (20251119192160)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "alignments" ("id" bigserial primary key, "name" character varying, "code" character varying, "axis_law_chaos" character varying, "axis_good_evil" character varying, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_alignments_on_discarded_at" ON "alignments" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192160') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateBackgrounds (20251119192161)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.1ms)[0m  [1m[35mCREATE TABLE "backgrounds" ("id" bigserial primary key, "name" character varying, "skill_proficiencies" jsonb, "tool_proficiencies" jsonb, "languages" jsonb, "starting_equipment" jsonb, "feature_name" character varying, "feature_description" text, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_backgrounds_on_discarded_at" ON "backgrounds" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192161') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterClasses (20251119192162)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.9ms)[0m  [1m[35mCREATE TABLE "character_classes" ("id" bigserial primary key, "name" character varying, "hit_die" integer, "primary_ability" character varying, "saving_throw_proficiencies" jsonb, "skill_proficiencies" jsonb, "armor_proficiencies" jsonb, "weapon_proficiencies" jsonb, "starting_equipment" jsonb, "class_features" jsonb, "spellcasting_ability" character varying, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_character_classes_on_discarded_at" ON "character_classes" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192162') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateChatMessages (20251119192163)
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateChatMessages (20251119192163)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (11.1ms)[0m  [1m[35mCREATE TABLE "chat_messages" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "content" text NOT NULL, "message_type" character varying DEFAULT 'public', "recipient_id" integer, "character_id" integer, "private" boolean, "edited" boolean, "deleted" boolean, "deleted_by" character varying, "original_content" text, "dice_results" jsonb DEFAULT '[]', "mentions" jsonb DEFAULT '[]', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_chat_messages_on_discarded_at" ON "chat_messages" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192163') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateConditions (20251119192164)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "conditions" ("id" bigserial primary key, "name" character varying, "description" text, "effects" jsonb, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_conditions_on_discarded_at" ON "conditions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192164') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateContentClones (20251119192165)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "content_clones" ("id" bigserial primary key, "shared_content_id" integer NOT NULL, "user_id" integer NOT NULL, "cloned_content_type" character varying NOT NULL, "cloned_content_id" integer NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_content_clones_on_discarded_at" ON "content_clones" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192165') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateContentLibraries (20251119192166)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.9ms)[0m  [1m[35mCREATE TABLE "content_libraries" ("id" bigserial primary key, "campaign_id" integer, "content_type" character varying, "title" character varying, "description" text, "content_data" jsonb, "tags" jsonb, "ai_generated" boolean, "ai_model" character varying, "generation_prompt" text, "is_public" boolean, "upvotes" integer, "downvotes" integer, "usage_count" integer, "quality_rating" decimal, "reviewed" boolean, "deleted_at" timestamp(6), "user_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_content_libraries_on_discarded_at" ON "content_libraries" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192166') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateContentRatings (20251119192167)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.1ms)[0m  [1m[35mCREATE TABLE "content_ratings" ("id" bigserial primary key, "shared_content_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "helpful_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_content_ratings_on_discarded_at" ON "content_ratings" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192167') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCurrents (20251119192168)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE TABLE "currents" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192168') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateDamageLogs (20251119192169)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "damage_logs" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "source_type" character varying, "source_id" integer, "target_type" character varying, "target_id" integer, "amount" integer NOT NULL, "damage_type" character varying, "description" text, "round_number" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_damage_logs_on_discarded_at" ON "damage_logs" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192169') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateDiceRolls (20251119192170)
  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateDiceRolls (20251119192170)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.4ms)[0m  [1m[35mCREATE TABLE "dice_rolls" ("id" bigserial primary key, "character_id" integer, "game_session_id" integer, "roll_type" character varying, "dice_formula" character varying, "results" jsonb, "total" integer, "modifier" integer, "advantage" boolean, "disadvantage" boolean, "critical" boolean, "context" character varying, "deleted_at" timestamp(6), "user_id" integer, "combat_id" integer, "combat_action_id" integer, "hidden" boolean NOT NULL, "active" boolean DEFAULT TRUE NOT NULL, "ability" character varying, "metadata" text, "state" character varying DEFAULT 'rolled' NOT NULL, "locked" boolean NOT NULL, "original_roll_id" integer, "superseded_by_roll_id" integer, "reroll_reason" text, "dm_approved_by" integer, "dm_approved_at" timestamp(6), "reroll_requested_at" timestamp(6), "auto_confirmed" boolean NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_dice_rolls_on_discarded_at" ON "dice_rolls" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192170') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateDungeonTemplates (20251119192171)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.8ms)[0m  [1m[35mCREATE TABLE "dungeon_templates" ("id" bigserial primary key, "name" character varying, "description" text, "dungeon_type" character varying, "min_party_level" integer, "max_party_level" integer, "room_count_min" integer, "room_count_max" integer, "monster_density" character varying, "trap_density" character varying, "treasure_quality" character varying, "themes" jsonb, "special_features" jsonb, "created_by_user_id" integer, "is_public" boolean, "usage_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_dungeon_templates_on_discarded_at" ON "dungeon_templates" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192171') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFactionMemberships (20251119192172)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "faction_memberships" ("id" bigserial primary key, "character_id" integer, "rank" character varying, "title" character varying, "reputation" integer, "joined_at" timestamp(6), "left_at" timestamp(6), "status" character varying, "contributions" jsonb, "deleted_at" timestamp(6), "faction_id" integer, "npc_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_faction_memberships_on_discarded_at" ON "faction_memberships" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192172') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFactionRelationships (20251119192173)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.6ms)[0m  [1m[35mCREATE TABLE "faction_relationships" ("id" bigserial primary key, "related_faction_id" integer, "relationship_type" character varying, "relationship_strength" integer, "history" text, "treaties" jsonb, "conflicts" jsonb, "deleted_at" timestamp(6), "faction_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_faction_relationships_on_discarded_at" ON "faction_relationships" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192173') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFeats (20251119192174)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.2ms)[0m  [1m[35mCREATE TABLE "feats" ("id" bigserial primary key, "name" character varying NOT NULL, "description" text, "prerequisites" text, "ability_score_increases" jsonb DEFAULT '{}', "benefits" jsonb DEFAULT '{}', "source" character varying DEFAULT 'SRD', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192174') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateGeneratedDungeons (20251119192175)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "generated_dungeons" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "party_level" integer, "room_count" integer, "layout_data" jsonb, "room_descriptions" jsonb, "monster_placements" jsonb, "trap_locations" jsonb, "treasure_locations" jsonb, "secret_areas" jsonb, "boss_room_id" character varying, "entrance_room_id" character varying, "narrative_theme" text, "difficulty_rating" character varying, "generated_at" timestamp(6), "explored_rooms" jsonb, "deleted_at" timestamp(6), "dungeon_template_id" integer, "location_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_generated_dungeons_on_discarded_at" ON "generated_dungeons" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192175') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateHealingLogs (20251119192176)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "healing_logs" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "source_type" character varying, "source_id" integer, "target_type" character varying, "target_id" integer, "amount" integer NOT NULL, "description" text, "round_number" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE INDEX "index_healing_logs_on_discarded_at" ON "healing_logs" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192176') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateIdempotentRequests (20251119192177)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.7ms)[0m  [1m[35mCREATE TABLE "idempotent_requests" ("id" bigserial primary key, "idempotency_key" character varying NOT NULL, "character_id" integer NOT NULL, "action_type" character varying NOT NULL, "response_data" jsonb, "status_code" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192177') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateLanguages (20251119192178)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.0ms)[0m  [1m[35mCREATE TABLE "languages" ("id" bigserial primary key, "name" character varying, "script" character varying, "typical_speakers" text, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_languages_on_discarded_at" ON "languages" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192178') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateLocations (20251119192179)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "locations" ("id" bigserial primary key, "world_id" integer, "parent_location_id" integer, "name" character varying, "location_type" character varying, "description" text, "population" integer, "government_type" character varying, "notable_features" jsonb, "shops" jsonb, "taverns" jsonb, "points_of_interest" jsonb, "climate" character varying, "terrain" character varying, "coordinates_x" integer, "coordinates_y" integer, "danger_level" integer, "visited" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_locations_on_discarded_at" ON "locations" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192179') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateLootTables (20251119192180)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.4ms)[0m  [1m[35mCREATE TABLE "loot_tables" ("id" bigserial primary key, "name" character varying NOT NULL, "description" text, "table_type" character varying, "challenge_rating_min" decimal, "challenge_rating_max" decimal, "source" character varying, "user_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_loot_tables_on_discarded_at" ON "loot_tables" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192180') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateLootTableEntries (20251119192181)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.3ms)[0m  [1m[35mCREATE TABLE "loot_table_entries" ("id" bigserial primary key, "loot_table_id" integer NOT NULL, "treasure_type" character varying NOT NULL, "quantity_dice" character varying, "weight" integer DEFAULT 1, "item_id" integer, "treasure_data" jsonb DEFAULT '{}', "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_loot_table_entries_on_discarded_at" ON "loot_table_entries" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192181') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateMessageReactions (20251119192182)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.4ms)[0m  [1m[35mCREATE TABLE "message_reactions" ("id" bigserial primary key, "chat_message_id" integer NOT NULL, "user_id" integer NOT NULL, "emoji" character varying NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192182') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateNotifications (20251119192183)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.5ms)[0m  [1m[35mCREATE TABLE "notifications" ("id" bigserial primary key, "user_id" integer NOT NULL, "notifiable_type" character varying, "notifiable_id" integer, "notification_type" character varying NOT NULL, "title" character varying NOT NULL, "message" text NOT NULL, "priority" character varying DEFAULT 'medium' NOT NULL, "metadata" jsonb DEFAULT '{}', "read_at" timestamp(6), "action_url" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192183') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateRaces (20251119192184)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.0ms)[0m  [1m[35mCREATE TABLE "races" ("id" bigserial primary key, "name" character varying, "size" character varying, "speed" integer, "ability_increases" jsonb, "traits" jsonb, "languages" jsonb, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_races_on_discarded_at" ON "races" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192184') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSoloGameStates (20251119192185)
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.9ms)[0m  [1m[35mCREATE TABLE "solo_game_states" ("id" bigserial primary key, "current_scene" character varying, "current_location" character varying, "time_of_day" character varying, "weather" character varying, "combat_active" boolean, "scene_data" jsonb, "npcs_present" jsonb, "active_quests" jsonb, "inventory_state" jsonb, "resources" jsonb, "solo_session_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_solo_game_states_on_discarded_at" ON "solo_game_states" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192185') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateTemplateRatings (20251119192186)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.2ms)[0m  [1m[35mCREATE TABLE "template_ratings" ("id" bigserial primary key, "campaign_template_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "helpful_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_template_ratings_on_discarded_at" ON "template_ratings" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192186') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateTokens (20251119192187)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.2ms)[0m  [1m[35mCREATE TABLE "tokens" ("id" bigserial primary key, "character_id" integer, "name" character varying, "token_type" character varying, "grid_x" integer, "grid_y" integer, "size" character varying, "color" character varying, "icon" character varying, "visible_to_players" boolean, "current_hit_points" integer, "max_hit_points" integer, "deleted_at" timestamp(6), "map_id" integer, "encounter_monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_tokens_on_discarded_at" ON "tokens" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192187') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateUsers (20251119192188)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.2ms)[0m  [1m[35mCREATE TABLE "users" ("id" bigserial primary key, "email" character varying NOT NULL, "password_digest" character varying NOT NULL, "role" character varying DEFAULT 'user', "discarded_at" timestamp(6), "username" character varying, "bio" text, "avatar_url" character varying, "experience_points" integer, "level" integer, "preferences" character varying, "timezone" character varying, "last_active_at" timestamp(6), "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_users_on_discarded_at" ON "users" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192188') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateUserBlocks (20251119192189)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.9ms)[0m  [1m[35mCREATE TABLE "user_blocks" ("id" bigserial primary key, "blocker_id" integer NOT NULL, "blocked_id" integer NOT NULL, "reason" character varying, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_user_blocks_on_discarded_at" ON "user_blocks" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192189') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateUserThemePreferences (20251119192190)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "user_theme_preferences" ("id" bigserial primary key, "user_id" integer NOT NULL, "primary_color" character varying, "secondary_color" character varying, "accent_color" character varying, "background_color" character varying, "text_color" character varying, "dark_mode" boolean NOT NULL, "high_contrast" boolean NOT NULL, "reduced_motion" boolean NOT NULL, "font_size" character varying DEFAULT 'medium', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192190') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateVttMaps (20251119192191)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.4ms)[0m  [1m[35mCREATE TABLE "vtt_maps" ("id" bigserial primary key, "vtt_session_id" integer NOT NULL, "background_url" character varying NOT NULL, "width" integer DEFAULT 30 NOT NULL, "height" integer DEFAULT 20 NOT NULL, "grid_overlay" boolean DEFAULT TRUE NOT NULL, "terrain_features" jsonb DEFAULT '[]', "metadata" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192191') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateVttTokens (20251119192192)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "vtt_tokens" ("id" bigserial primary key, "vtt_session_id" integer NOT NULL, "character_id" integer, "npc_id" integer, "monster_id" integer, "x" decimal DEFAULT 0.0 NOT NULL, "y" decimal DEFAULT 0.0 NOT NULL, "rotation" integer DEFAULT 0 NOT NULL, "hidden" boolean NOT NULL, "size" character varying DEFAULT 'medium' NOT NULL, "metadata" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192192') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWorlds (20251119192193)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.3ms)[0m  [1m[35mCREATE TABLE "worlds" ("id" bigserial primary key, "name" character varying, "description" text, "settings" jsonb, "creator_id" integer, "visibility" character varying, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_worlds_on_discarded_at" ON "worlds" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192193') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWorldLoreEntries (20251119192194)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "world_lore_entries" ("id" bigserial primary key, "title" character varying, "entry_type" character varying, "content" text, "tags" jsonb, "metadata" jsonb, "visibility" character varying, "created_by_id" integer, "deleted_at" timestamp(6), "world_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE INDEX "index_world_lore_entries_on_discarded_at" ON "world_lore_entries" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192194') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiContexts (20251119192195)
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.4ms)[0m  [1m[35mCREATE TABLE "ai_contexts" ("id" bigserial primary key, "character_id" integer NOT NULL, "solo_session_id" integer, "long_term_memory" jsonb DEFAULT '{}' NOT NULL, "character_traits" jsonb DEFAULT '{}' NOT NULL, "world_state" jsonb DEFAULT '{}' NOT NULL, "relationship_web" jsonb DEFAULT '{}' NOT NULL, "active_quests" jsonb DEFAULT '[]' NOT NULL, "plot_threads" jsonb DEFAULT '[]' NOT NULL, "npcs_met" jsonb DEFAULT '[]' NOT NULL, "locations_visited" jsonb DEFAULT '[]' NOT NULL, "important_items" jsonb DEFAULT '[]' NOT NULL, "major_events" jsonb DEFAULT '[]' NOT NULL, "session_summaries" jsonb DEFAULT '[]' NOT NULL, "context_seed" text, "last_context_update" timestamp(6), "context_version" integer DEFAULT 1 NOT NULL, "estimated_token_count" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192195') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiConversations (20251119192196)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "ai_conversations" ("id" bigserial primary key, "solo_session_id" integer, "character_id" integer, "title" character varying, "status" character varying, "ai_model" character varying, "system_prompt" text, "context_data" jsonb, "message_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_ai_conversations_on_discarded_at" ON "ai_conversations" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192196') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiDmAssistants (20251119192197)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "ai_dm_assistants" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "enabled" boolean DEFAULT TRUE NOT NULL, "paused" boolean NOT NULL, "creativity_level" character varying DEFAULT 'balanced' NOT NULL, "tone" character varying DEFAULT 'heroic' NOT NULL, "setting_context" text, "suggestion_types" jsonb NOT NULL, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_ai_dm_assistants_on_discarded_at" ON "ai_dm_assistants" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192197') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiDmContexts (20251119192198)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.5ms)[0m  [1m[35mCREATE TABLE "ai_dm_contexts" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "game_session_id" integer NOT NULL, "conversation_history" jsonb DEFAULT '[]' NOT NULL, "active_npcs" jsonb DEFAULT '[]' NOT NULL, "recent_events" jsonb DEFAULT '[]' NOT NULL, "unresolved_threads" jsonb DEFAULT '[]' NOT NULL, "campaign_memory" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192198') RETURNING "version"[0m
  [1m[36mTRANSACTION (2.0ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiDmOverrides (20251119192199)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "ai_dm_overrides" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "ai_dm_suggestion_id" integer NOT NULL, "user_id" integer NOT NULL, "original_suggestion" text NOT NULL, "dm_override" text NOT NULL, "override_type" character varying NOT NULL, "context_when_overridden" jsonb DEFAULT '{}' NOT NULL, "reasoning" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192199') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiDmSuggestions (20251119192200)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.2ms)[0m  [1m[35mCREATE TABLE "ai_dm_suggestions" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "game_session_id" integer, "user_id" integer NOT NULL, "suggestion_type" character varying NOT NULL, "content" text NOT NULL, "edited_content" text, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_ai_dm_suggestions_on_discarded_at" ON "ai_dm_suggestions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192200') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateAiMessages (20251119192201)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.6ms)[0m  [1m[35mCREATE TABLE "ai_messages" ("id" bigserial primary key, "role" character varying, "content" text, "dice_rolls" jsonb, "narrative_tags" jsonb, "tokens_used" integer, "response_time_ms" integer, "deleted_at" timestamp(6), "ai_conversation_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_ai_messages_on_discarded_at" ON "ai_messages" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192201') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaigns (20251119192202)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "campaigns" ("id" bigserial primary key, "name" character varying, "description" text, "status" character varying, "visibility" character varying DEFAULT 'private', "dm_id" integer, "theme" character varying, "world_time" character varying, "current_location" character varying, "settings" jsonb, "house_rules" jsonb, "max_players" integer, "timezone" character varying, "session_frequency" character varying, "ai_assistant_enabled" boolean, "deleted_at" timestamp(6), "world_id" integer, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "category" character varying, "tags" jsonb DEFAULT '[]', "discarded_at" timestamp(6), "template_id" integer, "looking_for_players" boolean, "player_capacity" integer, "play_style" character varying, "next_session_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_campaigns_on_discarded_at" ON "campaigns" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192202') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignJoinRequests (20251119192203)
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.4ms)[0m  [1m[35mCREATE TABLE "campaign_join_requests" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_campaign_join_requests_on_discarded_at" ON "campaign_join_requests" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192203') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignMemberships (20251119192204)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.9ms)[0m  [1m[35mCREATE TABLE "campaign_memberships" ("id" bigserial primary key, "role" character varying, "active" boolean, "user_id" integer, "campaign_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_campaign_memberships_on_discarded_at" ON "campaign_memberships" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192204') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignMetrics (20251119192205)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "campaign_metrics" ("id" bigserial primary key, "campaign_id" integer, "metric_date" date, "sessions_count" integer, "total_playtime_minutes" integer, "encounters_count" integer, "combats_count" integer, "npcs_met_count" integer, "quests_started" integer, "quests_completed" integer, "locations_visited" integer, "player_deaths" integer, "monsters_defeated" integer, "treasure_gained_gp" decimal, "experience_gained" integer, "engagement_scores" jsonb, "pacing_analysis" jsonb, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (7.8ms)[0m  [1m[35mCREATE INDEX "index_campaign_metrics_on_discarded_at" ON "campaign_metrics" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192205') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignNotes (20251119192206)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.4ms)[0m  [1m[35mCREATE TABLE "campaign_notes" ("id" bigserial primary key, "title" character varying, "content" text, "note_type" character varying, "visibility" character varying, "campaign_id" integer, "user_id" integer, "game_session_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_campaign_notes_on_discarded_at" ON "campaign_notes" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192206') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignRatings (20251119192207)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.2ms)[0m  [1m[35mCREATE TABLE "campaign_ratings" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_campaign_ratings_on_discarded_at" ON "campaign_ratings" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192207') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCampaignTemplates (20251119192208)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.7ms)[0m  [1m[35mCREATE TABLE "campaign_templates" ("id" bigserial primary key, "user_id" integer NOT NULL, "name" character varying NOT NULL, "description" text, "category" character varying, "tags" jsonb DEFAULT '[]', "template_data" jsonb DEFAULT '{}' NOT NULL, "visibility" character varying DEFAULT 'public' NOT NULL, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "use_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE INDEX "index_campaign_templates_on_discarded_at" ON "campaign_templates" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192208') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateExportArchives (20251119192209)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.6ms)[0m  [1m[35mCREATE TABLE "export_archives" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "archive_type" character varying NOT NULL, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192209') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFactions (20251119192210)
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.6ms)[0m  [1m[35mCREATE TABLE "factions" ("id" bigserial primary key, "campaign_id" integer, "world_id" integer, "name" character varying, "faction_type" character varying, "alignment_id" integer, "description" text, "goals" jsonb, "resources" jsonb, "territory" jsonb, "power_level" integer, "headquarters_location_id" integer, "leader_npc_id" integer, "symbols" text, "colors" character varying, "motto" character varying, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_factions_on_discarded_at" ON "factions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192210') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateGameSessions (20251119192211)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "game_sessions" ("id" bigserial primary key, "title" character varying, "session_number" integer, "scheduled_at" timestamp(6), "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_game_sessions_on_discarded_at" ON "game_sessions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192211') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateGameSessionParticipants (20251119192212)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "game_session_participants" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_game_session_participants_on_discarded_at" ON "game_session_participants" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192212') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateGeneratedTreasures (20251119192213)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.0ms)[0m  [1m[35mCREATE TABLE "generated_treasures" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "loot_table_id" integer NOT NULL, "treasure_data" jsonb DEFAULT '{}', "generated_at" timestamp(6), "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (2.2ms)[0m  [1m[35mCREATE INDEX "index_generated_treasures_on_discarded_at" ON "generated_treasures" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192213') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateMaps (20251119192214)
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.8ms)[0m  [1m[35mCREATE TABLE "maps" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "description" text, "grid_width" integer, "grid_height" integer, "grid_size" integer, "background_color" character varying, "terrain_data" jsonb, "fog_of_war_enabled" boolean, "fog_of_war_data" jsonb, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_maps_on_discarded_at" ON "maps" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.5ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192214') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreatePlayerEngagements (20251119192215)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "player_engagements" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (2.0ms)[0m  [1m[35mCREATE INDEX "index_player_engagements_on_discarded_at" ON "player_engagements" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192215') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreatePlotHooks (20251119192216)
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.0ms)[0m  [1m[35mCREATE TABLE "plot_hooks" ("id" bigserial primary key, "campaign_id" integer, "created_by_user_id" integer, "title" character varying, "description" text, "hook_type" character varying, "urgency" character varying, "complexity" character varying, "suggested_level_min" integer, "suggested_level_max" integer, "factions_involved" jsonb, "npcs_involved" jsonb, "locations_involved" jsonb, "rewards_suggested" jsonb, "complications" jsonb, "status" character varying, "converted_to_quest_id" integer, "ai_generated" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_plot_hooks_on_discarded_at" ON "plot_hooks" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192216') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSessions (20251119192217)
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.5ms)[0m  [1m[35mCREATE TABLE "sessions" ("id" bigserial primary key, "user_id" integer NOT NULL, "user_agent" character varying, "ip_address" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192217') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSessionPresences (20251119192218)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "session_presences" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "status" character varying DEFAULT 'offline' NOT NULL, "connection_count" integer DEFAULT 0 NOT NULL, "last_activity_at" timestamp(6), "disconnected_at" timestamp(6), "status_message" character varying, "manual_status" boolean NOT NULL, "ip_address" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192218') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSessionRecaps (20251119192219)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.6ms)[0m  [1m[35mCREATE TABLE "session_recaps" ("id" bigserial primary key, "game_session_id" integer, "generated_by_user_id" integer, "summary" text, "key_events" jsonb, "npcs_met" jsonb, "locations_visited" jsonb, "combat_summary" text, "experience_gained" integer, "treasure_found" text, "quests_updated" jsonb, "auto_generated" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_session_recaps_on_discarded_at" ON "session_recaps" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192219') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSoloSessions (20251119192220)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.7ms)[0m  [1m[35mCREATE TABLE "solo_sessions" ("id" bigserial primary key, "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (2.5ms)[0m  [1m[35mCREATE INDEX "index_solo_sessions_on_discarded_at" ON "solo_sessions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192220') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateVttSessions (20251119192221)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.4ms)[0m  [1m[35mCREATE TABLE "vtt_sessions" ("id" bigserial primary key, "game_session_id" integer NOT NULL, "campaign_id" integer NOT NULL, "location_id" integer, "encounter_id" integer, "grid_size" integer DEFAULT 50 NOT NULL, "grid_type" character varying DEFAULT 'square' NOT NULL, "zoom_level" decimal DEFAULT 1.0, "active" boolean DEFAULT TRUE NOT NULL, "round_number" integer DEFAULT 0, "state_snapshot" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192221') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacters (20251119192222)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.7ms)[0m  [1m[35mCREATE TABLE "characters" ("id" bigserial primary key, "name" character varying, "level" integer, "experience" integer, "proficiency_bonus" integer, "strength" integer, "dexterity" integer, "constitution" integer, "intelligence" integer, "wisdom" integer, "charisma" integer, "hit_points_current" integer, "hit_points_max" integer, "temporary_hit_points" integer, "armor_class" integer, "initiative_bonus" integer, "speed" integer, "alignment" character varying, "personality_traits" text, "ideals" text, "bonds" text, "flaws" text, "backstory" text, "skills" jsonb, "proficiencies" jsonb, "conditions" jsonb, "avatar_url" character varying, "visibility" character varying, "deleted_at" timestamp(6), "user_id" integer, "campaign_id" integer, "race_id" integer, "character_class_id" integer, "background_id" integer, "character_voice" text, "ai_personality_profile" jsonb DEFAULT '{}', "catchphrases" jsonb DEFAULT '[]', "homebrew_modifications" jsonb DEFAULT '{}', "custom_features" jsonb DEFAULT '[]', "house_rules" jsonb DEFAULT '{}', "quick_actions" jsonb DEFAULT '[]', "favorite_spells" jsonb DEFAULT '[]', "combat_tactics" jsonb DEFAULT '[]', "theme_preferences" jsonb DEFAULT '{}', "portrait_url" character varying, "token_url" character varying, "last_session_notes" text, "session_count" integer DEFAULT 0, "total_playtime_hours" decimal DEFAULT 0.0, "faction_affiliations" jsonb DEFAULT '{}' NOT NULL, "faction_reputations" jsonb DEFAULT '{}' NOT NULL, "current_hp" integer, "max_hp" integer, "temporary_hp" integer DEFAULT 0 NOT NULL, "death_save_successes" integer DEFAULT 0 NOT NULL, "death_save_failures" integer DEFAULT 0 NOT NULL, "spell_slots" jsonb DEFAULT '{}' NOT NULL, "concentration_spell_id" integer, "damage_resistances" jsonb DEFAULT '[]' NOT NULL, "damage_immunities" jsonb DEFAULT '[]' NOT NULL, "damage_vulnerabilities" jsonb DEFAULT '[]' NOT NULL, "active_effects" jsonb DEFAULT '[]', "resistances" jsonb DEFAULT '[]', "immunities" jsonb DEFAULT '[]', "vulnerabilities" jsonb DEFAULT '[]', "hit_dice_used" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_characters_on_discarded_at" ON "characters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192222') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterAiAssistants (20251119192223)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "character_ai_assistants" ("id" bigserial primary key, "character_id" integer NOT NULL, "conversation_history" jsonb DEFAULT '[]', "generated_content" jsonb DEFAULT '{}', "tactical_suggestions" jsonb DEFAULT '[]', "roleplay_prompts" jsonb DEFAULT '[]', "personality_analysis" jsonb DEFAULT '{}', "preferred_ai_model" character varying, "ai_usage_tokens" integer DEFAULT 0, "ai_enabled" boolean DEFAULT TRUE, "custom_instructions" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192223') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterCombatTrackers (20251119192224)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "character_combat_trackers" ("id" bigserial primary key, "character_id" integer NOT NULL, "action_resources" jsonb DEFAULT '{}', "death_saves" jsonb, "conditions" jsonb DEFAULT '[]', "resistances" jsonb DEFAULT '[]', "immunities" jsonb DEFAULT '[]', "vulnerabilities" jsonb DEFAULT '[]', "temp_hp" integer DEFAULT 0, "exhaustion_level" integer DEFAULT 0, "initiative_roll" integer, "has_reaction" boolean DEFAULT TRUE, "has_bonus_action" boolean DEFAULT TRUE, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192224') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterFeats (20251119192225)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.2ms)[0m  [1m[35mCREATE TABLE "character_feats" ("id" bigserial primary key, "character_id" integer NOT NULL, "feat_id" integer NOT NULL, "level_gained" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192225') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterInventories (20251119192226)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.1ms)[0m  [1m[35mCREATE TABLE "character_inventories" ("id" bigserial primary key, "character_id" integer NOT NULL, "equipped_items" jsonb DEFAULT '{}', "inventory_grid" jsonb DEFAULT '[]', "carry_capacity" integer DEFAULT 150, "current_weight" integer DEFAULT 0, "equipment_sets" jsonb DEFAULT '{}', "active_set" character varying, "currency" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_discarded_at" ON "character_inventories" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192226') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterItems (20251119192227)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.3ms)[0m  [1m[35mCREATE TABLE "character_items" ("id" bigserial primary key, "quantity" integer, "equipped" boolean, "attuned" boolean, "identified" boolean, "notes" text, "character_id" integer, "item_id" integer, "discarded_at" timestamp(6), "lock_version" integer DEFAULT 0 NOT NULL, "equipment_slot" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (2.5ms)[0m  [1m[35mCREATE INDEX "index_character_items_on_discarded_at" ON "character_items" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.5ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192227') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterNotes (20251119192228)
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.3ms)[0m  [1m[35mCREATE TABLE "character_notes" ("id" bigserial primary key, "title" character varying, "content" text, "note_type" character varying, "character_id" integer, "discarded_at" timestamp(6), "note_category" character varying DEFAULT 'quick_note', "tags" jsonb DEFAULT '[]', "session_number" integer, "session_date" date, "priority" character varying DEFAULT 'medium', "completed" boolean, "completed_at" timestamp(6), "npc_name" character varying, "relationship_status" character varying, "faction_affiliation" character varying, "last_interaction_date" date, "metadata" jsonb DEFAULT '{}', "pinned" boolean, "character_limit" integer DEFAULT 5000, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_character_notes_on_discarded_at" ON "character_notes" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192228') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterProgressions (20251119192229)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.3ms)[0m  [1m[35mCREATE TABLE "character_progressions" ("id" bigserial primary key, "character_id" integer NOT NULL, "level_history" jsonb DEFAULT '[]', "multiclass_levels" jsonb DEFAULT '{}', "feat_choices" jsonb DEFAULT '[]', "asi_choices" jsonb DEFAULT '[]', "subclass_features" jsonb DEFAULT '{}', "milestone_tracker" jsonb DEFAULT '[]', "next_level_xp" integer, "progression_type" character varying, "planned_levels" jsonb DEFAULT '[]', "xp_history" jsonb DEFAULT '[]' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192229') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterRelationships (20251119192230)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.2ms)[0m  [1m[35mCREATE TABLE "character_relationships" ("id" bigserial primary key, "character_id" integer NOT NULL, "related_character_id" integer, "relationship_type" character varying, "bond_strength" integer DEFAULT 50, "shared_history" jsonb DEFAULT '[]', "relationship_modifiers" jsonb DEFAULT '{}', "notes" text, "is_npc" boolean, "npc_name" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192230') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterSpells (20251119192231)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.7ms)[0m  [1m[35mCREATE TABLE "character_spells" ("id" bigserial primary key, "known" boolean, "prepared" boolean, "always_prepared" boolean, "character_id" integer, "spell_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_character_spells_on_discarded_at" ON "character_spells" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192231') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterSpellManagers (20251119192232)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.3ms)[0m  [1m[35mCREATE TABLE "character_spell_managers" ("id" bigserial primary key, "character_id" integer NOT NULL, "spell_slots" jsonb DEFAULT '{}', "prepared_spells" jsonb DEFAULT '[]', "known_spells" jsonb DEFAULT '[]', "ritual_spells" jsonb DEFAULT '[]', "spell_book" jsonb DEFAULT '[]', "spellcasting_ability" character varying, "spell_save_dc" integer, "spell_attack_bonus" integer, "cantrips_known" integer DEFAULT 0, "concentration" jsonb DEFAULT '{}', "lock_version" integer DEFAULT 0 NOT NULL, "sorcery_points_max" integer DEFAULT 0, "sorcery_points_current" integer DEFAULT 0, "known_metamagics" jsonb DEFAULT '[]', "metamagic_options" jsonb DEFAULT '{}', "wild_magic_surge_count" integer DEFAULT 0, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (1.0ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192232') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCharacterTemplates (20251119192233)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "character_templates" ("id" bigserial primary key, "name" character varying NOT NULL, "template_type" character varying, "description" text, "template_data" jsonb DEFAULT '{}', "user_id" integer, "is_public" boolean, "usage_count" integer DEFAULT 0, "rating_sum" integer DEFAULT 0, "rating_count" integer DEFAULT 0, "tags" jsonb DEFAULT '[]', "compatible_classes" jsonb DEFAULT '[]', "min_level" integer, "max_level" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192233') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCombats (20251119192234)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.0ms)[0m  [1m[35mCREATE TABLE "combats" ("id" bigserial primary key, "game_session_id" integer, "status" character varying, "current_round" integer, "current_turn" integer, "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (9.9ms)[0m  [1m[35mCREATE INDEX "index_combats_on_discarded_at" ON "combats" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192234') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCombatActions (20251119192235)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.4ms)[0m  [1m[35mCREATE TABLE "combat_actions" ("id" bigserial primary key, "round_number" integer, "action_type" character varying, "target_participant_id" integer, "description" text, "attack_roll" integer, "damage_roll" integer, "damage_type" character varying, "healing_amount" integer, "spell_id" integer, "item_id" integer, "success" boolean, "critical_hit" boolean, "critical_fail" boolean, "deleted_at" timestamp(6), "combat_id" integer, "combat_participant_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_combat_actions_on_discarded_at" ON "combat_actions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.7ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192235') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCombatEncounters (20251119192236)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "combat_encounters" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "game_session_id" integer, "status" character varying DEFAULT 'preparing' NOT NULL, "current_round" integer DEFAULT 0, "current_turn" integer DEFAULT 0, "current_turn_combatant_id" integer, "paused" boolean, "turn_timer_seconds" integer, "turn_started_at" timestamp(6), "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.7ms)[0m  [1m[35mCREATE INDEX "index_combat_encounters_on_discarded_at" ON "combat_encounters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192236') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCombatParticipants (20251119192237)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "combat_participants" ("id" bigserial primary key, "character_id" integer, "initiative" integer, "initiative_modifier" integer, "current_hit_points" integer, "max_hit_points" integer, "temporary_hit_points" integer, "armor_class" integer, "conditions" jsonb, "concentrating_on" character varying, "is_active" boolean, "defeated" boolean, "deleted_at" timestamp(6), "combat_id" integer, "encounter_monster_id" integer, "death_save_successes" integer DEFAULT 0 NOT NULL, "death_save_failures" integer DEFAULT 0 NOT NULL, "actions_used" integer DEFAULT 0 NOT NULL, "bonus_actions_used" integer DEFAULT 0 NOT NULL, "reactions_used" integer DEFAULT 0 NOT NULL, "name" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_combat_participants_on_discarded_at" ON "combat_participants" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192237') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateCombatants (20251119192238)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "combatants" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "character_id" integer, "name" character varying, "combatant_type" character varying DEFAULT 'pc' NOT NULL, "initiative" integer, "dexterity" integer, "status" character varying DEFAULT 'conscious', "death_save_successes" integer DEFAULT 0, "death_save_failures" integer DEFAULT 0, "challenge_rating" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_combatants_on_discarded_at" ON "combatants" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192238') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateEncounters (20251119192239)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.7ms)[0m  [1m[35mCREATE TABLE "encounters" ("id" bigserial primary key, "campaign_id" integer, "game_session_id" integer, "name" character varying, "description" text, "difficulty" character varying, "status" character varying, "experience_awarded" integer, "treasure_awarded" text, "started_at" timestamp(6), "completed_at" timestamp(6), "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_encounters_on_discarded_at" ON "encounters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192239') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateEncounterMonsters (20251119192240)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.7ms)[0m  [1m[35mCREATE TABLE "encounter_monsters" ("id" bigserial primary key, "quantity" integer, "current_hit_points" integer, "max_hit_points" integer, "initiative" integer, "conditions" jsonb, "notes" text, "defeated" boolean, "deleted_at" timestamp(6), "encounter_id" integer, "monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_encounter_monsters_on_discarded_at" ON "encounter_monsters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192240') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateEncounterTemplates (20251119192241)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "encounter_templates" ("id" bigserial primary key, "name" character varying, "description" text, "min_party_level" integer, "max_party_level" integer, "monster_types" jsonb, "terrain_types" jsonb, "difficulty_modifier" decimal, "environmental_hazards" jsonb, "objectives" jsonb, "rewards" jsonb, "created_by_user_id" integer, "is_public" boolean, "usage_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_encounter_templates_on_discarded_at" ON "encounter_templates" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192241') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateGeneratedEncounters (20251119192242)
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.2ms)[0m  [1m[35mCREATE TABLE "generated_encounters" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "party_level" integer, "party_size" integer, "difficulty_rating" character varying, "total_xp" integer, "monsters_data" jsonb, "terrain_features" jsonb, "treasure" jsonb, "narrative_hook" text, "tactics" text, "generated_at" timestamp(6), "used_in_encounter_id" integer, "deleted_at" timestamp(6), "encounter_template_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_generated_encounters_on_discarded_at" ON "generated_encounters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192242') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFriendRequests (20251119192243)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.5ms)[0m  [1m[35mCREATE TABLE "friend_requests" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_friend_requests_on_discarded_at" ON "friend_requests" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192243') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateFriendships (20251119192244)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "friendships" ("id" bigserial primary key, "user_id" integer NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_friendships_on_discarded_at" ON "friendships" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192244') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSharedContents (20251119192245)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "shared_contents" ("id" bigserial primary key, "user_id" integer NOT NULL, "content_type" character varying NOT NULL, "content_id" integer NOT NULL, "title" character varying NOT NULL, "description" text, "visibility" character varying DEFAULT 'public' NOT NULL, "license_type" character varying DEFAULT 'cc_by' NOT NULL, "view_count" integer DEFAULT 0 NOT NULL, "clone_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_shared_contents_on_discarded_at" ON "shared_contents" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192245') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateHomebrewItems (20251119192246)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.7ms)[0m  [1m[35mCREATE TABLE "homebrew_items" ("id" bigserial primary key, "campaign_id" integer, "homebrew_type" character varying, "name" character varying, "description" text, "stat_block" jsonb, "source_reference" character varying, "balance_rating" integer, "published" boolean, "upvotes" integer, "deleted_at" timestamp(6), "user_id" integer, "content" jsonb, "visibility" character varying DEFAULT 'private', "version" integer DEFAULT 1, "tags" character varying, "balance_notes" text, "active" boolean DEFAULT TRUE, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_homebrew_items_on_discarded_at" ON "homebrew_items" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192246') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateItems (20251119192247)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.0ms)[0m  [1m[35mCREATE TABLE "items" ("id" bigserial primary key, "name" character varying, "item_type" character varying, "rarity" character varying, "description" text, "properties" jsonb, "weight" decimal, "cost_gp" decimal, "magic" boolean, "requires_attunement" boolean, "discarded_at" timestamp(6), "source" character varying, "armor_class" integer, "armor_type" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_items_on_discarded_at" ON "items" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192247') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateWeapons (20251119192248)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "weapons" ("id" bigserial primary key, "name" character varying NOT NULL, "damage_dice" character varying NOT NULL, "damage_type" character varying, "properties" jsonb DEFAULT '[]', "versatile_damage" character varying, "character_id" integer, "item_id" integer, "active" boolean DEFAULT TRUE, "equipped" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE INDEX "index_weapons_on_discarded_at" ON "weapons" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.5ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192248') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateMonsters (20251119192249)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.7ms)[0m  [1m[35mCREATE TABLE "monsters" ("id" bigserial primary key, "name" character varying, "size" character varying, "creature_type" character varying, "alignment_id" integer, "armor_class" integer, "hit_points" integer, "hit_dice" character varying, "speed" character varying, "strength" integer, "dexterity" integer, "constitution" integer, "intelligence" integer, "wisdom" integer, "charisma" integer, "challenge_rating" decimal, "experience_points" integer, "skills" jsonb, "damage_vulnerabilities" text, "damage_resistances" text, "damage_immunities" text, "condition_immunities" text, "senses" text, "languages" text, "description" text, "source" character varying, "deleted_at" timestamp(6), "saving_throws" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_monsters_on_discarded_at" ON "monsters" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192249') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateMonsterAbilities (20251119192250)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.4ms)[0m  [1m[35mCREATE TABLE "monster_abilities" ("id" bigserial primary key, "name" character varying, "ability_type" character varying, "description" text, "attack_bonus" integer, "damage_dice" character varying, "damage_type" character varying, "save_dc" integer, "save_ability" character varying, "recharge" character varying, "deleted_at" timestamp(6), "monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_monster_abilities_on_discarded_at" ON "monster_abilities" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192250') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateNpcs (20251119192251)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.6ms)[0m  [1m[35mCREATE TABLE "npcs" ("id" bigserial primary key, "campaign_id" integer, "world_id" integer, "name" character varying, "race_id" integer, "character_class_id" integer, "occupation" character varying, "age" integer, "alignment_id" integer, "personality_traits" text, "ideals" text, "bonds" text, "flaws" text, "voice_style" character varying, "speech_patterns" text, "motivations" jsonb, "secrets" jsonb, "relationships" jsonb, "status" character varying, "backstory" text, "ai_personality_profile" jsonb, "conversation_memory" jsonb, "importance_level" character varying, "deleted_at" timestamp(6), "faction_id" integer, "location_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE INDEX "index_npcs_on_discarded_at" ON "npcs" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192251') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateNpcInteractions (20251119192252)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.0ms)[0m  [1m[35mCREATE TABLE "npc_interactions" ("id" bigserial primary key, "character_id" integer, "game_session_id" integer, "interaction_type" character varying, "summary" text, "player_action" text, "npc_response" text, "relationship_change" integer, "quest_log_id" integer, "metadata" jsonb, "occurred_at" timestamp(6), "deleted_at" timestamp(6), "npc_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_npc_interactions_on_discarded_at" ON "npc_interactions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192252') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateQuestLogs (20251119192253)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.8ms)[0m  [1m[35mCREATE TABLE "quest_logs" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "title" character varying, "description" text, "status" character varying, "quest_type" character varying, "difficulty" character varying, "experience_reward" integer, "started_at" timestamp(6), "completed_at" timestamp(6), "deleted_at" timestamp(6), "priority" integer DEFAULT 0, "gold_reward" integer DEFAULT 0, "item_rewards" jsonb DEFAULT '[]', "prerequisites" jsonb DEFAULT '{}', "quest_chain_id" integer, "parent_quest_id" integer, "location" character varying, "npc_ids" jsonb DEFAULT '[]', "assigned_to_party" boolean, "milestone_data" jsonb DEFAULT '{}', "template_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_quest_logs_on_discarded_at" ON "quest_logs" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192253') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateQuestObjectives (20251119192254)
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.1ms)[0m  [1m[35mCREATE TABLE "quest_objectives" ("id" bigserial primary key, "description" character varying, "order_index" integer, "completed" boolean, "optional" boolean, "progress_current" integer, "progress_target" integer, "deleted_at" timestamp(6), "quest_log_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_quest_objectives_on_discarded_at" ON "quest_objectives" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192254') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateQuestTemplates (20251119192255)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (5.7ms)[0m  [1m[35mCREATE TABLE "quest_templates" ("id" bigserial primary key, "name" character varying, "description" text, "quest_type" character varying, "difficulty" character varying, "objectives" jsonb, "rewards" jsonb, "prerequisites" jsonb, "icon" character varying, "color" character varying, "category" character varying, "estimated_duration_minutes" integer, "min_party_level" integer, "max_party_level" integer, "location_tags" jsonb, "npc_tags" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192255') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSpells (20251119192256)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.1ms)[0m  [1m[35mCREATE TABLE "spells" ("id" bigserial primary key, "name" character varying, "level" integer, "school" character varying, "casting_time" character varying, "range" character varying, "components" jsonb, "duration" character varying, "concentration" boolean, "ritual" boolean, "description" text, "higher_levels" text, "classes" jsonb, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_spells_on_discarded_at" ON "spells" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192256') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateSpellFilterPresets (20251119192257)
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.5ms)[0m  [1m[35mCREATE TABLE "spell_filter_presets" ("id" bigserial primary key, "user_id" integer, "name" character varying NOT NULL, "description" text, "filter_data" jsonb DEFAULT '{}' NOT NULL, "is_default" boolean NOT NULL, "is_public" boolean NOT NULL, "preset_type" character varying DEFAULT 'custom' NOT NULL, "usage_count" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251119192257') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.4ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 21:16:24 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActiveRecord::StatementInvalid (PG::UndefinedTable: ERROR:  relation "flipper_features" does not exist
LINE 1: ...lipper_gates"."key", "flipper_gates"."value" FROM "flipper_f...
                                                             ^
):
  
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateFlipperTables (20251120051702)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.0ms)[0m  [1m[35mCREATE TABLE "flipper_features" ("id" bigserial primary key, "key" character varying NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_flipper_features_on_key" ON "flipper_features" ("key")[0m
  [1m[35m (3.5ms)[0m  [1m[35mCREATE TABLE "flipper_gates" ("id" bigserial primary key, "feature_key" character varying NOT NULL, "key" character varying NOT NULL, "value" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_flipper_gates_on_feature_key_and_key_and_value" ON "flipper_gates" ("feature_key", "key", "value")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120051702') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.6ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-19 21:17:08 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
NameError (uninitialized constant ApplicationController):
  
app/controllers/application_controller.rb:3:in '<main>'
app/controllers/terminal_controller.rb:4:in '<main>'
Started GET "/" for ::1 at 2025-11-19 21:17:26 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
Completed 500 Internal Server Error in 46ms (ActiveRecord: 12.9ms | Allocations: 32850)


  
ActiveModel::UnknownAttributeError (unknown attribute 'password' for User.):
  
app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
app/controllers/terminal_controller.rb:137:in 'TerminalController#guest_user'
app/controllers/terminal_controller.rb:106:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 21:17:53 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
Completed 500 Internal Server Error in 5ms (ActiveRecord: 0.0ms | Allocations: 5584)


  
NoMethodError (undefined method 'devise' for class User):
  
app/models/user.rb:5:in '<class:User>'
app/models/user.rb:3:in '<main>'
app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
app/controllers/terminal_controller.rb:137:in 'TerminalController#guest_user'
app/controllers/terminal_controller.rb:106:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 21:18:22 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
Completed 500 Internal Server Error in 290ms (ActiveRecord: 14.8ms | Allocations: 35859)


  
NoMethodError (undefined method 'encrypted_password=' for an instance of User):
  
app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
app/controllers/terminal_controller.rb:137:in 'TerminalController#guest_user'
app/controllers/terminal_controller.rb:106:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddDeviseColumnsToUsers (20251120051800)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.6ms)[0m  [1m[35mALTER TABLE "users" ADD "encrypted_password" character varying DEFAULT '' NOT NULL[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "users" ADD "reset_password_token" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "reset_password_sent_at" timestamp(6)[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "remember_created_at" timestamp(6)[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "users" ADD "sign_in_count" integer DEFAULT 0 NOT NULL[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "current_sign_in_at" timestamp(6)[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "last_sign_in_at" timestamp(6)[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "current_sign_in_ip" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "last_sign_in_ip" character varying[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "guest" boolean DEFAULT FALSE[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "display_name" character varying[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_id" character varying[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_username" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_discriminator" character varying[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_avatar" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_access_token" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_refresh_token" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "users" ADD "discord_token_expires_at" timestamp(6)[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "users" ADD "ai_tokens_used" integer DEFAULT 0[0m
  [1m[35m (1.0ms)[0m  [1m[35mALTER TABLE "users" ADD "ai_tokens_limit" integer DEFAULT 100000[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "users" ADD "ai_tokens_reset_at" timestamp(6)[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_email" ON "users" ("email")[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_reset_password_token" ON "users" ("reset_password_token")[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_discord_id" ON "users" ("discord_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120051800') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-19 21:19:32 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_ac523a73a4851960@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_ac523a73a4851960@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.6ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_ac523a73a4851960@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", nil], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 05:19:32.741896"], ["updated_at", "2025-11-20 05:19:32.741896"], ["encrypted_password", "$2a$12$9AwsGbxC9hFPpOS/Sbm2.Oh45Q0xFfZYAk4oBKOVWBFPLrj1/zc/y"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
Completed 500 Internal Server Error in 279ms (ActiveRecord: 13.0ms | Allocations: 44863)


  
ActiveRecord::NotNullViolation (PG::NotNullViolation: ERROR:  null value in column "password_digest" of relation "users" violates not-null constraint
DETAIL:  Failing row contains (1, guest_ac523a73a4851960@terminal-dnd.local, null, user, null, null, null, null, null, null, null, null, null, null, 2025-11-20 05:19:32.741896, 2025-11-20 05:19:32.741896, $2a$12$9AwsGbxC9hFPpOS/Sbm2.Oh45Q0xFfZYAk4oBKOVWBFPLrj1/zc/y, null, null, null, 0, null, null, null, null, t, null, null, null, null, null, null, null, null, 0, 100000, null).
):
  
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (2.9ms)[0m  [1m[35mALTER TABLE users ALTER COLUMN password_digest DROP NOT NULL[0m
Started GET "/" for ::1 at 2025-11-19 21:19:50 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.6ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_7291d773639363eb@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_7291d773639363eb@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.4ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_7291d773639363eb@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", nil], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 05:19:50.751356"], ["updated_at", "2025-11-20 05:19:50.751356"], ["encrypted_password", "$2a$12$A.yUi3qW9BMZzJ4vikdM6uNBQCDmDGqL2XMCUvjWegPDYMvoAFTXi"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
Completed 500 Internal Server Error in 257ms (ActiveRecord: 6.1ms | Allocations: 13777)


  
ActiveRecord::StatementInvalid (PG::UndefinedTable: ERROR:  relation "versions" does not exist
LINE 10:  WHERE a.attrelid = '"versions"'::regclass
                             ^
):
  
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateVersions (20251120052001)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (7.7ms)[0m  [1m[35mCREATE TABLE "versions" ("id" bigserial primary key, "whodunnit" character varying, "created_at" timestamp(6), "item_id" bigint NOT NULL, "item_type" character varying NOT NULL, "event" character varying NOT NULL, "object" text)[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE INDEX "index_versions_on_item_type_and_item_id" ON "versions" ("item_type", "item_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120052001') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.4ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-19 21:20:08 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_2fcccffa455969f4@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_2fcccffa455969f4@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.1ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_2fcccffa455969f4@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", nil], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 05:20:08.652856"], ["updated_at", "2025-11-20 05:20:08.652856"], ["encrypted_password", "$2a$12$LUIpcJQvtrneqUs69dCUweX/Z.rTGReiLy24Bs.otqN9jCgs/4lr6"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (2.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 05:20:08.652856"], ["item_id", 3], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
Completed 500 Internal Server Error in 287ms (ActiveRecord: 16.8ms | Allocations: 45589)


  
ActiveRecord::StatementInvalid (PG::UndefinedTable: ERROR:  relation "terminal_sessions" does not exist
LINE 10:  WHERE a.attrelid = '"terminal_sessions"'::regclass
                             ^
):
  
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateTerminalSessions (20251120052100)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (12.2ms)[0m  [1m[35mCREATE TABLE "terminal_sessions" ("id" bigserial primary key, "user_id" bigint NOT NULL, "title" character varying, "mode" character varying DEFAULT 'exploration', "active" boolean DEFAULT TRUE, "character_id" bigint, "dungeon_map_id" bigint, "solo_session_id" bigint, "map_render_mode" character varying DEFAULT 'ascii', "show_map_panel" boolean DEFAULT TRUE, "command_history" jsonb DEFAULT '[]', "settings" jsonb DEFAULT '{}', "discord_channel_id" character varying, "discord_guild_id" character varying, "discord_thread_id" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_022a51465b"
FOREIGN KEY ("user_id")
  REFERENCES "users" ("id")
, CONSTRAINT "fk_rails_c17cc44297"
FOREIGN KEY ("character_id")
  REFERENCES "characters" ("id")
, CONSTRAINT "fk_rails_04b7a837a0"
FOREIGN KEY ("dungeon_map_id")
  REFERENCES "maps" ("id")
, CONSTRAINT "fk_rails_ec8e38d3cd"
FOREIGN KEY ("solo_session_id")
  REFERENCES "solo_sessions" ("id")
)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_user_id" ON "terminal_sessions" ("user_id")[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_character_id" ON "terminal_sessions" ("character_id")[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_dungeon_map_id" ON "terminal_sessions" ("dungeon_map_id")[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_solo_session_id" ON "terminal_sessions" ("solo_session_id")[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_discord_channel_id" ON "terminal_sessions" ("discord_channel_id")[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_active" ON "terminal_sessions" ("active")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120052100') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.7ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-19 21:21:37 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (5.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_940d5afe6aabda2b@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_940d5afe6aabda2b@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:151:in 'TerminalController#create_guest_user'
Completed 500 Internal Server Error in 287ms (ActiveRecord: 18.1ms | Allocations: 47521)


  
NoMethodError (undefined method 'session_token' for an instance of TerminalSession):
  
app/models/terminal_session.rb:99:in 'TerminalSession#generate_session_token'
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Started GET "/" for ::1 at 2025-11-19 21:21:42 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_8d901aadbe868767@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_8d901aadbe868767@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:151:in 'TerminalController#create_guest_user'
Completed 500 Internal Server Error in 281ms (ActiveRecord: 3.3ms | Allocations: 8596)


  
NoMethodError (undefined method 'session_token' for an instance of TerminalSession):
  
app/models/terminal_session.rb:99:in 'TerminalSession#generate_session_token'
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.5ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddSessionTokenToTerminalSessions (20251120052151)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.6ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "session_token" character varying[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120052151') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-19 21:21:56 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_bffbfeee71250476@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_bffbfeee71250476@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:151:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.6ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "8cdfadba5d8f3e14f319a5f776fcec3b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Completed 422 Unprocessable Content in 305ms (ActiveRecord: 21.1ms | Allocations: 48427)


  
ActiveRecord::RecordInvalid (Validation failed: User must exist):
  
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/up" for ::1 at 2025-11-19 21:22:14 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by Rails::HealthController#show as */*
  Rendering html template
  Rendered html template (Duration: 0.0ms | Allocations: 32)
Completed 200 OK in 1ms (Views: 1.2ms | ActiveRecord: 0.0ms | Allocations: 831)


Started GET "/terminal/new" for ::1 at 2025-11-19 21:23:29 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#new as HTML
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_469f8659ac128707@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_469f8659ac128707@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:151:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "f6b8b6087afd956293be9c2ea420e1d5"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Completed 422 Unprocessable Content in 252ms (ActiveRecord: 4.5ms | Allocations: 11332)


  
ActiveRecord::RecordInvalid (Validation failed: User must exist):
  
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Started GET "/" for ::1 at 2025-11-19 21:23:44 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_377fd982de3f2ede@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_377fd982de3f2ede@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:142:in 'TerminalController#create_guest_user'
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:151:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "903c85f1f03659e3ee3b18928a561c0d"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Completed 422 Unprocessable Content in 250ms (ActiveRecord: 5.1ms | Allocations: 11328)


  
ActiveRecord::RecordInvalid (Validation failed: User must exist):
  
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[35m (0.2ms)[0m  [1m[35mDROP DATABASE IF EXISTS "terminal_dnd_test"[0m
  [1m[35m (79.0ms)[0m  [1m[35mCREATE DATABASE "terminal_dnd_test" ENCODING = 'unicode'[0m
  [1m[35mSQL (0.3ms)[0m  [1m[35mCREATE EXTENSION IF NOT EXISTS "plpgsql"[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "action_logs" CASCADE[0m
  [1m[35m (2.9ms)[0m  [1m[35mCREATE TABLE "action_logs" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "action_type" character varying NOT NULL, "description" text, "metadata" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "active_effects" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "active_effects" ("id" bigserial primary key, "combatant_id" integer NOT NULL, "effect_type" character varying NOT NULL, "name" character varying, "description" text, "value" integer, "duration_rounds" integer, "save_dc" integer, "trigger" character varying, "metadata" jsonb DEFAULT '{}', "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_active_effects_on_discarded_at" ON "active_effects" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "adventure_templates" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "adventure_templates" ("id" bigserial primary key, "title" character varying NOT NULL, "description" text, "difficulty" character varying DEFAULT 'medium', "estimated_duration" integer, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "category" character varying, "status" character varying DEFAULT 'draft', "template_data" jsonb DEFAULT '{}', "creator_id" integer, "completion_count" integer DEFAULT 0, "usage_count" integer DEFAULT 0, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_adventure_templates_on_discarded_at" ON "adventure_templates" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_contexts" CASCADE[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE TABLE "ai_contexts" ("id" bigserial primary key, "character_id" integer NOT NULL, "solo_session_id" integer, "long_term_memory" jsonb DEFAULT '{}' NOT NULL, "character_traits" jsonb DEFAULT '{}' NOT NULL, "world_state" jsonb DEFAULT '{}' NOT NULL, "relationship_web" jsonb DEFAULT '{}' NOT NULL, "active_quests" jsonb DEFAULT '[]' NOT NULL, "plot_threads" jsonb DEFAULT '[]' NOT NULL, "npcs_met" jsonb DEFAULT '[]' NOT NULL, "locations_visited" jsonb DEFAULT '[]' NOT NULL, "important_items" jsonb DEFAULT '[]' NOT NULL, "major_events" jsonb DEFAULT '[]' NOT NULL, "session_summaries" jsonb DEFAULT '[]' NOT NULL, "context_seed" text, "last_context_update" timestamp(6), "context_version" integer DEFAULT 1 NOT NULL, "estimated_token_count" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_conversations" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "ai_conversations" ("id" bigserial primary key, "solo_session_id" integer, "character_id" integer, "title" character varying, "status" character varying, "ai_model" character varying, "system_prompt" text, "context_data" jsonb, "message_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_ai_conversations_on_discarded_at" ON "ai_conversations" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_dm_assistants" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "ai_dm_assistants" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "enabled" boolean DEFAULT TRUE NOT NULL, "paused" boolean NOT NULL, "creativity_level" character varying DEFAULT 'balanced' NOT NULL, "tone" character varying DEFAULT 'heroic' NOT NULL, "setting_context" text, "suggestion_types" jsonb NOT NULL, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_ai_dm_assistants_on_discarded_at" ON "ai_dm_assistants" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_dm_contexts" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "ai_dm_contexts" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "game_session_id" integer NOT NULL, "conversation_history" jsonb DEFAULT '[]' NOT NULL, "active_npcs" jsonb DEFAULT '[]' NOT NULL, "recent_events" jsonb DEFAULT '[]' NOT NULL, "unresolved_threads" jsonb DEFAULT '[]' NOT NULL, "campaign_memory" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_dm_overrides" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "ai_dm_overrides" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "ai_dm_suggestion_id" integer NOT NULL, "user_id" integer NOT NULL, "original_suggestion" text NOT NULL, "dm_override" text NOT NULL, "override_type" character varying NOT NULL, "context_when_overridden" jsonb DEFAULT '{}' NOT NULL, "reasoning" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_dm_suggestions" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "ai_dm_suggestions" ("id" bigserial primary key, "ai_dm_assistant_id" integer NOT NULL, "game_session_id" integer, "user_id" integer NOT NULL, "suggestion_type" character varying NOT NULL, "content" text NOT NULL, "edited_content" text, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_ai_dm_suggestions_on_discarded_at" ON "ai_dm_suggestions" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "ai_messages" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "ai_messages" ("id" bigserial primary key, "role" character varying, "content" text, "dice_rolls" jsonb, "narrative_tags" jsonb, "tokens_used" integer, "response_time_ms" integer, "deleted_at" timestamp(6), "ai_conversation_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_ai_messages_on_discarded_at" ON "ai_messages" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "alignments" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "alignments" ("id" bigserial primary key, "name" character varying, "code" character varying, "axis_law_chaos" character varying, "axis_good_evil" character varying, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_alignments_on_discarded_at" ON "alignments" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "backgrounds" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "backgrounds" ("id" bigserial primary key, "name" character varying, "skill_proficiencies" jsonb, "tool_proficiencies" jsonb, "languages" jsonb, "starting_equipment" jsonb, "feature_name" character varying, "feature_description" text, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_backgrounds_on_discarded_at" ON "backgrounds" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_join_requests" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "campaign_join_requests" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_campaign_join_requests_on_discarded_at" ON "campaign_join_requests" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_memberships" CASCADE[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE TABLE "campaign_memberships" ("id" bigserial primary key, "role" character varying, "active" boolean, "user_id" integer, "campaign_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_campaign_memberships_on_discarded_at" ON "campaign_memberships" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_metrics" CASCADE[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE TABLE "campaign_metrics" ("id" bigserial primary key, "campaign_id" integer, "metric_date" date, "sessions_count" integer, "total_playtime_minutes" integer, "encounters_count" integer, "combats_count" integer, "npcs_met_count" integer, "quests_started" integer, "quests_completed" integer, "locations_visited" integer, "player_deaths" integer, "monsters_defeated" integer, "treasure_gained_gp" decimal, "experience_gained" integer, "engagement_scores" jsonb, "pacing_analysis" jsonb, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_campaign_metrics_on_discarded_at" ON "campaign_metrics" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_notes" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "campaign_notes" ("id" bigserial primary key, "title" character varying, "content" text, "note_type" character varying, "visibility" character varying, "campaign_id" integer, "user_id" integer, "game_session_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_campaign_notes_on_discarded_at" ON "campaign_notes" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_ratings" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "campaign_ratings" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_campaign_ratings_on_discarded_at" ON "campaign_ratings" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaign_templates" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "campaign_templates" ("id" bigserial primary key, "user_id" integer NOT NULL, "name" character varying NOT NULL, "description" text, "category" character varying, "tags" jsonb DEFAULT '[]', "template_data" jsonb DEFAULT '{}' NOT NULL, "visibility" character varying DEFAULT 'public' NOT NULL, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "use_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_campaign_templates_on_discarded_at" ON "campaign_templates" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "campaigns" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "campaigns" ("id" bigserial primary key, "name" character varying, "description" text, "status" character varying, "visibility" character varying DEFAULT 'private', "dm_id" integer, "theme" character varying, "world_time" character varying, "current_location" character varying, "settings" jsonb, "house_rules" jsonb, "max_players" integer, "timezone" character varying, "session_frequency" character varying, "ai_assistant_enabled" boolean, "deleted_at" timestamp(6), "world_id" integer, "min_level" integer DEFAULT 1, "max_level" integer DEFAULT 20, "category" character varying, "tags" jsonb DEFAULT '[]', "discarded_at" timestamp(6), "template_id" integer, "looking_for_players" boolean, "player_capacity" integer, "play_style" character varying, "next_session_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_campaigns_on_discarded_at" ON "campaigns" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_ai_assistants" CASCADE[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "character_ai_assistants" ("id" bigserial primary key, "character_id" integer NOT NULL, "conversation_history" jsonb DEFAULT '[]', "generated_content" jsonb DEFAULT '{}', "tactical_suggestions" jsonb DEFAULT '[]', "roleplay_prompts" jsonb DEFAULT '[]', "personality_analysis" jsonb DEFAULT '{}', "preferred_ai_model" character varying, "ai_usage_tokens" integer DEFAULT 0, "ai_enabled" boolean DEFAULT TRUE, "custom_instructions" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_classes" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "character_classes" ("id" bigserial primary key, "name" character varying, "hit_die" integer, "primary_ability" character varying, "saving_throw_proficiencies" jsonb, "skill_proficiencies" jsonb, "armor_proficiencies" jsonb, "weapon_proficiencies" jsonb, "starting_equipment" jsonb, "class_features" jsonb, "spellcasting_ability" character varying, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_character_classes_on_discarded_at" ON "character_classes" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_combat_trackers" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "character_combat_trackers" ("id" bigserial primary key, "character_id" integer NOT NULL, "action_resources" jsonb DEFAULT '{}', "death_saves" jsonb, "conditions" jsonb DEFAULT '[]', "resistances" jsonb DEFAULT '[]', "immunities" jsonb DEFAULT '[]', "vulnerabilities" jsonb DEFAULT '[]', "temp_hp" integer DEFAULT 0, "exhaustion_level" integer DEFAULT 0, "initiative_roll" integer, "has_reaction" boolean DEFAULT TRUE, "has_bonus_action" boolean DEFAULT TRUE, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_feats" CASCADE[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE TABLE "character_feats" ("id" bigserial primary key, "character_id" integer NOT NULL, "feat_id" integer NOT NULL, "level_gained" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_inventories" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "character_inventories" ("id" bigserial primary key, "character_id" integer NOT NULL, "equipped_items" jsonb DEFAULT '{}', "inventory_grid" jsonb DEFAULT '[]', "carry_capacity" integer DEFAULT 150, "current_weight" integer DEFAULT 0, "equipment_sets" jsonb DEFAULT '{}', "active_set" character varying, "currency" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_discarded_at" ON "character_inventories" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_items" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "character_items" ("id" bigserial primary key, "quantity" integer, "equipped" boolean, "attuned" boolean, "identified" boolean, "notes" text, "character_id" integer, "item_id" integer, "discarded_at" timestamp(6), "lock_version" integer DEFAULT 0 NOT NULL, "equipment_slot" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_character_items_on_discarded_at" ON "character_items" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_notes" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "character_notes" ("id" bigserial primary key, "title" character varying, "content" text, "note_type" character varying, "character_id" integer, "discarded_at" timestamp(6), "note_category" character varying DEFAULT 'quick_note', "tags" jsonb DEFAULT '[]', "session_number" integer, "session_date" date, "priority" character varying DEFAULT 'medium', "completed" boolean, "completed_at" timestamp(6), "npc_name" character varying, "relationship_status" character varying, "faction_affiliation" character varying, "last_interaction_date" date, "metadata" jsonb DEFAULT '{}', "pinned" boolean, "character_limit" integer DEFAULT 5000, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_character_notes_on_discarded_at" ON "character_notes" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_progressions" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "character_progressions" ("id" bigserial primary key, "character_id" integer NOT NULL, "level_history" jsonb DEFAULT '[]', "multiclass_levels" jsonb DEFAULT '{}', "feat_choices" jsonb DEFAULT '[]', "asi_choices" jsonb DEFAULT '[]', "subclass_features" jsonb DEFAULT '{}', "milestone_tracker" jsonb DEFAULT '[]', "next_level_xp" integer, "progression_type" character varying, "planned_levels" jsonb DEFAULT '[]', "xp_history" jsonb DEFAULT '[]' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_relationships" CASCADE[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "character_relationships" ("id" bigserial primary key, "character_id" integer NOT NULL, "related_character_id" integer, "relationship_type" character varying, "bond_strength" integer DEFAULT 50, "shared_history" jsonb DEFAULT '[]', "relationship_modifiers" jsonb DEFAULT '{}', "notes" text, "is_npc" boolean, "npc_name" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_spell_managers" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "character_spell_managers" ("id" bigserial primary key, "character_id" integer NOT NULL, "spell_slots" jsonb DEFAULT '{}', "prepared_spells" jsonb DEFAULT '[]', "known_spells" jsonb DEFAULT '[]', "ritual_spells" jsonb DEFAULT '[]', "spell_book" jsonb DEFAULT '[]', "spellcasting_ability" character varying, "spell_save_dc" integer, "spell_attack_bonus" integer, "cantrips_known" integer DEFAULT 0, "concentration" jsonb DEFAULT '{}', "lock_version" integer DEFAULT 0 NOT NULL, "sorcery_points_max" integer DEFAULT 0, "sorcery_points_current" integer DEFAULT 0, "known_metamagics" jsonb DEFAULT '[]', "metamagic_options" jsonb DEFAULT '{}', "wild_magic_surge_count" integer DEFAULT 0, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_spells" CASCADE[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE TABLE "character_spells" ("id" bigserial primary key, "known" boolean, "prepared" boolean, "always_prepared" boolean, "character_id" integer, "spell_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_character_spells_on_discarded_at" ON "character_spells" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "character_templates" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "character_templates" ("id" bigserial primary key, "name" character varying NOT NULL, "template_type" character varying, "description" text, "template_data" jsonb DEFAULT '{}', "user_id" integer, "is_public" boolean, "usage_count" integer DEFAULT 0, "rating_sum" integer DEFAULT 0, "rating_count" integer DEFAULT 0, "tags" jsonb DEFAULT '[]', "compatible_classes" jsonb DEFAULT '[]', "min_level" integer, "max_level" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "characters" CASCADE[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE TABLE "characters" ("id" bigserial primary key, "name" character varying, "level" integer, "experience" integer, "proficiency_bonus" integer, "strength" integer, "dexterity" integer, "constitution" integer, "intelligence" integer, "wisdom" integer, "charisma" integer, "hit_points_current" integer, "hit_points_max" integer, "temporary_hit_points" integer, "armor_class" integer, "initiative_bonus" integer, "speed" integer, "alignment" character varying, "personality_traits" text, "ideals" text, "bonds" text, "flaws" text, "backstory" text, "skills" jsonb, "proficiencies" jsonb, "conditions" jsonb, "avatar_url" character varying, "visibility" character varying, "deleted_at" timestamp(6), "user_id" integer, "campaign_id" integer, "race_id" integer, "character_class_id" integer, "background_id" integer, "character_voice" text, "ai_personality_profile" jsonb DEFAULT '{}', "catchphrases" jsonb DEFAULT '[]', "homebrew_modifications" jsonb DEFAULT '{}', "custom_features" jsonb DEFAULT '[]', "house_rules" jsonb DEFAULT '{}', "quick_actions" jsonb DEFAULT '[]', "favorite_spells" jsonb DEFAULT '[]', "combat_tactics" jsonb DEFAULT '[]', "theme_preferences" jsonb DEFAULT '{}', "portrait_url" character varying, "token_url" character varying, "last_session_notes" text, "session_count" integer DEFAULT 0, "total_playtime_hours" decimal DEFAULT 0.0, "faction_affiliations" jsonb DEFAULT '{}' NOT NULL, "faction_reputations" jsonb DEFAULT '{}' NOT NULL, "current_hp" integer, "max_hp" integer, "temporary_hp" integer DEFAULT 0 NOT NULL, "death_save_successes" integer DEFAULT 0 NOT NULL, "death_save_failures" integer DEFAULT 0 NOT NULL, "spell_slots" jsonb DEFAULT '{}' NOT NULL, "concentration_spell_id" integer, "damage_resistances" jsonb DEFAULT '[]' NOT NULL, "damage_immunities" jsonb DEFAULT '[]' NOT NULL, "damage_vulnerabilities" jsonb DEFAULT '[]' NOT NULL, "active_effects" jsonb DEFAULT '[]', "resistances" jsonb DEFAULT '[]', "immunities" jsonb DEFAULT '[]', "vulnerabilities" jsonb DEFAULT '[]', "hit_dice_used" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_characters_on_discarded_at" ON "characters" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "chat_messages" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "chat_messages" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "content" text NOT NULL, "message_type" character varying DEFAULT 'public', "recipient_id" integer, "character_id" integer, "private" boolean, "edited" boolean, "deleted" boolean, "deleted_by" character varying, "original_content" text, "dice_results" jsonb DEFAULT '[]', "mentions" jsonb DEFAULT '[]', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_chat_messages_on_discarded_at" ON "chat_messages" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "combat_actions" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "combat_actions" ("id" bigserial primary key, "round_number" integer, "action_type" character varying, "target_participant_id" integer, "description" text, "attack_roll" integer, "damage_roll" integer, "damage_type" character varying, "healing_amount" integer, "spell_id" integer, "item_id" integer, "success" boolean, "critical_hit" boolean, "critical_fail" boolean, "deleted_at" timestamp(6), "combat_id" integer, "combat_participant_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_combat_actions_on_discarded_at" ON "combat_actions" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "combat_encounters" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "combat_encounters" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "game_session_id" integer, "status" character varying DEFAULT 'preparing' NOT NULL, "current_round" integer DEFAULT 0, "current_turn" integer DEFAULT 0, "current_turn_combatant_id" integer, "paused" boolean, "turn_timer_seconds" integer, "turn_started_at" timestamp(6), "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_combat_encounters_on_discarded_at" ON "combat_encounters" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "combat_participants" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "combat_participants" ("id" bigserial primary key, "character_id" integer, "initiative" integer, "initiative_modifier" integer, "current_hit_points" integer, "max_hit_points" integer, "temporary_hit_points" integer, "armor_class" integer, "conditions" jsonb, "concentrating_on" character varying, "is_active" boolean, "defeated" boolean, "deleted_at" timestamp(6), "combat_id" integer, "encounter_monster_id" integer, "death_save_successes" integer DEFAULT 0 NOT NULL, "death_save_failures" integer DEFAULT 0 NOT NULL, "actions_used" integer DEFAULT 0 NOT NULL, "bonus_actions_used" integer DEFAULT 0 NOT NULL, "reactions_used" integer DEFAULT 0 NOT NULL, "name" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_combat_participants_on_discarded_at" ON "combat_participants" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "combatants" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "combatants" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "character_id" integer, "name" character varying, "combatant_type" character varying DEFAULT 'pc' NOT NULL, "initiative" integer, "dexterity" integer, "status" character varying DEFAULT 'conscious', "death_save_successes" integer DEFAULT 0, "death_save_failures" integer DEFAULT 0, "challenge_rating" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_combatants_on_discarded_at" ON "combatants" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "combats" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "combats" ("id" bigserial primary key, "game_session_id" integer, "status" character varying, "current_round" integer, "current_turn" integer, "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_combats_on_discarded_at" ON "combats" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "conditions" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "conditions" ("id" bigserial primary key, "name" character varying, "description" text, "effects" jsonb, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_conditions_on_discarded_at" ON "conditions" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "content_clones" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "content_clones" ("id" bigserial primary key, "shared_content_id" integer NOT NULL, "user_id" integer NOT NULL, "cloned_content_type" character varying NOT NULL, "cloned_content_id" integer NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_content_clones_on_discarded_at" ON "content_clones" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "content_libraries" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "content_libraries" ("id" bigserial primary key, "campaign_id" integer, "content_type" character varying, "title" character varying, "description" text, "content_data" jsonb, "tags" jsonb, "ai_generated" boolean, "ai_model" character varying, "generation_prompt" text, "is_public" boolean, "upvotes" integer, "downvotes" integer, "usage_count" integer, "quality_rating" decimal, "reviewed" boolean, "deleted_at" timestamp(6), "user_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_content_libraries_on_discarded_at" ON "content_libraries" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "content_ratings" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "content_ratings" ("id" bigserial primary key, "shared_content_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "helpful_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_content_ratings_on_discarded_at" ON "content_ratings" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "currents" CASCADE[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE TABLE "currents" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "damage_logs" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "damage_logs" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "source_type" character varying, "source_id" integer, "target_type" character varying, "target_id" integer, "amount" integer NOT NULL, "damage_type" character varying, "description" text, "round_number" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_damage_logs_on_discarded_at" ON "damage_logs" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "dice_rolls" CASCADE[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "dice_rolls" ("id" bigserial primary key, "character_id" integer, "game_session_id" integer, "roll_type" character varying, "dice_formula" character varying, "results" jsonb, "total" integer, "modifier" integer, "advantage" boolean, "disadvantage" boolean, "critical" boolean, "context" character varying, "deleted_at" timestamp(6), "user_id" integer, "combat_id" integer, "combat_action_id" integer, "hidden" boolean NOT NULL, "active" boolean DEFAULT TRUE NOT NULL, "ability" character varying, "metadata" text, "state" character varying DEFAULT 'rolled' NOT NULL, "locked" boolean NOT NULL, "original_roll_id" integer, "superseded_by_roll_id" integer, "reroll_reason" text, "dm_approved_by" integer, "dm_approved_at" timestamp(6), "reroll_requested_at" timestamp(6), "auto_confirmed" boolean NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_dice_rolls_on_discarded_at" ON "dice_rolls" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "dungeon_templates" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "dungeon_templates" ("id" bigserial primary key, "name" character varying, "description" text, "dungeon_type" character varying, "min_party_level" integer, "max_party_level" integer, "room_count_min" integer, "room_count_max" integer, "monster_density" character varying, "trap_density" character varying, "treasure_quality" character varying, "themes" jsonb, "special_features" jsonb, "created_by_user_id" integer, "is_public" boolean, "usage_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_dungeon_templates_on_discarded_at" ON "dungeon_templates" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "encounter_monsters" CASCADE[0m
  [1m[35m (5.5ms)[0m  [1m[35mCREATE TABLE "encounter_monsters" ("id" bigserial primary key, "quantity" integer, "current_hit_points" integer, "max_hit_points" integer, "initiative" integer, "conditions" jsonb, "notes" text, "defeated" boolean, "deleted_at" timestamp(6), "encounter_id" integer, "monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_encounter_monsters_on_discarded_at" ON "encounter_monsters" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "encounter_templates" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "encounter_templates" ("id" bigserial primary key, "name" character varying, "description" text, "min_party_level" integer, "max_party_level" integer, "monster_types" jsonb, "terrain_types" jsonb, "difficulty_modifier" decimal, "environmental_hazards" jsonb, "objectives" jsonb, "rewards" jsonb, "created_by_user_id" integer, "is_public" boolean, "usage_count" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_encounter_templates_on_discarded_at" ON "encounter_templates" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "encounters" CASCADE[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE TABLE "encounters" ("id" bigserial primary key, "campaign_id" integer, "game_session_id" integer, "name" character varying, "description" text, "difficulty" character varying, "status" character varying, "experience_awarded" integer, "treasure_awarded" text, "started_at" timestamp(6), "completed_at" timestamp(6), "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_encounters_on_discarded_at" ON "encounters" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "export_archives" CASCADE[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "export_archives" ("id" bigserial primary key, "campaign_id" integer NOT NULL, "user_id" integer NOT NULL, "archive_type" character varying NOT NULL, "status" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "faction_memberships" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "faction_memberships" ("id" bigserial primary key, "character_id" integer, "rank" character varying, "title" character varying, "reputation" integer, "joined_at" timestamp(6), "left_at" timestamp(6), "status" character varying, "contributions" jsonb, "deleted_at" timestamp(6), "faction_id" integer, "npc_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_faction_memberships_on_discarded_at" ON "faction_memberships" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "faction_relationships" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "faction_relationships" ("id" bigserial primary key, "related_faction_id" integer, "relationship_type" character varying, "relationship_strength" integer, "history" text, "treaties" jsonb, "conflicts" jsonb, "deleted_at" timestamp(6), "faction_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_faction_relationships_on_discarded_at" ON "faction_relationships" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "factions" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "factions" ("id" bigserial primary key, "campaign_id" integer, "world_id" integer, "name" character varying, "faction_type" character varying, "alignment_id" integer, "description" text, "goals" jsonb, "resources" jsonb, "territory" jsonb, "power_level" integer, "headquarters_location_id" integer, "leader_npc_id" integer, "symbols" text, "colors" character varying, "motto" character varying, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_factions_on_discarded_at" ON "factions" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "feats" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "feats" ("id" bigserial primary key, "name" character varying NOT NULL, "description" text, "prerequisites" text, "ability_score_increases" jsonb DEFAULT '{}', "benefits" jsonb DEFAULT '{}', "source" character varying DEFAULT 'SRD', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mDROP TABLE IF EXISTS "flipper_features" CASCADE[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "flipper_features" ("id" bigserial primary key, "key" character varying NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_flipper_features_on_key" ON "flipper_features" ("key")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "flipper_gates" CASCADE[0m
  [1m[35m (3.2ms)[0m  [1m[35mCREATE TABLE "flipper_gates" ("id" bigserial primary key, "feature_key" character varying NOT NULL, "key" character varying NOT NULL, "value" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_flipper_gates_on_feature_key_and_key_and_value" ON "flipper_gates" ("feature_key", "key", "value")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "friend_requests" CASCADE[0m
  [1m[35m (2.0ms)[0m  [1m[35mCREATE TABLE "friend_requests" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_friend_requests_on_discarded_at" ON "friend_requests" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "friendships" CASCADE[0m
  [1m[35m (2.6ms)[0m  [1m[35mCREATE TABLE "friendships" ("id" bigserial primary key, "user_id" integer NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_friendships_on_discarded_at" ON "friendships" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "game_session_participants" CASCADE[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE TABLE "game_session_participants" ("id" bigserial primary key, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_game_session_participants_on_discarded_at" ON "game_session_participants" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "game_sessions" CASCADE[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE TABLE "game_sessions" ("id" bigserial primary key, "title" character varying, "session_number" integer, "scheduled_at" timestamp(6), "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_game_sessions_on_discarded_at" ON "game_sessions" ("discarded_at")[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "generated_dungeons" CASCADE[0m
  [1m[35m (3.5ms)[0m  [1m[35mCREATE TABLE "generated_dungeons" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "party_level" integer, "room_count" integer, "layout_data" jsonb, "room_descriptions" jsonb, "monster_placements" jsonb, "trap_locations" jsonb, "treasure_locations" jsonb, "secret_areas" jsonb, "boss_room_id" character varying, "entrance_room_id" character varying, "narrative_theme" text, "difficulty_rating" character varying, "generated_at" timestamp(6), "explored_rooms" jsonb, "deleted_at" timestamp(6), "dungeon_template_id" integer, "location_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_generated_dungeons_on_discarded_at" ON "generated_dungeons" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "generated_encounters" CASCADE[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "generated_encounters" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "party_level" integer, "party_size" integer, "difficulty_rating" character varying, "total_xp" integer, "monsters_data" jsonb, "terrain_features" jsonb, "treasure" jsonb, "narrative_hook" text, "tactics" text, "generated_at" timestamp(6), "used_in_encounter_id" integer, "deleted_at" timestamp(6), "encounter_template_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_generated_encounters_on_discarded_at" ON "generated_encounters" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "generated_treasures" CASCADE[0m
  [1m[35m (3.3ms)[0m  [1m[35mCREATE TABLE "generated_treasures" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "loot_table_id" integer NOT NULL, "treasure_data" jsonb DEFAULT '{}', "generated_at" timestamp(6), "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_generated_treasures_on_discarded_at" ON "generated_treasures" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "healing_logs" CASCADE[0m
  [1m[35m (4.6ms)[0m  [1m[35mCREATE TABLE "healing_logs" ("id" bigserial primary key, "combat_encounter_id" integer NOT NULL, "source_type" character varying, "source_id" integer, "target_type" character varying, "target_id" integer, "amount" integer NOT NULL, "description" text, "round_number" integer, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (2.3ms)[0m  [1m[35mCREATE INDEX "index_healing_logs_on_discarded_at" ON "healing_logs" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "homebrew_items" CASCADE[0m
  [1m[35m (2.9ms)[0m  [1m[35mCREATE TABLE "homebrew_items" ("id" bigserial primary key, "campaign_id" integer, "homebrew_type" character varying, "name" character varying, "description" text, "stat_block" jsonb, "source_reference" character varying, "balance_rating" integer, "published" boolean, "upvotes" integer, "deleted_at" timestamp(6), "user_id" integer, "content" jsonb, "visibility" character varying DEFAULT 'private', "version" integer DEFAULT 1, "tags" character varying, "balance_notes" text, "active" boolean DEFAULT TRUE, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_homebrew_items_on_discarded_at" ON "homebrew_items" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "idempotent_requests" CASCADE[0m
  [1m[35m (2.9ms)[0m  [1m[35mCREATE TABLE "idempotent_requests" ("id" bigserial primary key, "idempotency_key" character varying NOT NULL, "character_id" integer NOT NULL, "action_type" character varying NOT NULL, "response_data" jsonb, "status_code" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "items" CASCADE[0m
  [1m[35m (2.7ms)[0m  [1m[35mCREATE TABLE "items" ("id" bigserial primary key, "name" character varying, "item_type" character varying, "rarity" character varying, "description" text, "properties" jsonb, "weight" decimal, "cost_gp" decimal, "magic" boolean, "requires_attunement" boolean, "discarded_at" timestamp(6), "source" character varying, "armor_class" integer, "armor_type" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_items_on_discarded_at" ON "items" ("discarded_at")[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "languages" CASCADE[0m
  [1m[35m (3.3ms)[0m  [1m[35mCREATE TABLE "languages" ("id" bigserial primary key, "name" character varying, "script" character varying, "typical_speakers" text, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_languages_on_discarded_at" ON "languages" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "locations" CASCADE[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "locations" ("id" bigserial primary key, "world_id" integer, "parent_location_id" integer, "name" character varying, "location_type" character varying, "description" text, "population" integer, "government_type" character varying, "notable_features" jsonb, "shops" jsonb, "taverns" jsonb, "points_of_interest" jsonb, "climate" character varying, "terrain" character varying, "coordinates_x" integer, "coordinates_y" integer, "danger_level" integer, "visited" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE INDEX "index_locations_on_discarded_at" ON "locations" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "loot_table_entries" CASCADE[0m
  [1m[35m (5.9ms)[0m  [1m[35mCREATE TABLE "loot_table_entries" ("id" bigserial primary key, "loot_table_id" integer NOT NULL, "treasure_type" character varying NOT NULL, "quantity_dice" character varying, "weight" integer DEFAULT 1, "item_id" integer, "treasure_data" jsonb DEFAULT '{}', "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_loot_table_entries_on_discarded_at" ON "loot_table_entries" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "loot_tables" CASCADE[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "loot_tables" ("id" bigserial primary key, "name" character varying NOT NULL, "description" text, "table_type" character varying, "challenge_rating_min" decimal, "challenge_rating_max" decimal, "source" character varying, "user_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE INDEX "index_loot_tables_on_discarded_at" ON "loot_tables" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "maps" CASCADE[0m
  [1m[35m (5.6ms)[0m  [1m[35mCREATE TABLE "maps" ("id" bigserial primary key, "campaign_id" integer, "name" character varying, "description" text, "grid_width" integer, "grid_height" integer, "grid_size" integer, "background_color" character varying, "terrain_data" jsonb, "fog_of_war_enabled" boolean, "fog_of_war_data" jsonb, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_maps_on_discarded_at" ON "maps" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "message_reactions" CASCADE[0m
  [1m[35m (2.9ms)[0m  [1m[35mCREATE TABLE "message_reactions" ("id" bigserial primary key, "chat_message_id" integer NOT NULL, "user_id" integer NOT NULL, "emoji" character varying NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "monster_abilities" CASCADE[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "monster_abilities" ("id" bigserial primary key, "name" character varying, "ability_type" character varying, "description" text, "attack_bonus" integer, "damage_dice" character varying, "damage_type" character varying, "save_dc" integer, "save_ability" character varying, "recharge" character varying, "deleted_at" timestamp(6), "monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_monster_abilities_on_discarded_at" ON "monster_abilities" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "monsters" CASCADE[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE TABLE "monsters" ("id" bigserial primary key, "name" character varying, "size" character varying, "creature_type" character varying, "alignment_id" integer, "armor_class" integer, "hit_points" integer, "hit_dice" character varying, "speed" character varying, "strength" integer, "dexterity" integer, "constitution" integer, "intelligence" integer, "wisdom" integer, "charisma" integer, "challenge_rating" decimal, "experience_points" integer, "skills" jsonb, "damage_vulnerabilities" text, "damage_resistances" text, "damage_immunities" text, "condition_immunities" text, "senses" text, "languages" text, "description" text, "source" character varying, "deleted_at" timestamp(6), "saving_throws" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_monsters_on_discarded_at" ON "monsters" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "notifications" CASCADE[0m
  [1m[35m (3.3ms)[0m  [1m[35mCREATE TABLE "notifications" ("id" bigserial primary key, "user_id" integer NOT NULL, "notifiable_type" character varying, "notifiable_id" integer, "notification_type" character varying NOT NULL, "title" character varying NOT NULL, "message" text NOT NULL, "priority" character varying DEFAULT 'medium' NOT NULL, "metadata" jsonb DEFAULT '{}', "read_at" timestamp(6), "action_url" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "npc_interactions" CASCADE[0m
  [1m[35m (4.1ms)[0m  [1m[35mCREATE TABLE "npc_interactions" ("id" bigserial primary key, "character_id" integer, "game_session_id" integer, "interaction_type" character varying, "summary" text, "player_action" text, "npc_response" text, "relationship_change" integer, "quest_log_id" integer, "metadata" jsonb, "occurred_at" timestamp(6), "deleted_at" timestamp(6), "npc_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE INDEX "index_npc_interactions_on_discarded_at" ON "npc_interactions" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "npcs" CASCADE[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "npcs" ("id" bigserial primary key, "campaign_id" integer, "world_id" integer, "name" character varying, "race_id" integer, "character_class_id" integer, "occupation" character varying, "age" integer, "alignment_id" integer, "personality_traits" text, "ideals" text, "bonds" text, "flaws" text, "voice_style" character varying, "speech_patterns" text, "motivations" jsonb, "secrets" jsonb, "relationships" jsonb, "status" character varying, "backstory" text, "ai_personality_profile" jsonb, "conversation_memory" jsonb, "importance_level" character varying, "deleted_at" timestamp(6), "faction_id" integer, "location_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_npcs_on_discarded_at" ON "npcs" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "player_engagements" CASCADE[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE TABLE "player_engagements" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_player_engagements_on_discarded_at" ON "player_engagements" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "plot_hooks" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "plot_hooks" ("id" bigserial primary key, "campaign_id" integer, "created_by_user_id" integer, "title" character varying, "description" text, "hook_type" character varying, "urgency" character varying, "complexity" character varying, "suggested_level_min" integer, "suggested_level_max" integer, "factions_involved" jsonb, "npcs_involved" jsonb, "locations_involved" jsonb, "rewards_suggested" jsonb, "complications" jsonb, "status" character varying, "converted_to_quest_id" integer, "ai_generated" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_plot_hooks_on_discarded_at" ON "plot_hooks" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "quest_logs" CASCADE[0m
  [1m[35m (4.1ms)[0m  [1m[35mCREATE TABLE "quest_logs" ("id" bigserial primary key, "campaign_id" integer, "character_id" integer, "title" character varying, "description" text, "status" character varying, "quest_type" character varying, "difficulty" character varying, "experience_reward" integer, "started_at" timestamp(6), "completed_at" timestamp(6), "deleted_at" timestamp(6), "priority" integer DEFAULT 0, "gold_reward" integer DEFAULT 0, "item_rewards" jsonb DEFAULT '[]', "prerequisites" jsonb DEFAULT '{}', "quest_chain_id" integer, "parent_quest_id" integer, "location" character varying, "npc_ids" jsonb DEFAULT '[]', "assigned_to_party" boolean, "milestone_data" jsonb DEFAULT '{}', "template_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_quest_logs_on_discarded_at" ON "quest_logs" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "quest_objectives" CASCADE[0m
  [1m[35m (2.9ms)[0m  [1m[35mCREATE TABLE "quest_objectives" ("id" bigserial primary key, "description" character varying, "order_index" integer, "completed" boolean, "optional" boolean, "progress_current" integer, "progress_target" integer, "deleted_at" timestamp(6), "quest_log_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_quest_objectives_on_discarded_at" ON "quest_objectives" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "quest_templates" CASCADE[0m
  [1m[35m (3.4ms)[0m  [1m[35mCREATE TABLE "quest_templates" ("id" bigserial primary key, "name" character varying, "description" text, "quest_type" character varying, "difficulty" character varying, "objectives" jsonb, "rewards" jsonb, "prerequisites" jsonb, "icon" character varying, "color" character varying, "category" character varying, "estimated_duration_minutes" integer, "min_party_level" integer, "max_party_level" integer, "location_tags" jsonb, "npc_tags" jsonb, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "races" CASCADE[0m
  [1m[35m (3.6ms)[0m  [1m[35mCREATE TABLE "races" ("id" bigserial primary key, "name" character varying, "size" character varying, "speed" integer, "ability_increases" jsonb, "traits" jsonb, "languages" jsonb, "description" text, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_races_on_discarded_at" ON "races" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "session_presences" CASCADE[0m
  [1m[35m (3.2ms)[0m  [1m[35mCREATE TABLE "session_presences" ("id" bigserial primary key, "user_id" integer NOT NULL, "game_session_id" integer NOT NULL, "status" character varying DEFAULT 'offline' NOT NULL, "connection_count" integer DEFAULT 0 NOT NULL, "last_activity_at" timestamp(6), "disconnected_at" timestamp(6), "status_message" character varying, "manual_status" boolean NOT NULL, "ip_address" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "session_recaps" CASCADE[0m
  [1m[35m (3.5ms)[0m  [1m[35mCREATE TABLE "session_recaps" ("id" bigserial primary key, "game_session_id" integer, "generated_by_user_id" integer, "summary" text, "key_events" jsonb, "npcs_met" jsonb, "locations_visited" jsonb, "combat_summary" text, "experience_gained" integer, "treasure_found" text, "quests_updated" jsonb, "auto_generated" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_session_recaps_on_discarded_at" ON "session_recaps" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "sessions" CASCADE[0m
  [1m[35m (3.9ms)[0m  [1m[35mCREATE TABLE "sessions" ("id" bigserial primary key, "user_id" integer NOT NULL, "user_agent" character varying, "ip_address" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.2ms)[0m  [1m[35mDROP TABLE IF EXISTS "shared_contents" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "shared_contents" ("id" bigserial primary key, "user_id" integer NOT NULL, "content_type" character varying NOT NULL, "content_id" integer NOT NULL, "title" character varying NOT NULL, "description" text, "visibility" character varying DEFAULT 'public' NOT NULL, "license_type" character varying DEFAULT 'cc_by' NOT NULL, "view_count" integer DEFAULT 0 NOT NULL, "clone_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_shared_contents_on_discarded_at" ON "shared_contents" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "solo_game_states" CASCADE[0m
  [1m[35m (1.7ms)[0m  [1m[35mCREATE TABLE "solo_game_states" ("id" bigserial primary key, "current_scene" character varying, "current_location" character varying, "time_of_day" character varying, "weather" character varying, "combat_active" boolean, "scene_data" jsonb, "npcs_present" jsonb, "active_quests" jsonb, "inventory_state" jsonb, "resources" jsonb, "solo_session_id" integer, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_solo_game_states_on_discarded_at" ON "solo_game_states" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "solo_sessions" CASCADE[0m
  [1m[35m (2.2ms)[0m  [1m[35mCREATE TABLE "solo_sessions" ("id" bigserial primary key, "started_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_solo_sessions_on_discarded_at" ON "solo_sessions" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "spell_filter_presets" CASCADE[0m
  [1m[35m (2.8ms)[0m  [1m[35mCREATE TABLE "spell_filter_presets" ("id" bigserial primary key, "user_id" integer, "name" character varying NOT NULL, "description" text, "filter_data" jsonb DEFAULT '{}' NOT NULL, "is_default" boolean NOT NULL, "is_public" boolean NOT NULL, "preset_type" character varying DEFAULT 'custom' NOT NULL, "usage_count" integer DEFAULT 0 NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.9ms)[0m  [1m[35mDROP TABLE IF EXISTS "spells" CASCADE[0m
  [1m[35m (5.9ms)[0m  [1m[35mCREATE TABLE "spells" ("id" bigserial primary key, "name" character varying, "level" integer, "school" character varying, "casting_time" character varying, "range" character varying, "components" jsonb, "duration" character varying, "concentration" boolean, "ritual" boolean, "description" text, "higher_levels" text, "classes" jsonb, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE INDEX "index_spells_on_discarded_at" ON "spells" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "template_ratings" CASCADE[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE TABLE "template_ratings" ("id" bigserial primary key, "campaign_template_id" integer NOT NULL, "user_id" integer NOT NULL, "rating" integer NOT NULL, "review" text, "helpful_count" integer DEFAULT 0 NOT NULL, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_template_ratings_on_discarded_at" ON "template_ratings" ("discarded_at")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "terminal_sessions" CASCADE[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "terminal_sessions" ("id" bigserial primary key, "user_id" bigint NOT NULL, "title" character varying, "mode" character varying DEFAULT 'exploration', "active" boolean DEFAULT TRUE, "character_id" bigint, "dungeon_map_id" bigint, "solo_session_id" bigint, "map_render_mode" character varying DEFAULT 'ascii', "show_map_panel" boolean DEFAULT TRUE, "command_history" jsonb DEFAULT '[]', "settings" jsonb DEFAULT '{}', "discord_channel_id" character varying, "discord_guild_id" character varying, "discord_thread_id" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "session_token" character varying)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_active" ON "terminal_sessions" ("active")[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_character_id" ON "terminal_sessions" ("character_id")[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_discord_channel_id" ON "terminal_sessions" ("discord_channel_id")[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_dungeon_map_id" ON "terminal_sessions" ("dungeon_map_id")[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_solo_session_id" ON "terminal_sessions" ("solo_session_id")[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_user_id" ON "terminal_sessions" ("user_id")[0m
  [1m[35m (0.0ms)[0m  [1m[35mDROP TABLE IF EXISTS "tokens" CASCADE[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "tokens" ("id" bigserial primary key, "character_id" integer, "name" character varying, "token_type" character varying, "grid_x" integer, "grid_y" integer, "size" character varying, "color" character varying, "icon" character varying, "visible_to_players" boolean, "current_hit_points" integer, "max_hit_points" integer, "deleted_at" timestamp(6), "map_id" integer, "encounter_monster_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE INDEX "index_tokens_on_discarded_at" ON "tokens" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "user_blocks" CASCADE[0m
  [1m[35m (2.4ms)[0m  [1m[35mCREATE TABLE "user_blocks" ("id" bigserial primary key, "blocker_id" integer NOT NULL, "blocked_id" integer NOT NULL, "reason" character varying, "discarded_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_user_blocks_on_discarded_at" ON "user_blocks" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "user_theme_preferences" CASCADE[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "user_theme_preferences" ("id" bigserial primary key, "user_id" integer NOT NULL, "primary_color" character varying, "secondary_color" character varying, "accent_color" character varying, "background_color" character varying, "text_color" character varying, "dark_mode" boolean NOT NULL, "high_contrast" boolean NOT NULL, "reduced_motion" boolean NOT NULL, "font_size" character varying DEFAULT 'medium', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.3ms)[0m  [1m[35mDROP TABLE IF EXISTS "users" CASCADE[0m
  [1m[35m (3.8ms)[0m  [1m[35mCREATE TABLE "users" ("id" bigserial primary key, "email" character varying NOT NULL, "password_digest" character varying, "role" character varying DEFAULT 'user', "discarded_at" timestamp(6), "username" character varying, "bio" text, "avatar_url" character varying, "experience_points" integer, "level" integer, "preferences" character varying, "timezone" character varying, "last_active_at" timestamp(6), "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "encrypted_password" character varying DEFAULT '' NOT NULL, "reset_password_token" character varying, "reset_password_sent_at" timestamp(6), "remember_created_at" timestamp(6), "sign_in_count" integer DEFAULT 0 NOT NULL, "current_sign_in_at" timestamp(6), "last_sign_in_at" timestamp(6), "current_sign_in_ip" character varying, "last_sign_in_ip" character varying, "guest" boolean DEFAULT FALSE, "display_name" character varying, "discord_id" character varying, "discord_username" character varying, "discord_discriminator" character varying, "discord_avatar" character varying, "discord_access_token" character varying, "discord_refresh_token" character varying, "discord_token_expires_at" timestamp(6), "ai_tokens_used" integer DEFAULT 0, "ai_tokens_limit" integer DEFAULT 100000, "ai_tokens_reset_at" timestamp(6))[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_users_on_discarded_at" ON "users" ("discarded_at")[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_discord_id" ON "users" ("discord_id")[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_email" ON "users" ("email")[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_reset_password_token" ON "users" ("reset_password_token")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "versions" CASCADE[0m
  [1m[35m (3.2ms)[0m  [1m[35mCREATE TABLE "versions" ("id" bigserial primary key, "whodunnit" character varying, "created_at" timestamp(6), "item_id" bigint NOT NULL, "item_type" character varying NOT NULL, "event" character varying NOT NULL, "object" text)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_versions_on_item_type_and_item_id" ON "versions" ("item_type", "item_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "vtt_maps" CASCADE[0m
  [1m[35m (4.1ms)[0m  [1m[35mCREATE TABLE "vtt_maps" ("id" bigserial primary key, "vtt_session_id" integer NOT NULL, "background_url" character varying NOT NULL, "width" integer DEFAULT 30 NOT NULL, "height" integer DEFAULT 20 NOT NULL, "grid_overlay" boolean DEFAULT TRUE NOT NULL, "terrain_features" jsonb DEFAULT '[]', "metadata" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "vtt_sessions" CASCADE[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE TABLE "vtt_sessions" ("id" bigserial primary key, "game_session_id" integer NOT NULL, "campaign_id" integer NOT NULL, "location_id" integer, "encounter_id" integer, "grid_size" integer DEFAULT 50 NOT NULL, "grid_type" character varying DEFAULT 'square' NOT NULL, "zoom_level" decimal DEFAULT 1.0, "active" boolean DEFAULT TRUE NOT NULL, "round_number" integer DEFAULT 0, "state_snapshot" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "vtt_tokens" CASCADE[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE TABLE "vtt_tokens" ("id" bigserial primary key, "vtt_session_id" integer NOT NULL, "character_id" integer, "npc_id" integer, "monster_id" integer, "x" decimal DEFAULT 0.0 NOT NULL, "y" decimal DEFAULT 0.0 NOT NULL, "rotation" integer DEFAULT 0 NOT NULL, "hidden" boolean NOT NULL, "size" character varying DEFAULT 'medium' NOT NULL, "metadata" jsonb DEFAULT '{}' NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "weapons" CASCADE[0m
  [1m[35m (2.8ms)[0m  [1m[35mCREATE TABLE "weapons" ("id" bigserial primary key, "name" character varying NOT NULL, "damage_dice" character varying NOT NULL, "damage_type" character varying, "properties" jsonb DEFAULT '[]', "versatile_damage" character varying, "character_id" integer, "item_id" integer, "active" boolean DEFAULT TRUE, "equipped" boolean, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_weapons_on_discarded_at" ON "weapons" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "world_lore_entries" CASCADE[0m
  [1m[35m (3.2ms)[0m  [1m[35mCREATE TABLE "world_lore_entries" ("id" bigserial primary key, "title" character varying, "entry_type" character varying, "content" text, "tags" jsonb, "metadata" jsonb, "visibility" character varying, "created_by_id" integer, "deleted_at" timestamp(6), "world_id" integer, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_world_lore_entries_on_discarded_at" ON "world_lore_entries" ("discarded_at")[0m
  [1m[35m (0.1ms)[0m  [1m[35mDROP TABLE IF EXISTS "worlds" CASCADE[0m
  [1m[35m (2.7ms)[0m  [1m[35mCREATE TABLE "worlds" ("id" bigserial primary key, "name" character varying, "description" text, "settings" jsonb, "creator_id" integer, "visibility" character varying, "deleted_at" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, "discarded_at" timestamp(6))[0m
  [1m[35m (1.6ms)[0m  [1m[35mCREATE INDEX "index_worlds_on_discarded_at" ON "worlds" ("discarded_at")[0m
  [1m[35m (2.8ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD CONSTRAINT "fk_rails_c17cc44297"
FOREIGN KEY ("character_id")
  REFERENCES "characters" ("id")
[0m
  [1m[35m (1.1ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD CONSTRAINT "fk_rails_04b7a837a0"
FOREIGN KEY ("dungeon_map_id")
  REFERENCES "maps" ("id")
[0m
  [1m[35m (1.3ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD CONSTRAINT "fk_rails_ec8e38d3cd"
FOREIGN KEY ("solo_session_id")
  REFERENCES "solo_sessions" ("id")
[0m
  [1m[35m (3.6ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD CONSTRAINT "fk_rails_022a51465b"
FOREIGN KEY ("user_id")
  REFERENCES "users" ("id")
[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES (20251120052151)[0m
  [1m[35m (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" (version) VALUES
(20251120052100),
(20251120052001),
(20251120051800),
(20251120051702),
(20251119192257),
(20251119192256),
(20251119192255),
(20251119192254),
(20251119192253),
(20251119192252),
(20251119192251),
(20251119192250),
(20251119192249),
(20251119192248),
(20251119192247),
(20251119192246),
(20251119192245),
(20251119192244),
(20251119192243),
(20251119192242),
(20251119192241),
(20251119192240),
(20251119192239),
(20251119192238),
(20251119192237),
(20251119192236),
(20251119192235),
(20251119192234),
(20251119192233),
(20251119192232),
(20251119192231),
(20251119192230),
(20251119192229),
(20251119192228),
(20251119192227),
(20251119192226),
(20251119192225),
(20251119192224),
(20251119192223),
(20251119192222),
(20251119192221),
(20251119192220),
(20251119192219),
(20251119192218),
(20251119192217),
(20251119192216),
(20251119192215),
(20251119192214),
(20251119192213),
(20251119192212),
(20251119192211),
(20251119192210),
(20251119192209),
(20251119192208),
(20251119192207),
(20251119192206),
(20251119192205),
(20251119192204),
(20251119192203),
(20251119192202),
(20251119192201),
(20251119192200),
(20251119192199),
(20251119192198),
(20251119192197),
(20251119192196),
(20251119192195),
(20251119192194),
(20251119192193),
(20251119192192),
(20251119192191),
(20251119192190),
(20251119192189),
(20251119192188),
(20251119192187),
(20251119192186),
(20251119192185),
(20251119192184),
(20251119192183),
(20251119192182),
(20251119192181),
(20251119192180),
(20251119192179),
(20251119192178),
(20251119192177),
(20251119192176),
(20251119192175),
(20251119192174),
(20251119192173),
(20251119192172),
(20251119192171),
(20251119192170),
(20251119192169),
(20251119192168),
(20251119192167),
(20251119192166),
(20251119192165),
(20251119192164),
(20251119192163),
(20251119192162),
(20251119192161),
(20251119192160),
(20251119192159),
(20251119192158),
(20251119192157);[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.3ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2025-11-20 05:24:09.401070', '2025-11-20 05:24:09.401071') RETURNING "key"[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Update (0.2ms)[0m  [1m[33mUPDATE "ar_internal_metadata" SET "value" = 'test', "updated_at" = '2025-11-20 05:24:09.402865' WHERE "ar_internal_metadata"."key" = 'environment'[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::InternalMetadata Create (0.2ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('schema_sha1', '3d9be6117de901669f79f2a4880be4fe79d6f5b6', '2025-11-20 05:24:09.403928', '2025-11-20 05:24:09.403929') RETURNING "key"[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (2.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateNarrativeOutputs (20251120060000)
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (12.2ms)[0m  [1m[35mCREATE TABLE "narrative_outputs" ("id" bigserial primary key, "terminal_session_id" bigint NOT NULL, "content" text NOT NULL, "content_type" character varying DEFAULT 'narrative' NOT NULL, "clickable_elements" jsonb DEFAULT '[]', "rendered_html" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_84cd132846"
FOREIGN KEY ("terminal_session_id")
  REFERENCES "terminal_sessions" ("id")
)[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_narrative_outputs_on_terminal_session_id" ON "narrative_outputs" ("terminal_session_id")[0m
  [1m[35m (0.8ms)[0m  [1m[35mCREATE INDEX "index_narrative_outputs_on_content_type" ON "narrative_outputs" ("content_type")[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_narrative_outputs_on_created_at" ON "narrative_outputs" ("created_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120060000') RETURNING "version"[0m
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (1.6ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateQuickActions (20251120060100)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (9.8ms)[0m  [1m[35mCREATE TABLE "quick_actions" ("id" bigserial primary key, "terminal_session_id" bigint NOT NULL, "label" character varying NOT NULL, "action_type" character varying NOT NULL, "target_id" character varying, "params" jsonb DEFAULT '{}', "tooltip" character varying, "keyboard_shortcut" character varying, "requires_roll" boolean DEFAULT FALSE, "skill_check" character varying, "dc" integer, "is_available" boolean DEFAULT TRUE, "sort_order" integer DEFAULT 0, "cooldown_until" timestamp(6), "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_2d92a7526e"
FOREIGN KEY ("terminal_session_id")
  REFERENCES "terminal_sessions" ("id")
)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_quick_actions_on_terminal_session_id" ON "quick_actions" ("terminal_session_id")[0m
  [1m[35m (2.2ms)[0m  [1m[35mCREATE INDEX "index_quick_actions_on_action_type" ON "quick_actions" ("action_type")[0m
  [1m[35m (2.4ms)[0m  [1m[35mCREATE INDEX "index_quick_actions_on_is_available" ON "quick_actions" ("is_available")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120060100') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.6ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/terminal/new" for ::1 at 2025-11-19 22:17:17 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (18.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#new as HTML
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (5.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_783526d0aba7998e@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_783526d0aba7998e@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_783526d0aba7998e"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.6ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_783526d0aba7998e@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_783526d0aba7998e"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:17:18.026620"], ["updated_at", "2025-11-20 06:17:18.026620"], ["encrypted_password", "$2a$12$3w9dKmwZgMBBlpWqVC4Mg.w.OLB6pefXEMZOR9g1UoiD9gzFXwnTy"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:17:18.026620"], ["item_id", 4], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (3.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (7.6ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "2e47e5be5e83827c86ac44b622e6ce0c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (4.3ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:17:18.045154"], ["updated_at", "2025-11-20 06:17:18.045154"], ["session_token", "2e47e5be5e83827c86ac44b622e6ce0c"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:17:18.045154"], ["item_id", 1], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:117:in 'TerminalController#create_new_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "5aabf4e7cb3a97c522ca35dc9cb52b6f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:117:in 'TerminalController#create_new_session'
  [1m[36mTerminalSession Create (1.2ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:17:18.059236"], ["updated_at", "2025-11-20 06:17:18.059236"], ["session_token", "5aabf4e7cb3a97c522ca35dc9cb52b6f"]]
  ↳ app/controllers/terminal_controller.rb:117:in 'TerminalController#create_new_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:17:18.059236"], ["item_id", 2], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:117:in 'TerminalController#create_new_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:117:in 'TerminalController#create_new_session'
Redirected to http://localhost:3000/terminal
Completed 302 Found in 303ms (ActiveRecord: 27.4ms | Allocations: 57701)


Started GET "/terminal" for ::1 at 2025-11-19 22:17:18 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "f7ff848487189b79b81a3be03d8b387a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:17:18.089541"], ["updated_at", "2025-11-20 06:17:18.089541"], ["session_token", "f7ff848487189b79b81a3be03d8b387a"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (3.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:17:18.089541"], ["item_id", 3], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (3.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 3], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (3.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 3], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 5.3ms | Allocations: 1850)
  Rendered layout layouts/terminal.html.erb (Duration: 6.1ms | Allocations: 2765)
Completed 200 OK in 73ms (Views: 4.5ms | ActiveRecord: 39.0ms | Allocations: 29906)


Started GET "/terminal" for ::1 at 2025-11-19 22:17:29 -0800
  [1m[35m (1.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "9408f7b0f708060a30a1ec574cf79ad2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.6ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:17:29.929033"], ["updated_at", "2025-11-20 06:17:29.929033"], ["session_token", "9408f7b0f708060a30a1ec574cf79ad2"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:17:29.929033"], ["item_id", 4], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.1ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 4], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.1ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 4], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.3ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 2.6ms | Allocations: 1186)
Completed 200 OK in 22ms (Views: 2.5ms | ActiveRecord: 5.0ms | Allocations: 10264)


DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 22:21:19 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_2a5d36babbf55141@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_2a5d36babbf55141@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_2a5d36babbf55141"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_2a5d36babbf55141@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_2a5d36babbf55141"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:21:20.097925"], ["updated_at", "2025-11-20 06:21:20.097925"], ["encrypted_password", "$2a$12$llau/OJndJcKIjGYZHb6IeUgmBMTC4SCOeSH8lq3lqal0JK5tKRFW"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:21:20.097925"], ["item_id", 5], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.6ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "33c3210b2940695c1984c01fe29ebd11"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 5], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:21:20.117864"], ["updated_at", "2025-11-20 06:21:20.117864"], ["session_token", "33c3210b2940695c1984c01fe29ebd11"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:21:20.117864"], ["item_id", 5], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 5], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 5], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.9ms | Allocations: 1789)
  Rendered layout layouts/terminal.html.erb (Duration: 149.8ms | Allocations: 131658)
Completed 200 OK in 503ms (Views: 150.3ms | ActiveRecord: 52.7ms | Allocations: 202843)


Started GET "/terminal" for ::1 at 2025-11-19 22:25:27 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "b2a9ee82e1a1fd61e4d94a5976b9f832"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:25:27.302912"], ["updated_at", "2025-11-20 06:25:27.302912"], ["session_token", "b2a9ee82e1a1fd61e4d94a5976b9f832"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:25:27.302912"], ["item_id", 6], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 6], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 6], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.5ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.9ms | Allocations: 1391)
Completed 200 OK in 16ms (Views: 1.9ms | ActiveRecord: 4.2ms | Allocations: 9515)


  
ActionController::RoutingError (No route matches [GET] "/assets/narrative_box_controller"):
  
  
ActionController::RoutingError (No route matches [GET] "/assets/terminal_controller"):
  
  
ActionController::RoutingError (No route matches [GET] "/assets/map_canvas_controller"):
  
Started GET "/apple-touch-icon-precomposed.png" for ::1 at 2025-11-19 22:25:36 -0800
Started GET "/apple-touch-icon.png" for ::1 at 2025-11-19 22:25:36 -0800
Started GET "/favicon.ico" for ::1 at 2025-11-19 22:25:36 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/favicon.ico"):
  
  [1m[35m (17.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/apple-touch-icon.png"):
  
  [1m[35m (12.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/apple-touch-icon-precomposed.png"):
  
Started GET "/terminal" for 127.0.0.1 at 2025-11-19 22:25:53 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (4.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_7026ef013676f38a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_7026ef013676f38a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_7026ef013676f38a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.7ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_7026ef013676f38a@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_7026ef013676f38a"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:25:54.169828"], ["updated_at", "2025-11-20 06:25:54.169828"], ["encrypted_password", "$2a$12$E/kwmPvL/c34CzrcPsCXvuixwuM7osL0tGgICodbph55R651QQqqa"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:25:54.169828"], ["item_id", 6], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (5.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "9c3bdaec9e1308de0e56c418f6d6d7e8"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.3ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:25:54.182128"], ["updated_at", "2025-11-20 06:25:54.182128"], ["session_token", "9c3bdaec9e1308de0e56c418f6d6d7e8"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:25:54.182128"], ["item_id", 7], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 7], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 7], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.1ms | Allocations: 1007)
  Rendered layout layouts/terminal.html.erb (Duration: 2.5ms | Allocations: 1410)
Completed 200 OK in 281ms (Views: 2.0ms | ActiveRecord: 15.9ms | Allocations: 16775)


  
ActionController::RoutingError (No route matches [GET] "/assets/terminal_controller"):
  
  
ActionController::RoutingError (No route matches [GET] "/assets/narrative_box_controller"):
  
  
ActionController::RoutingError (No route matches [GET] "/assets/map_canvas_controller"):
  
Started GET "/terminal" for 127.0.0.1 at 2025-11-19 22:26:24 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_6d88d869b1cea03c@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_6d88d869b1cea03c@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (1.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_6d88d869b1cea03c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.1ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_6d88d869b1cea03c@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_6d88d869b1cea03c"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:26:25.039150"], ["updated_at", "2025-11-20 06:26:25.039150"], ["encrypted_password", "$2a$12$4UrKIUTtRdX68zXpiY.Kk.u5oqmYoVK2i6NlPwRkObVm8.VCD3jpa"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:26:25.039150"], ["item_id", 7], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "f9f0f473eb23679d94ece483f7069a7f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 7], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:26:25.048194"], ["updated_at", "2025-11-20 06:26:25.048194"], ["session_token", "f9f0f473eb23679d94ece483f7069a7f"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:26:25.048194"], ["item_id", 8], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 8], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 8], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.0ms | Allocations: 1007)
  Rendered layout layouts/terminal.html.erb (Duration: 3.3ms | Allocations: 1410)
Completed 200 OK in 272ms (Views: 2.1ms | ActiveRecord: 13.4ms | Allocations: 16778)


Started GET "/" for ::1 at 2025-11-19 22:28:00 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_a976f32efb191db0@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_a976f32efb191db0@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_a976f32efb191db0"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.0ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_a976f32efb191db0@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_a976f32efb191db0"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:28:00.806159"], ["updated_at", "2025-11-20 06:28:00.806159"], ["encrypted_password", "$2a$12$2P/1nUENmk46N6SC3vTECeRA841mRt6cjd7WSZG4AE4ui8ztcEr/."], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:28:00.806159"], ["item_id", 8], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "c646d7a1f15d530007326ad0d45fd669"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 8], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:28:00.824721"], ["updated_at", "2025-11-20 06:28:00.824721"], ["session_token", "c646d7a1f15d530007326ad0d45fd669"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:28:00.824721"], ["item_id", 9], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 9], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 9], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.8ms | Allocations: 1787)
  Rendered layout layouts/terminal.html.erb (Duration: 24.0ms | Allocations: 42326)
Completed 200 OK in 364ms (Views: 24.5ms | ActiveRecord: 48.7ms | Allocations: 113996)


Started GET "/" for ::1 at 2025-11-19 22:28:08 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_c2f83e681252d6d2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.6ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_c2f83e681252d6d2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_c2f83e681252d6d2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.4ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_c2f83e681252d6d2@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_c2f83e681252d6d2"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:28:08.537226"], ["updated_at", "2025-11-20 06:28:08.537226"], ["encrypted_password", "$2a$12$hp9i/2R12AXfUD2NilQxV.kpIdKSywpjSh1veXHoD6IlVNxMnIKPS"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:28:08.537226"], ["item_id", 9], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "62b2072b65d2521f35d0124db6ad64fb"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 9], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:28:08.548085"], ["updated_at", "2025-11-20 06:28:08.548085"], ["session_token", "62b2072b65d2521f35d0124db6ad64fb"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:28:08.548085"], ["item_id", 10], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 10], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 10], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.0ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 2.5ms | Allocations: 1393)
Completed 200 OK in 267ms (Views: 2.4ms | ActiveRecord: 8.8ms | Allocations: 16674)


Started GET "/" for ::1 at 2025-11-19 22:30:02 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "e0b93217c149a6425fbcf593b0fe6cb1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (11.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:30:02.733092"], ["updated_at", "2025-11-20 06:30:02.733092"], ["session_token", "e0b93217c149a6425fbcf593b0fe6cb1"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (2.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:30:02.733092"], ["item_id", 11], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 11], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 11], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.3ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 2.9ms | Allocations: 1391)
Completed 200 OK in 35ms (Views: 2.9ms | ActiveRecord: 18.2ms | Allocations: 9503)


Started GET "/cable" for ::1 at 2025-11-19 22:30:02 -0800
  [1m[35m (11.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 22:30:02 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 11], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xMQ
TerminalDmChannel is streaming from terminal_session_11
Could not execute command from ({"command" => "subscribe", "identifier" => "{\"channel\":\"TerminalDmChannel\",\"session_id\":11}"}) [ActiveRecord::StatementInvalid - PG::UndefinedTable: ERROR:  relation "dm_pending_actions" does not exist
LINE 10:  WHERE a.attrelid = '"dm_pending_actions"'::regclass
                             ^
]: /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'PG::Connection#exec' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'block (2 levels) in ActiveRecord::ConnectionAdapters::PostgreSQL::DatabaseStatements#query' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:1027:in 'block in ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:999:in 'ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection'
TerminalDmChannel#send_message({"message" => "hi"})
Could not execute command from ({"command" => "message", "identifier" => "{\"channel\":\"TerminalDmChannel\",\"session_id\":11}", "data" => "{\"message\":\"hi\",\"action\":\"send_message\"}"}) [TypeError - can't convert Hash into Integer]: <internal:kernel>:288:in 'Kernel#Integer' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:482:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#sanitize_limit' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/query_methods.rb:1585:in 'ActiveRecord::QueryMethods#build_arel' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/query_methods.rb:1490:in 'ActiveRecord::QueryMethods#arel' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation.rb:1008:in 'block in ActiveRecord::Relation#exec_main_query'
Started GET "/" for ::1 at 2025-11-19 22:35:07 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_fb7ecb9d8aa350a0@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_fb7ecb9d8aa350a0@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_fb7ecb9d8aa350a0"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.0ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_fb7ecb9d8aa350a0@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_fb7ecb9d8aa350a0"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:35:07.922636"], ["updated_at", "2025-11-20 06:35:07.922636"], ["encrypted_password", "$2a$12$q0Nj4SXzltokPuGYoHxeyOLuvTCGWxKcZjtaRSr3z3Oo6X2OMo0Va"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:35:07.922636"], ["item_id", 10], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "52af589e989b7596521f912cef2bc265"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 10], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:35:07.941993"], ["updated_at", "2025-11-20 06:35:07.941993"], ["session_token", "52af589e989b7596521f912cef2bc265"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:35:07.941993"], ["item_id", 12], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 12], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 12], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.8ms | Allocations: 1792)
  Rendered layout layouts/terminal.html.erb (Duration: 11.9ms | Allocations: 40959)
Completed 200 OK in 346ms (Views: 12.1ms | ActiveRecord: 43.9ms | Allocations: 112545)


Started GET "/cable" for ::1 at 2025-11-19 22:35:14 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 22:35:14 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 11], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xMQ
TerminalDmChannel is streaming from terminal_session_11
Could not execute command from ({"command" => "subscribe", "identifier" => "{\"channel\":\"TerminalDmChannel\",\"session_id\":11}"}) [ActiveRecord::StatementInvalid - PG::UndefinedTable: ERROR:  relation "dm_pending_actions" does not exist
LINE 10:  WHERE a.attrelid = '"dm_pending_actions"'::regclass
                             ^
]: /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'PG::Connection#exec' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'block (2 levels) in ActiveRecord::ConnectionAdapters::PostgreSQL::DatabaseStatements#query' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:1027:in 'block in ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize' | /opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:999:in 'ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateDmPendingActions (20251120063752)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (8.9ms)[0m  [1m[35mCREATE TABLE "dm_pending_actions" ("id" serial NOT NULL PRIMARY KEY, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120063752') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.7ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.8ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddColumnsToDmPendingActions (20251120063903)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.7ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "terminal_session_id" bigint NOT NULL[0m
  [1m[35m (2.7ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_terminal_session_id" ON "dm_pending_actions" ("terminal_session_id")[0m
  [1m[35m (5.6ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD CONSTRAINT "fk_rails_55d31f7a89"
FOREIGN KEY ("terminal_session_id")
  REFERENCES "terminal_sessions" ("id")
[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "character_id" bigint[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_character_id" ON "dm_pending_actions" ("character_id")[0m
  [1m[35m (4.1ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD CONSTRAINT "fk_rails_aff1c8c8df"
FOREIGN KEY ("character_id")
  REFERENCES "characters" ("id")
[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "user_id" bigint NOT NULL[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_user_id" ON "dm_pending_actions" ("user_id")[0m
  [1m[35m (4.5ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD CONSTRAINT "fk_rails_8f36b96aad"
FOREIGN KEY ("user_id")
  REFERENCES "users" ("id")
[0m
  [1m[35m (2.9ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "tool_name" character varying NOT NULL[0m
  [1m[35m (1.2ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "parameters" jsonb DEFAULT '{}'[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "description" text[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "dm_reasoning" text[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "status" character varying DEFAULT 'pending' NOT NULL[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "expires_at" timestamp(6)[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "reviewed_at" timestamp(6)[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "reviewed_by" bigint[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "player_response" text[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "execution_result" jsonb[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "error_message" text[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "batch_id" character varying[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "batch_order" integer[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "dm_pending_actions" ADD "discarded_at" timestamp(6)[0m
  [1m[35m (2.2ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_status" ON "dm_pending_actions" ("status")[0m
  [1m[35m (1.7ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_expires_at" ON "dm_pending_actions" ("expires_at")[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_batch_id" ON "dm_pending_actions" ("batch_id")[0m
  [1m[35m (1.5ms)[0m  [1m[35mCREATE INDEX "index_dm_pending_actions_on_discarded_at" ON "dm_pending_actions" ("discarded_at")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.8ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120063903') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 22:41:34 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.6ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (4.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_29b6de3f362f8869@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_29b6de3f362f8869@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_29b6de3f362f8869"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (2.2ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_29b6de3f362f8869@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_29b6de3f362f8869"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 06:41:35.375767"], ["updated_at", "2025-11-20 06:41:35.375767"], ["encrypted_password", "$2a$12$tycMS0p.PmoFP8JIo8NXYu9qpPSbtZxYGHRv462/odEXWyZaBbi7e"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (2.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:41:35.375767"], ["item_id", 11], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (2.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (5.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "0cb0b3c2187e74ca1996a6354fe2112f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 11], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:41:35.438833"], ["updated_at", "2025-11-20 06:41:35.438833"], ["session_token", "0cb0b3c2187e74ca1996a6354fe2112f"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:41:35.438833"], ["item_id", 13], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 13], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 13], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.3ms | Allocations: 1998)
  Rendered layout layouts/terminal.html.erb (Duration: 40.6ms | Allocations: 61817)
Completed 200 OK in 552ms (Views: 42.2ms | ActiveRecord: 75.0ms | Allocations: 443135)


Started GET "/cable" for ::1 at 2025-11-19 22:41:36 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 22:41:36 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 11], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xMQ
TerminalDmChannel is streaming from terminal_session_11
  [1m[36mDmPendingAction Load (2.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 11], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 11, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-19 22:57:47 -0800
  [1m[35m (16.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "90637bbb85a8dc9f3fe5267e420230b0"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 06:57:47.184141"], ["updated_at", "2025-11-20 06:57:47.184141"], ["session_token", "90637bbb85a8dc9f3fe5267e420230b0"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 06:57:47.184141"], ["item_id", 14], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 14], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 14], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.4ms | Allocations: 993)
  Rendered layout layouts/terminal.html.erb (Duration: 2.8ms | Allocations: 1377)
Completed 200 OK in 21ms (Views: 2.1ms | ActiveRecord: 9.4ms | Allocations: 9600)


Finished "/cable" [WebSocket] for ::1 at 2025-11-19 22:57:47 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xMQ
TerminalDmChannel stopped streaming from terminal_session_11
Started GET "/cable" for ::1 at 2025-11-19 22:57:47 -0800
  [1m[35m (0.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 22:57:47 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 14], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA
TerminalDmChannel is streaming from terminal_session_14
  [1m[36mDmPendingAction Load (1.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 14], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 14, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hi"})
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA: {type: "dm_response", narrative: "I heard you say: 'hi'. The AI DM system is being configured...", tool_results: [], pending_approvals: [], quick_actions: [{label: "Look around", action_type: "search", params: {}}, {label: "Check inventory", action_type: "inventory", params: {}}], state_updates: ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "I heard you say: 'hi'. The AI DM system is being configured...", "tool_results" => [], "pending_approvals" => [], "quick_actions" => [{"label" => "Look around", "action_type" => "search", "params" => {}}, {"label" => "Check inventory", "action_type" => "i... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA)
TerminalDmChannel#quick_action({"params" => {}})
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA: {type: "dm_response", narrative: "I heard you say: 'I quick action.'. The AI DM system is being configured...", tool_results: [], pending_approvals: [], quick_actions: [{label: "Look around", action_type: "search", params: {}}, {label: "Check inventory", action_type: "inventory", params: {}}], st...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "I heard you say: 'I quick action.'. The AI DM system is being configured...", "tool_results" => [], "pending_approvals" => [], "quick_actions" => [{"label" => "Look around", "action_type" => "search", "params" => {}}, {"label" => "Check inventory", "actio... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-19 23:01:12 -0800
  [1m[36mActiveRecord::SchemaMigration Load (2.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:01:12 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.9ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 14], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA
TerminalDmChannel is streaming from terminal_session_14
  [1m[36mDmPendingAction Load (1.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 14], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 14, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-19 23:01:14 -0800
  [1m[35m (2.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (4.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_66d29f0da469d9c3@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_66d29f0da469d9c3@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_66d29f0da469d9c3"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (2.4ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_66d29f0da469d9c3@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_66d29f0da469d9c3"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 07:01:14.833379"], ["updated_at", "2025-11-20 07:01:14.833379"], ["encrypted_password", "$2a$12$8gqxdGTPi39rWk3E6ikQfemRKY5PQXWy12/8z6Ui6nnCDb9kbIGty"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:01:14.833379"], ["item_id", 12], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "3ade9c3ccffce546bf97185c361deceb"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 12], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 07:01:14.855830"], ["updated_at", "2025-11-20 07:01:14.855830"], ["session_token", "3ade9c3ccffce546bf97185c361deceb"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:01:14.855830"], ["item_id", 15], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 15], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 15], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.0ms | Allocations: 1976)
  Rendered layout layouts/terminal.html.erb (Duration: 31.5ms | Allocations: 55227)
Completed 200 OK in 465ms (Views: 32.1ms | ActiveRecord: 34.1ms | Allocations: 384389)


Started GET "/" for ::1 at 2025-11-19 23:04:28 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "bdf8914abfde4a1e5e23b8e9b3da2b8f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 07:04:28.694399"], ["updated_at", "2025-11-20 07:04:28.694399"], ["session_token", "bdf8914abfde4a1e5e23b8e9b3da2b8f"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:04:28.694399"], ["item_id", 16], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 16], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 16], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.4ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.7ms | Allocations: 1374)
Completed 200 OK in 14ms (Views: 1.4ms | ActiveRecord: 4.3ms | Allocations: 9478)


Finished "/cable" [WebSocket] for ::1 at 2025-11-19 23:04:28 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNA
TerminalDmChannel stopped streaming from terminal_session_14
Started GET "/cable" for ::1 at 2025-11-19 23:04:28 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:04:28 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (1.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 16], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNg
TerminalDmChannel is streaming from terminal_session_16
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 16], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 16, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 16], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (1.9ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 16], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
TerminalDmChannel error: PG::UndefinedTable: ERROR:  relation "dm_action_audit_logs" does not exist
LINE 10:  WHERE a.attrelid = '"dm_action_audit_logs"'::regclass
                             ^

/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'PG::Connection#exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:19:in 'block (2 levels) in ActiveRecord::ConnectionAdapters::PostgreSQL::DatabaseStatements#query'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:1027:in 'block in ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:999:in 'ActiveRecord::ConnectionAdapters::AbstractAdapter#with_raw_connection'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:18:in 'block in ActiveRecord::ConnectionAdapters::PostgreSQL::DatabaseStatements#query'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:1142:in 'ActiveRecord::ConnectionAdapters::AbstractAdapter#log'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:17:in 'ActiveRecord::ConnectionAdapters::PostgreSQL::DatabaseStatements#query'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/postgresql_adapter.rb:1074:in 'ActiveRecord::ConnectionAdapters::PostgreSQLAdapter#column_definitions'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/schema_statements.rb:109:in 'ActiveRecord::ConnectionAdapters::SchemaStatements#columns'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:346:in 'block in ActiveRecord::ConnectionAdapters::SchemaCache#columns'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:345:in 'Hash#fetch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:345:in 'ActiveRecord::ConnectionAdapters::SchemaCache#columns'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:354:in 'block in ActiveRecord::ConnectionAdapters::SchemaCache#columns_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:353:in 'Hash#fetch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:353:in 'ActiveRecord::ConnectionAdapters::SchemaCache#columns_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:58:in 'ActiveRecord::ConnectionAdapters::SchemaReflection#columns_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/schema_cache.rb:188:in 'ActiveRecord::ConnectionAdapters::BoundSchemaReflection#columns_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:622:in 'ActiveRecord::ModelSchema::ClassMethods#load_schema!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attributes.rb:264:in 'ActiveRecord::Attributes::ClassMethods#load_schema!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/encryption/encryptable_record.rb:127:in 'ActiveRecord::Encryption::EncryptableRecord::ClassMethods#load_schema!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:567:in 'block in ActiveRecord::ModelSchema::ClassMethods#load_schema'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:564:in 'Monitor#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:564:in 'ActiveRecord::ModelSchema::ClassMethods#load_schema'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:445:in 'ActiveRecord::ModelSchema::ClassMethods#attribute_types'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/model_schema.rb:471:in 'ActiveRecord::ModelSchema::ClassMethods#type_for_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/type_caster/map.rb:16:in 'ActiveRecord::TypeCaster::Map#type_for_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/arel/table.rb:111:in 'Arel::Table#type_for_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/table_metadata.rb:18:in 'ActiveRecord::TableMetadata#type'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:59:in 'ActiveRecord::PredicateBuilder#build'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:54:in 'ActiveRecord::PredicateBuilder#[]'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:132:in 'block in ActiveRecord::PredicateBuilder#expand_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'Enumerable#flat_map'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'ActiveRecord::PredicateBuilder#expand_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:109:in 'block (2 levels) in ActiveRecord::PredicateBuilder#expand_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:106:in 'Array#map!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:106:in 'block in ActiveRecord::PredicateBuilder#expand_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'Enumerable#flat_map'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:79:in 'ActiveRecord::PredicateBuilder#expand_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/predicate_builder.rb:25:in 'ActiveRecord::PredicateBuilder#build_from_hash'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/query_methods.rb:1526:in 'ActiveRecord::QueryMethods#build_where_clause'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/query_methods.rb:943:in 'ActiveRecord::QueryMethods#where!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/relation/query_methods.rb:938:in 'ActiveRecord::QueryMethods#where'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/querying.rb:23:in 'ActiveRecord::Querying#where'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:219:in 'AiDm::Orchestrator#recent_history_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:127:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:18:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNg: {type: "error", message: "Error processing message: PG::UndefinedTable: ERROR:  relation \"dm_action_audit_logs\" does not exist\nLINE 10:  WHERE a.attrelid = '\"dm_action_audit_logs\"'::regclass\n                             ^\n", timestamp: "2025-11-20T07:04:32Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: PG::UndefinedTable: ERROR:  relation \"dm_action_audit_logs\" does not exist\nLINE 10:  WHERE a.attrelid = '\"dm_action_audit_logs\"'::regclass\n                             ^\n", "timestamp" => "2025-11-20T07:04:32Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNg)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (2.5ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to CreateDmActionAuditLogs (20251120070506)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (13.1ms)[0m  [1m[35mCREATE TABLE "dm_action_audit_logs" ("id" bigserial primary key, "terminal_session_id" bigint NOT NULL, "character_id" bigint, "dm_pending_action_id" bigint, "tool_name" character varying NOT NULL, "parameters" jsonb DEFAULT '{}', "result" jsonb DEFAULT '{}', "execution_status" character varying DEFAULT 'executed' NOT NULL, "state_before" jsonb DEFAULT '{}', "state_after" jsonb DEFAULT '{}', "conversation_turn" integer, "trigger_source" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_05d4364196"
FOREIGN KEY ("terminal_session_id")
  REFERENCES "terminal_sessions" ("id")
, CONSTRAINT "fk_rails_0a96cea683"
FOREIGN KEY ("character_id")
  REFERENCES "characters" ("id")
, CONSTRAINT "fk_rails_5a20c61d7a"
FOREIGN KEY ("dm_pending_action_id")
  REFERENCES "dm_pending_actions" ("id")
)[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_terminal_session_id" ON "dm_action_audit_logs" ("terminal_session_id")[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_character_id" ON "dm_action_audit_logs" ("character_id")[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_dm_pending_action_id" ON "dm_action_audit_logs" ("dm_pending_action_id")[0m
  [1m[35m (0.9ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_execution_status" ON "dm_action_audit_logs" ("execution_status")[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_conversation_turn" ON "dm_action_audit_logs" ("conversation_turn")[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_dm_action_audit_logs_on_tool_name" ON "dm_action_audit_logs" ("tool_name")[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "idx_on_terminal_session_id_conversation_turn_bb3e312073" ON "dm_action_audit_logs" ("terminal_session_id", "conversation_turn")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120070506') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.7ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-19 23:12:41 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_568475e0e55dcd5a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_568475e0e55dcd5a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_568475e0e55dcd5a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_568475e0e55dcd5a@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_568475e0e55dcd5a"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 07:12:41.683725"], ["updated_at", "2025-11-20 07:12:41.683725"], ["encrypted_password", "$2a$12$ChZKsZGc94i9pk/TkAn3Aug8X10dxeDsb5MaV2utHwEUXXEUSoaKq"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (2.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:12:41.683725"], ["item_id", 13], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (2.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (5.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "2dd45083e0263b832c1b50645f95177b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.2ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 13], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 07:12:41.747235"], ["updated_at", "2025-11-20 07:12:41.747235"], ["session_token", "2dd45083e0263b832c1b50645f95177b"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:12:41.747235"], ["item_id", 17], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 17], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 17], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.4ms | Allocations: 1998)
  Rendered layout layouts/terminal.html.erb (Duration: 30.9ms | Allocations: 55333)
Completed 200 OK in 529ms (Views: 31.7ms | ActiveRecord: 63.7ms | Allocations: 436650)


Started GET "/cable" for ::1 at 2025-11-19 23:12:49 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:12:49 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 16], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNg
TerminalDmChannel is streaming from terminal_session_16
  [1m[36mDmPendingAction Load (2.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 16], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 16, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-19 23:15:11 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "9324ba95adbbcd1c8a47be7934b417a9"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 07:15:11.290403"], ["updated_at", "2025-11-20 07:15:11.290403"], ["session_token", "9324ba95adbbcd1c8a47be7934b417a9"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 07:15:11.290403"], ["item_id", 18], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (17.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.1ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 18], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 18], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.4ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.8ms | Allocations: 1375)
Completed 200 OK in 36ms (Views: 1.7ms | ActiveRecord: 7.8ms | Allocations: 9491)


Finished "/cable" [WebSocket] for ::1 at 2025-11-19 23:15:11 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xNg
TerminalDmChannel stopped streaming from terminal_session_16
Started GET "/cable" for ::1 at 2025-11-19 23:15:11 -0800
  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:15:11 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 18], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA
TerminalDmChannel is streaming from terminal_session_18
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 18], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 18, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 18], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (1.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 18], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (3.1ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 18], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: unknown keyword: :max_tokens
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:62:in 'generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA: {type: "error", message: "Error processing message: unknown keyword: :max_tokens", timestamp: "2025-11-20T07:15:14Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: unknown keyword: :max_tokens", "timestamp" => "2025-11-20T07:15:14Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA)
Finished "/cable" [WebSocket] for ::1 at 2025-11-19 23:46:58 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA
TerminalDmChannel stopped streaming from terminal_session_18
Started GET "/cable" for ::1 at 2025-11-19 23:58:47 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (26.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:58:47 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 18], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA
TerminalDmChannel is streaming from terminal_session_18
  [1m[36mDmPendingAction Load (1.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 18], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 18, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-19 23:58:56 -0800
  [1m[36mActiveRecord::SchemaMigration Load (3.6ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-19 23:58:56 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.1ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 18], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA
TerminalDmChannel is streaming from terminal_session_18
  [1m[36mDmPendingAction Load (3.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 18], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 18, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:07:36 -0800
  [1m[35m (16.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.6ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "ce019e7b83719a92f642cbe5a9452cd2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:07:36.523677"], ["updated_at", "2025-11-20 08:07:36.523677"], ["session_token", "ce019e7b83719a92f642cbe5a9452cd2"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:07:36.523677"], ["item_id", 19], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (2.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 19], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 19], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 5.3ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 31.7ms | Allocations: 55208)
Completed 200 OK in 204ms (Views: 31.6ms | ActiveRecord: 37.5ms | Allocations: 375284)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:07:36 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOA
TerminalDmChannel stopped streaming from terminal_session_18
Started GET "/cable" for ::1 at 2025-11-20 00:07:36 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:07:36 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 19], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOQ
TerminalDmChannel is streaming from terminal_session_19
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 19], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 19, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 19], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 19], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 19], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: unknown keyword: :max_tokens
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:62:in 'generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOQ: {type: "error", message: "Error processing message: unknown keyword: :max_tokens", timestamp: "2025-11-20T08:07:39Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: unknown keyword: :max_tokens", "timestamp" => "2025-11-20T08:07:39Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOQ)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:08:19 -0800
  [1m[36mActiveRecord::SchemaMigration Load (2.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:08:19 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.7ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 19], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOQ
TerminalDmChannel is streaming from terminal_session_19
  [1m[36mDmPendingAction Load (2.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 19], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 19, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:09:07 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "58957884d419b5a33373df66fb495df1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:09:07.086769"], ["updated_at", "2025-11-20 08:09:07.086769"], ["session_token", "58957884d419b5a33373df66fb495df1"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:09:07.086769"], ["item_id", 20], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 20], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 20], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.0ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 30.3ms | Allocations: 55198)
Completed 200 OK in 201ms (Views: 31.1ms | ActiveRecord: 40.9ms | Allocations: 375070)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:09:07 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8xOQ
TerminalDmChannel stopped streaming from terminal_session_19
Started GET "/cable" for ::1 at 2025-11-20 00:09:07 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:09:07 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 20], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMA
TerminalDmChannel is streaming from terminal_session_20
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 20], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 20, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 20], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 20], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 20], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:138:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMA: {type: "error", message: "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", timestamp: "2025-11-20T08:09:10Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", "timestamp" => "2025-11-20T08:09:10Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMA)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:10:44 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:10:45 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 20], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMA
TerminalDmChannel is streaming from terminal_session_20
  [1m[36mDmPendingAction Load (2.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 20], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 20, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:10:55 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (2.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "97b3674ec37b92eecd8bc8391d9bfe1b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.6ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:10:55.355937"], ["updated_at", "2025-11-20 08:10:55.355937"], ["session_token", "97b3674ec37b92eecd8bc8391d9bfe1b"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:10:55.355937"], ["item_id", 21], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 21], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.0ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 21], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.6ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 29.6ms | Allocations: 55199)
Completed 200 OK in 183ms (Views: 30.0ms | ActiveRecord: 26.2ms | Allocations: 375071)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:10:55 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMA
TerminalDmChannel stopped streaming from terminal_session_20
Started GET "/cable" for ::1 at 2025-11-20 00:10:55 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:10:55 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 21], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMQ
TerminalDmChannel is streaming from terminal_session_21
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 21], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 21, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 21], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 21], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 21], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:138:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMQ: {type: "error", message: "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", timestamp: "2025-11-20T08:10:57Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", "timestamp" => "2025-11-20T08:10:57Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMQ)
Started GET "/" for ::1 at 2025-11-20 00:11:20 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "2baf6e94025223aeda1ff4b5885c8ad3"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:11:20.569245"], ["updated_at", "2025-11-20 08:11:20.569245"], ["session_token", "2baf6e94025223aeda1ff4b5885c8ad3"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:11:20.569245"], ["item_id", 22], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 22], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.3ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 22], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.8ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 2.2ms | Allocations: 1375)
Completed 200 OK in 14ms (Views: 1.7ms | ActiveRecord: 4.6ms | Allocations: 9460)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:11:20 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMQ
TerminalDmChannel stopped streaming from terminal_session_21
Started GET "/cable" for ::1 at 2025-11-20 00:11:20 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:11:20 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 22], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel is streaming from terminal_session_22
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 22, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 22], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.8ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 22], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:138:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg: {type: "error", message: "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", timestamp: "2025-11-20T08:11:23Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Ollama API error: registry.ollama.ai/library/phi4:latest does not support tools", "timestamp" => "2025-11-20T08:11:23Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:11:57 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:11:57 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 22], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel is streaming from terminal_session_22
  [1m[36mDmPendingAction Load (1.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 22, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:12:13 -0800
  [1m[36mActiveRecord::SchemaMigration Load (2.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:12:13 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 22], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel is streaming from terminal_session_22
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 22, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:12:32 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:12:32 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 22], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel is streaming from terminal_session_22
  [1m[36mDmPendingAction Load (1.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 22, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:13:11 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:13:11 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.7ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 22], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel is streaming from terminal_session_22
  [1m[36mDmPendingAction Load (2.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 22], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 22, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:17:16 -0800
  [1m[35m (2.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "0804953fa5357b521e677403f2c2bbb3"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:17:16.484539"], ["updated_at", "2025-11-20 08:17:16.484539"], ["session_token", "0804953fa5357b521e677403f2c2bbb3"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:17:16.484539"], ["item_id", 23], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 23], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 23], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.0ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 35.8ms | Allocations: 55221)
Completed 200 OK in 856ms (Views: 38.6ms | ActiveRecord: 31.8ms | Allocations: 1074329)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:17:17 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMg
TerminalDmChannel stopped streaming from terminal_session_22
Started GET "/cable" for ::1 at 2025-11-20 00:17:17 -0800
  [1m[35m (8.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:17:17 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 23], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMw
TerminalDmChannel is streaming from terminal_session_23
  [1m[36mDmPendingAction Load (0.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 23], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 23, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 23], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (1.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 23], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (3.8ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 23], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: Ollama API error: registry.ollama.ai/library/wizard-vicuna-uncensored:30b does not support tools
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:138:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMw: {type: "error", message: "Error processing message: Ollama API error: registry.ollama.ai/library/wizard-vicuna-uncensored:30b does not support tools", timestamp: "2025-11-20T08:17:19Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Ollama API error: registry.ollama.ai/library/wizard-vicuna-uncensored:30b does not support tools", "timestamp" => "2025-11-20T08:17:19Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMw)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:18:16 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:18:16 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 23], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMw
TerminalDmChannel is streaming from terminal_session_23
  [1m[36mDmPendingAction Load (1.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 23], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 23, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:19:24 -0800
  [1m[35m (2.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "5454da5e432b42fe6a71d24c757b7b87"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:19:24.542248"], ["updated_at", "2025-11-20 08:19:24.542248"], ["session_token", "5454da5e432b42fe6a71d24c757b7b87"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (3.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:19:24.542248"], ["item_id", 24], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 24], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 24], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 6.5ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 45.3ms | Allocations: 55217)
Completed 200 OK in 327ms (Views: 47.4ms | ActiveRecord: 39.2ms | Allocations: 375129)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:19:24 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yMw
TerminalDmChannel stopped streaming from terminal_session_23
Started GET "/cable" for ::1 at 2025-11-20 00:19:24 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:19:24 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 24], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNA
TerminalDmChannel is streaming from terminal_session_24
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 24], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 24, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:19:25 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "6d1a4f3a479675e519a8f271dc364259"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.7ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:19:25.096435"], ["updated_at", "2025-11-20 08:19:25.096435"], ["session_token", "6d1a4f3a479675e519a8f271dc364259"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:19:25.096435"], ["item_id", 25], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (23.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 25], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 25], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.3ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.8ms | Allocations: 1374)
Completed 200 OK in 39ms (Views: 1.7ms | ActiveRecord: 28.3ms | Allocations: 9466)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:19:25 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNA
TerminalDmChannel stopped streaming from terminal_session_24
Started GET "/cable" for ::1 at 2025-11-20 00:19:25 -0800
  [1m[35m (2.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:19:25 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.1ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 25], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNQ
TerminalDmChannel is streaming from terminal_session_25
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 25], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 25, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 25], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 25], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (2.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 25], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 00:20:58 -0800
  [1m[36mActiveRecord::SchemaMigration Load (52.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (245.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:20:59 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (25.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 25], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNQ
TerminalDmChannel is streaming from terminal_session_25
  [1m[36mDmPendingAction Load (2.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 25], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 25, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 00:21:33 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "af38d85533e2b6c7cbfd00f276b5998f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (198.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 08:21:33.626530"], ["updated_at", "2025-11-20 08:21:33.626530"], ["session_token", "af38d85533e2b6c7cbfd00f276b5998f"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (23.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 08:21:33.626530"], ["item_id", 26], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (55.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (45.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 26], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (42.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 26], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 44.4ms | Allocations: 1980)
  Rendered layout layouts/terminal.html.erb (Duration: 90.7ms | Allocations: 55219)
Completed 200 OK in 687ms (Views: 51.1ms | ActiveRecord: 420.0ms | Allocations: 375131)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 00:21:34 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNQ
TerminalDmChannel stopped streaming from terminal_session_25
Started GET "/cable" for ::1 at 2025-11-20 00:21:34 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 00:21:34 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 26], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (2.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 26], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg
TerminalDmChannel is streaming from terminal_session_26
TerminalDmChannel transmitting {type: "connected", session_id: 26, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 26], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (22.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 26], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (114.8ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 26], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
Unable to process TerminalDmChannel#start_character_creation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (44.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 26], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (54.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 26], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (29.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 26], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
TerminalDmChannel error: Net::ReadTimeout with #<TCPSocket:(closed)>
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:229:in 'Net::BufferedIO#rbuf_fill'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:199:in 'Net::BufferedIO#readuntil'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:209:in 'Net::BufferedIO#readline'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http/response.rb:159:in 'Net::HTTPResponse.read_status_line'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http/response.rb:147:in 'Net::HTTPResponse.read_new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2448:in 'block in Net::HTTP#transport_request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2439:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2439:in 'Net::HTTP#transport_request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2410:in 'Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:19:in 'block in Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/mini_profiler/profiling_methods.rb:51:in 'Rack::MiniProfiler::ProfilingMethods#step'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:18:in 'Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2403:in 'block in Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:1630:in 'Net::HTTP#start'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2401:in 'Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:19:in 'block in Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/mini_profiler/profiling_methods.rb:51:in 'Rack::MiniProfiler::ProfilingMethods#step'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:18:in 'Net::HTTP#request_with_mini_profiler'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:134:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg: {type: "error", message: "Error processing message: Net::ReadTimeout with #<TCPSocket:(closed)>", timestamp: "2025-11-20T08:23:36Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Net::ReadTimeout with #<TCPSocket:(closed)>", "timestamp" => "2025-11-20T08:23:36Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg)
TerminalDmChannel error: Net::ReadTimeout with #<TCPSocket:(closed)>
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:229:in 'Net::BufferedIO#rbuf_fill'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:199:in 'Net::BufferedIO#readuntil'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-protocol-0.2.2/lib/net/protocol.rb:209:in 'Net::BufferedIO#readline'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http/response.rb:159:in 'Net::HTTPResponse.read_status_line'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http/response.rb:147:in 'Net::HTTPResponse.read_new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2448:in 'block in Net::HTTP#transport_request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2439:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2439:in 'Net::HTTP#transport_request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2410:in 'Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:19:in 'block in Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/mini_profiler/profiling_methods.rb:51:in 'Rack::MiniProfiler::ProfilingMethods#step'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:18:in 'Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2403:in 'block in Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:1630:in 'Net::HTTP#start'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/net-http-0.8.0/lib/net/http.rb:2401:in 'Net::HTTP#request'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:19:in 'block in Net::HTTP#request_with_mini_profiler'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/mini_profiler/profiling_methods.rb:51:in 'Rack::MiniProfiler::ProfilingMethods#step'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/rack-mini-profiler-4.0.1/lib/patches/net_patches.rb:18:in 'Net::HTTP#request_with_mini_profiler'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:134:in 'OllamaClient#post_request'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:40:in 'OllamaClient#chat'
/private/tmp/terminal-dnd/app/app/services/ollama_client.rb:65:in 'OllamaClient#generate_with_tools'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:22:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg: {type: "error", message: "Error processing message: Net::ReadTimeout with #<TCPSocket:(closed)>", timestamp: "2025-11-20T08:24:34Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Net::ReadTimeout with #<TCPSocket:(closed)>", "timestamp" => "2025-11-20T08:24:34Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg)
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 01:05:22 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg
TerminalDmChannel stopped streaming from terminal_session_26
Started GET "/cable" for ::1 at 2025-11-20 01:05:23 -0800
  [1m[35m (31.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 01:05:23 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (3.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.7ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 26], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg
TerminalDmChannel is streaming from terminal_session_26
  [1m[36mDmPendingAction Load (2.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 26], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 26, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 01:05:31 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "37f1d7263b836ddcfd5a25fa3df06008"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 09:05:31.420914"], ["updated_at", "2025-11-20 09:05:31.420914"], ["session_token", "37f1d7263b836ddcfd5a25fa3df06008"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (2.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 09:05:31.420914"], ["item_id", 27], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.1ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 27], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.1ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 27], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.8ms | Allocations: 993)
  Rendered layout layouts/terminal.html.erb (Duration: 5.9ms | Allocations: 1377)
Completed 200 OK in 33ms (Views: 6.1ms | ActiveRecord: 10.2ms | Allocations: 9471)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 01:05:31 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNg
TerminalDmChannel stopped streaming from terminal_session_26
Started GET "/cable" for ::1 at 2025-11-20 01:05:31 -0800
  [1m[35m (11.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 01:05:31 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 27], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 27], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 27, mode: "exploration", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel is streaming from terminal_session_27
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 27], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 27], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:184:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 27], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.9ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 27], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:305:in 'Enumerable#map'
TerminalDmChannel error: unknown attribute 'memory_hints' for NarrativeOutput.
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:51:in 'ActiveModel::AttributeAssignment#_assign_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:19:in 'block in ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:34:in 'ActiveModel::AttributeAssignment#assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/core.rb:453:in 'ActiveRecord::Core#initialize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/inheritance.rb:76:in 'Class#new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/inheritance.rb:76:in 'ActiveRecord::Inheritance::ClassMethods#new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/reflection.rb:176:in 'ActiveRecord::Reflection::AbstractReflection#build_association'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:353:in 'ActiveRecord::Associations::Association#build_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:354:in 'ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:147:in 'ActiveRecord::Associations::HasManyAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:211:in 'ActiveRecord::Associations::Association#create!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_proxy.rb:366:in 'ActiveRecord::Associations::CollectionProxy#create!'
/private/tmp/terminal-dnd/app/app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:39:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw: {type: "error", message: "Error processing message: unknown attribute 'memory_hints' for NarrativeOutput.", timestamp: "2025-11-20T09:05:43Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: unknown attribute 'memory_hints' for NarrativeOutput.", "timestamp" => "2025-11-20T09:05:43Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw)
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 02:34:24 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw
TerminalDmChannel stopped streaming from terminal_session_27
Started GET "/cable" for ::1 at 2025-11-20 08:24:11 -0800
  [1m[35m (56.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:24:12 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (8.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 27], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw
TerminalDmChannel is streaming from terminal_session_27
  [1m[36mDmPendingAction Load (1.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 27], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 27, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Unable to process TerminalDmChannel#show_character
Started GET "/" for ::1 at 2025-11-20 08:24:30 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "45fb31f01bef00cada37424d90e66417"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:24:30.660138"], ["updated_at", "2025-11-20 16:24:30.660138"], ["session_token", "45fb31f01bef00cada37424d90e66417"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:24:30.660138"], ["item_id", 28], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 28], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.6ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 28], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.8ms | Allocations: 993)
  Rendered layout layouts/terminal.html.erb (Duration: 4.3ms | Allocations: 1377)
Completed 200 OK in 26ms (Views: 3.1ms | ActiveRecord: 9.4ms | Allocations: 9470)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 08:24:30 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yNw
TerminalDmChannel stopped streaming from terminal_session_27
Started GET "/cable" for ::1 at 2025-11-20 08:24:30 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:24:30 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 28], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yOA
TerminalDmChannel is streaming from terminal_session_28
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 28], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 28, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Unable to process TerminalDmChannel#show_character
Started GET "/" for ::1 at 2025-11-20 08:31:42 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (24.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (5.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_90b676f46604fcc1@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_90b676f46604fcc1@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_90b676f46604fcc1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (2.6ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_90b676f46604fcc1@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_90b676f46604fcc1"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:31:43.082687"], ["updated_at", "2025-11-20 16:31:43.082687"], ["encrypted_password", "$2a$12$D4pxH0tk58yY991vMkbmC.7hgC0Xwe3RopMkaP1lEt2Ndq.3wM4vS"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:31:43.082687"], ["item_id", 14], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "cabd90a4022c18efdd6ee56b27228a42"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.3ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 14], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:31:43.098993"], ["updated_at", "2025-11-20 16:31:43.098993"], ["session_token", "cabd90a4022c18efdd6ee56b27228a42"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:31:43.098993"], ["item_id", 29], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 29], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 29], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.8ms | Allocations: 1803)
  Rendered layout layouts/terminal.html.erb (Duration: 18.8ms | Allocations: 35063)
Completed 200 OK in 337ms (Views: 18.5ms | ActiveRecord: 20.2ms | Allocations: 104848)


Started GET "/cable" for ::1 at 2025-11-20 08:31:57 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:31:57 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 28], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yOA
TerminalDmChannel is streaming from terminal_session_28
  [1m[36mDmPendingAction Load (2.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 28], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 28, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 08:31:57 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "28bbf43b5d8ea4da5ace4dc8e0bf7a70"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:31:57.909622"], ["updated_at", "2025-11-20 16:31:57.909622"], ["session_token", "28bbf43b5d8ea4da5ace4dc8e0bf7a70"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:31:57.909622"], ["item_id", 30], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 30], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 30], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.4ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.6ms | Allocations: 1375)
Completed 200 OK in 14ms (Views: 1.5ms | ActiveRecord: 5.4ms | Allocations: 9460)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 08:31:57 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8yOA
TerminalDmChannel stopped streaming from terminal_session_28
Started GET "/cable" for ::1 at 2025-11-20 08:31:57 -0800
  [1m[35m (4.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:31:57 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.8ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 30], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA
TerminalDmChannel is streaming from terminal_session_30
  [1m[36mDmPendingAction Load (4.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 30], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 30, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "I would like to create a character"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 30], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 30], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.8ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 30], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 30], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
TerminalDmChannel error: unknown attribute 'memory_hints' for NarrativeOutput.
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:51:in 'ActiveModel::AttributeAssignment#_assign_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:19:in 'block in ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:34:in 'ActiveModel::AttributeAssignment#assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/core.rb:453:in 'ActiveRecord::Core#initialize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/inheritance.rb:76:in 'Class#new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/inheritance.rb:76:in 'ActiveRecord::Inheritance::ClassMethods#new'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/reflection.rb:176:in 'ActiveRecord::Reflection::AbstractReflection#build_association'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:353:in 'ActiveRecord::Associations::Association#build_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:354:in 'ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:147:in 'ActiveRecord::Associations::HasManyAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:211:in 'ActiveRecord::Associations::Association#create!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_proxy.rb:366:in 'ActiveRecord::Associations::CollectionProxy#create!'
/private/tmp/terminal-dnd/app/app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:39:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA: {type: "error", message: "Error processing message: unknown attribute 'memory_hints' for NarrativeOutput.", timestamp: "2025-11-20T16:32:09Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: unknown attribute 'memory_hints' for NarrativeOutput.", "timestamp" => "2025-11-20T16:32:09Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (3.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddMissingColumnsToNarrativeOutputs (20251120163236)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (6.3ms)[0m  [1m[35mALTER TABLE "narrative_outputs" ADD "memory_hints" jsonb[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "narrative_outputs" ADD "speaker" character varying[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "narrative_outputs" ADD "related_room_id" integer[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "narrative_outputs" ADD "related_npc_id" integer[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120163236') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/" for ::1 at 2025-11-20 08:33:47 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_24de7b26ece50b78@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_24de7b26ece50b78@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_24de7b26ece50b78"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_24de7b26ece50b78@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_24de7b26ece50b78"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:33:48.082829"], ["updated_at", "2025-11-20 16:33:48.082829"], ["encrypted_password", "$2a$12$Yo8NnZXMeuwWzMrVGI2hW.d7V7pugTpMxlWCVOGlcMBhybeV3cEIa"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:33:48.082829"], ["item_id", 15], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "48df0977683f0bcefa52dd8e6385527b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 15], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:33:48.100508"], ["updated_at", "2025-11-20 16:33:48.100508"], ["session_token", "48df0977683f0bcefa52dd8e6385527b"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:33:48.100508"], ["item_id", 31], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 31], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 31], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 31], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.9ms | Allocations: 1791)
  Rendered layout layouts/terminal.html.erb (Duration: 12.7ms | Allocations: 35045)
Completed 200 OK in 358ms (Views: 13.2ms | ActiveRecord: 44.9ms | Allocations: 108639)


Started GET "/cable" for ::1 at 2025-11-20 08:33:55 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:33:55 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 30], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA
TerminalDmChannel is streaming from terminal_session_30
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 30], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 30, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 08:34:45 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_8c68a8db93bcd46a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_8c68a8db93bcd46a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_8c68a8db93bcd46a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.8ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_8c68a8db93bcd46a@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_8c68a8db93bcd46a"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:34:45.902455"], ["updated_at", "2025-11-20 16:34:45.902455"], ["encrypted_password", "$2a$12$EMlBXtgrMtquu352fbzwpeWedCyWsDCZWWHWyuaF0toJJeLobbdk2"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:34:45.902455"], ["item_id", 16], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "8c8c0f18913392dea3f197b21eb25412"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 16], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:34:45.918494"], ["updated_at", "2025-11-20 16:34:45.918494"], ["session_token", "8c8c0f18913392dea3f197b21eb25412"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:34:45.918494"], ["item_id", 32], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 32], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 32], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.6ms | Allocations: 1791)
  Rendered layout layouts/terminal.html.erb (Duration: 10.6ms | Allocations: 35045)
Completed 200 OK in 334ms (Views: 11.0ms | ActiveRecord: 31.0ms | Allocations: 106815)


Started GET "/cable" for ::1 at 2025-11-20 08:34:56 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:34:56 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 30], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA
TerminalDmChannel is streaming from terminal_session_30
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 30], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 30, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 08:35:23 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "165e7cb8638b29c5d05204870e2a6bb1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:35:23.183341"], ["updated_at", "2025-11-20 16:35:23.183341"], ["session_token", "165e7cb8638b29c5d05204870e2a6bb1"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:35:23.183341"], ["item_id", 33], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 33], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (4.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 33], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 5.3ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 5.7ms | Allocations: 1375)
Completed 200 OK in 19ms (Views: 1.8ms | ActiveRecord: 8.0ms | Allocations: 9467)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 08:35:23 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMA
TerminalDmChannel stopped streaming from terminal_session_30
Started GET "/cable" for ::1 at 2025-11-20 08:35:23 -0800
  [1m[35m (8.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:35:23 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 33], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMw
TerminalDmChannel is streaming from terminal_session_33
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 33], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 33, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 33], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 33], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 33], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 33], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
TerminalDmChannel error: Validation failed: Content type is not included in the list
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/validations.rb:84:in 'ActiveRecord::Validations#raise_validation_error'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/validations.rb:55:in 'ActiveRecord::Validations#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:313:in 'block in ActiveRecord::Transactions#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:365:in 'block in ActiveRecord::Transactions#with_transaction_returning_status'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:342:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:361:in 'ActiveRecord::Transactions#with_transaction_returning_status'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:313:in 'ActiveRecord::Transactions#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/suppressor.rb:56:in 'ActiveRecord::Suppressor#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:371:in 'ActiveRecord::Associations::CollectionAssociation#insert_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:63:in 'ActiveRecord::Associations::HasManyAssociation#insert_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:358:in 'block (2 levels) in ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:462:in 'ActiveRecord::Associations::CollectionAssociation#replace_on_target'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:278:in 'ActiveRecord::Associations::CollectionAssociation#add_to_target'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:357:in 'block in ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:344:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:212:in 'ActiveRecord::Transactions::ClassMethods#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:314:in 'ActiveRecord::Associations::CollectionAssociation#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:355:in 'ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:147:in 'ActiveRecord::Associations::HasManyAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:211:in 'ActiveRecord::Associations::Association#create!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_proxy.rb:366:in 'ActiveRecord::Associations::CollectionProxy#create!'
/private/tmp/terminal-dnd/app/app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:39:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMw: {type: "error", message: "Error processing message: Validation failed: Content type is not included in the list", timestamp: "2025-11-20T16:35:32Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: Validation failed: Content type is not included in the list", "timestamp" => "2025-11-20T16:35:32Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMw)
Started GET "/" for ::1 at 2025-11-20 08:37:13 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_5c9b307968bd6c46@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_5c9b307968bd6c46@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_5c9b307968bd6c46"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_5c9b307968bd6c46@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_5c9b307968bd6c46"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:37:13.335753"], ["updated_at", "2025-11-20 16:37:13.335753"], ["encrypted_password", "$2a$12$m2qYUp1cBVZRzinUjIrqIOeJonnBHGHobjObB66ZKLNvmHpVvDBHe"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:37:13.335753"], ["item_id", 17], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "60c1c8133bb88b2c99177673d38c470c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.2ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 17], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:37:13.356827"], ["updated_at", "2025-11-20 16:37:13.356827"], ["session_token", "60c1c8133bb88b2c99177673d38c470c"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:37:13.356827"], ["item_id", 34], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 34], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 34], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.6ms | Allocations: 1791)
  Rendered layout layouts/terminal.html.erb (Duration: 35.1ms | Allocations: 35149)
Completed 200 OK in 385ms (Views: 35.6ms | ActiveRecord: 44.5ms | Allocations: 107088)


Started GET "/cable" for ::1 at 2025-11-20 08:37:25 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:37:25 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (1.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 33], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMw
TerminalDmChannel is streaming from terminal_session_33
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 33], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 33, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 08:37:28 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "a481b2e621fa9ab491f71b4004a95a6b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:37:28.087953"], ["updated_at", "2025-11-20 16:37:28.087953"], ["session_token", "a481b2e621fa9ab491f71b4004a95a6b"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:37:28.087953"], ["item_id", 35], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 35], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.6ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 35], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.1ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.4ms | Allocations: 1375)
Completed 200 OK in 13ms (Views: 1.5ms | ActiveRecord: 3.2ms | Allocations: 9468)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 08:37:28 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zMw
TerminalDmChannel stopped streaming from terminal_session_33
Started GET "/cable" for ::1 at 2025-11-20 08:37:28 -0800
  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:37:28 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 35], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 35], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 35, mode: "exploration", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNQ
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel is streaming from terminal_session_35
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mNarrativeOutput Load (0.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 35], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 35], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 35], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 35], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 35], ["content", "hi"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:37:39.328411"], ["updated_at", "2025-11-20 16:37:39.328411"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 35], ["content", "Hello! Welcome to our D&D 5th Edition adventure! I'm your Dungeon Master, ready to guide you through an epic tale of heroism, magic, and discovery.\n\nWhat would you like to do today? Here are some options to get us started:\n\n**Create a New Character:** We can build your hero from scratch - choosing their race, class, background, and abilities.\n\n**Begin an Adventure:** If you already have a character in mind, we can dive right into the world with a quest or exploration.\n\n**Learn the Rules:** I can explain any D&D mechanics you're curious about.\n\n**Set the Scene:** Tell me what kind of adventure interests you - dungeon crawling, political intrigue, wilderness exploration, urban mysteries, or something else entirely!\n\nWhat sounds most appealing to you? Or if you have something else in mind, just let me know!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:37:39.334912"], ["updated_at", "2025-11-20 16:37:39.334912"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNQ: {type: "dm_response", narrative: "Hello! Welcome to our D&D 5th Edition adventure! I'm your Dungeon Master, ready to guide you through an epic tale of heroism, magic, and discovery.\n\nWhat would you like to do today? Here are some options to get us started:\n\n**Create a New Character:** We can ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "Hello! Welcome to our D&D 5th Edition adventure! I'm your Dungeon Master, ready to guide you through an epic tale of heroism, magic, and discovery.\n\nWhat would you like to do today? Here are some options to get us started:\n\n**Create a New Character:**... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNQ)
TerminalDmChannel#send_message({"message" => "lets make a character"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 35], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 35], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 35], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 35], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.8ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 35], ["content", "lets make a character"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:38:11.847913"], ["updated_at", "2025-11-20 16:38:11.847913"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 35], ["content", "Excellent! Let's create your character together. I'll need some key information to bring your hero to life.\n\n**Tell me about your character:**\n\n1. **Name** - What would you like to call your character?\n\n2. **Race** - What race appeals to you? Some popular options include:\n   - Human (versatile and adaptable)\n   - Elf (graceful, long-lived, magical affinity)\n   - Dwarf (sturdy, resilient, craftsman-like)\n   - Halfling (small, lucky, brave)\n   - Dragonborn (draconic heritage, breath weapon)\n   - Tiefling (infernal heritage, charismatic)\n   - Half-Elf, Half-Orc, Gnome, and many others!\n\n3. **Class** - What's your character's profession/calling?\n   - Fighter (warrior, weapon master)\n   - Wizard (scholar of arcane magic)\n   - Rogue (sneaky, skilled, versatile)\n   - Cleric (divine magic, healer/support)\n   - Ranger (nature warrior, tracker)\n   - Barbarian (primal warrior, berserker)\n   - Bard (jack-of-all-trades, inspiring)\n   - And several others like Paladin, Sorcerer, Warlock, etc.\n\n4. **Background** (optional) - What was their life like before adventuring? (Soldier, Criminal, Noble, Folk Hero, etc.)\n\nJust give me the name, race, and class to start, and we can build from there! What kind of hero do you envision?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:38:11.851772"], ["updated_at", "2025-11-20 16:38:11.851772"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNQ: {type: "dm_response", narrative: "Excellent! Let's create your character together. I'll need some key information to bring your hero to life.\n\n**Tell me about your character:**\n\n1. **Name** - What would you like to call your character?\n\n2. **Race** - What race appeals to you? Some popular o...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "Excellent! Let's create your character together. I'll need some key information to bring your hero to life.\n\n**Tell me about your character:**\n\n1. **Name** - What would you like to call your character?\n\n2. **Race** - What race appeals to you? Some p... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNQ)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 08:40:45 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_cd38a2ab11987205@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_cd38a2ab11987205@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_cd38a2ab11987205"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_cd38a2ab11987205@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_cd38a2ab11987205"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:40:46.332394"], ["updated_at", "2025-11-20 16:40:46.332394"], ["encrypted_password", "$2a$12$6170GkE//9ScGZnScSNNcuVNs3WIW8E5MkVtXwUj9xtWFHBdk0XsW"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:40:46.332394"], ["item_id", 18], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "f289d45013df0f9ac66100a64d2d8d30"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.6ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 18], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:40:46.367459"], ["updated_at", "2025-11-20 16:40:46.367459"], ["session_token", "f289d45013df0f9ac66100a64d2d8d30"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:40:46.367459"], ["item_id", 36], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (2.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 36], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 36], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.4ms | Allocations: 1998)
  Rendered layout layouts/terminal.html.erb (Duration: 65.9ms | Allocations: 55468)
Completed 200 OK in 545ms (Views: 66.5ms | ActiveRecord: 52.6ms | Allocations: 437058)


Started GET "/" for ::1 at 2025-11-20 08:41:14 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (3.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "5bb68143d019e38440c05479a1a56ddb"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:41:14.512427"], ["updated_at", "2025-11-20 16:41:14.512427"], ["session_token", "5bb68143d019e38440c05479a1a56ddb"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (2.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:41:14.512427"], ["item_id", 37], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 37], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (4.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 37], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 5.3ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 5.6ms | Allocations: 1376)
Completed 200 OK in 22ms (Views: 1.5ms | ActiveRecord: 12.9ms | Allocations: 9531)


Started GET "/cable" for ::1 at 2025-11-20 08:41:14 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:41:14 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.9ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 37], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNw
TerminalDmChannel is streaming from terminal_session_37
  [1m[36mDmPendingAction Load (1.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 37], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 37, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Unable to process TerminalDmChannel#show_character
Started GET "/" for ::1 at 2025-11-20 08:41:35 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "eb5e8651c806b3db99c579435714d374"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:41:35.756200"], ["updated_at", "2025-11-20 16:41:35.756200"], ["session_token", "eb5e8651c806b3db99c579435714d374"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:41:35.756200"], ["item_id", 38], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 38], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.3ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 38], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.6ms | Allocations: 993)
  Rendered layout layouts/terminal.html.erb (Duration: 2.9ms | Allocations: 1377)
Completed 200 OK in 16ms (Views: 2.4ms | ActiveRecord: 5.7ms | Allocations: 9476)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 08:41:35 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zNw
TerminalDmChannel stopped streaming from terminal_session_37
Started GET "/cable" for ::1 at 2025-11-20 08:41:35 -0800
  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:41:35 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 38], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA
TerminalDmChannel is streaming from terminal_session_38
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 38, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "lets make a character named aeor"})
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 38], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.8ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 38], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.6ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 38], ["content", "lets make a character named aeor"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:41:49.829593"], ["updated_at", "2025-11-20 16:41:49.829593"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 38], ["content", "I'll help you create a character named Aeor! To get started, I need a few key details:\n\n1. **Race** - What race would you like Aeor to be? (e.g., Human, Elf, Dwarf, Halfling, Dragonborn, Tiefling, etc.)\n\n2. **Class** - What class should Aeor be? (e.g., Fighter, Wizard, Rogue, Cleric, Ranger, Barbarian, etc.)\n\n3. **Background** (optional) - Any particular background you'd like? (e.g., Soldier, Noble, Criminal, Acolyte, etc.)\n\nOnce you give me the race and class, I can create Aeor and we can work on ability scores and other details!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:41:49.836912"], ["updated_at", "2025-11-20 16:41:49.836912"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA: {type: "dm_response", narrative: "I'll help you create a character named Aeor! To get started, I need a few key details:\n\n1. **Race** - What race would you like Aeor to be? (e.g., Human, Elf, Dwarf, Halfling, Dragonborn, Tiefling, etc.)\n\n2. **Class** - What class should Aeor be? (e.g., Fighte...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "I'll help you create a character named Aeor! To get started, I need a few key details:\n\n1. **Race** - What race would you like Aeor to be? (e.g., Human, Elf, Dwarf, Halfling, Dragonborn, Tiefling, etc.)\n\n2. **Class** - What class should Aeor be? (e.g.... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA)
TerminalDmChannel#send_message({"message" => "human monk, level 7"})
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 38], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:47:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:189:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 38], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:228:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (3.1ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:174:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (3.9ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Monk"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:175:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:179:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: Validation failed: Campaign must exist, Campaign can't be blank
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/validations.rb:84:in 'ActiveRecord::Validations#raise_validation_error'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/validations.rb:55:in 'ActiveRecord::Validations#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:313:in 'block in ActiveRecord::Transactions#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:365:in 'block in ActiveRecord::Transactions#with_transaction_returning_status'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:342:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:310:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 38], ["content", "human monk, level 7"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:42:04.145372"], ["updated_at", "2025-11-20 16:42:04.145372"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 38], ["content", "Perfect! I'll create Aeor as a Human Monk and then level them up to 7th level."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", nil], ["created_at", "2025-11-20 16:42:04.148066"], ["updated_at", "2025-11-20 16:42:04.148066"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:78:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA: {type: "dm_response", narrative: "Perfect! I'll create Aeor as a Human Monk and then level them up to 7th level.", tool_results: [{success: false, error: "Validation failed: Campaign must exist, Campaign can't be blank", errors: ["Validation failed: Campaign must exist, Campaign can't be blank"],...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "Perfect! I'll create Aeor as a Human Monk and then level them up to 7th level.", "tool_results" => [{"success" => false, "error" => "Validation failed: Campaign must exist, Campaign can't be blank", "errors" => ["Validation failed: Campaign must exist, Ca... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.7ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddCampaignToTerminalSessions (20251120164727)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.7ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "campaign_id" integer NOT NULL[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddCampaignToTerminalSessions (20251120164727)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.6ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "campaign_id" integer[0m
  [1m[35m (4.3ms)[0m  [1m[35mCREATE INDEX "index_terminal_sessions_on_campaign_id" ON "terminal_sessions" ("campaign_id")[0m
  [1m[35m (8.0ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD CONSTRAINT "fk_rails_14c14a8300"
FOREIGN KEY ("campaign_id")
  REFERENCES "campaigns" ("id")
[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.5ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120164727') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.4ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mTerminalSession Load (1.8ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions"[0m
  [1m[36mCACHE TerminalSession Load (0.0ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions"[0m
  [1m[36mUser Load (1.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:109:in 'TerminalSession#ensure_campaign'
Started GET "/" for ::1 at 2025-11-20 08:51:41 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (15.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_fca60a0f8ff247c2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_fca60a0f8ff247c2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_fca60a0f8ff247c2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.2ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_fca60a0f8ff247c2@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_fca60a0f8ff247c2"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 16:51:41.896026"], ["updated_at", "2025-11-20 16:51:41.896026"], ["encrypted_password", "$2a$12$iMqXbA3c0XyE.klunNZ4fOVyTy4lhJXtd9FE0PaX78oqHkCP/clgu"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:51:41.896026"], ["item_id", 19], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "8d0f9c1e852005709cfa586cb2821430"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17) RETURNING "id"[0m  [["user_id", 19], ["title", "New Adventure"], ["mode", "exploration"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 16:51:41.910078"], ["updated_at", "2025-11-20 16:51:41.910078"], ["session_token", "8d0f9c1e852005709cfa586cb2821430"]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:51:41.910078"], ["item_id", 39], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.8ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_fca60a0f8ff247c2"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 16:51:41.921093"], ["updated_at", "2025-11-20 16:51:41.934013"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 16:51:41.934013"], ["item_id", 1], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Completed 500 Internal Server Error in 326ms (ActiveRecord: 18.0ms | Allocations: 76774)


  
ActiveModel::MissingAttributeError (can't write unknown attribute `campaign_id`):
  
app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
Started GET "/cable" for ::1 at 2025-11-20 08:51:56 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 08:51:56 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 38], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA
TerminalDmChannel is streaming from terminal_session_38
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 38, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 09:06:09 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (3.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (4.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_5ec0a28a925b06a8@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_5ec0a28a925b06a8@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_5ec0a28a925b06a8"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.5ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_5ec0a28a925b06a8@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_5ec0a28a925b06a8"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 17:06:10.013645"], ["updated_at", "2025-11-20 17:06:10.013645"], ["encrypted_password", "$2a$12$pmSIo5C5tWWiGNHmFobcw.Vg6maT6hlSkBHCHfQEsOvPLNGD9Nv0S"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:06:10.013645"], ["item_id", 20], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "68d6dd63ab1c19a2ef1163212da8a00c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 20], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:06:10.046863"], ["updated_at", "2025-11-20 17:06:10.046863"], ["session_token", "68d6dd63ab1c19a2ef1163212da8a00c"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:06:10.046863"], ["item_id", 40], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (3.5ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_5ec0a28a925b06a8"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:06:10.061378"], ["updated_at", "2025-11-20 17:06:10.071044"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:06:10.071044"], ["item_id", 2], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "68d6dd63ab1c19a2ef1163212da8a00c"], ["id", 40], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (3.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:06:10.083616"], ["campaign_id", 2], ["id", 40]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:06:10.083616"], ["item_id", 40], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 40\nuser_id: 20\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:06:10.046863000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:06:10.046863000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:06:10.046863000 Z\nsession_token: 68d6dd63ab1c19a2ef1163212da8a00c\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 40], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 40], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.2ms | Allocations: 1986)
  Rendered layout layouts/terminal.html.erb (Duration: 31.1ms | Allocations: 55334)
Completed 200 OK in 573ms (Views: 32.1ms | ActiveRecord: 75.0ms | Allocations: 467718)


Started GET "/cable" for ::1 at 2025-11-20 09:06:15 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 09:06:15 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 38], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA
TerminalDmChannel is streaming from terminal_session_38
  [1m[36mDmPendingAction Load (2.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:225:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 38, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 09:28:39 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (17.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (5.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_39307b2558c20084@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_39307b2558c20084@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_39307b2558c20084"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_39307b2558c20084@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_39307b2558c20084"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 17:28:40.176736"], ["updated_at", "2025-11-20 17:28:40.176736"], ["encrypted_password", "$2a$12$zBs/.pRDqIO5HXabkXaW4u3BzCjEgm7Vomye88S6Ey2q1Kueve/8O"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:28:40.176736"], ["item_id", 21], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "255463bdbf8a88fc40792ccbbbe91901"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 21], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:28:40.190641"], ["updated_at", "2025-11-20 17:28:40.190641"], ["session_token", "255463bdbf8a88fc40792ccbbbe91901"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:28:40.190641"], ["item_id", 41], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.7ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_39307b2558c20084"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:28:40.200652"], ["updated_at", "2025-11-20 17:28:40.204790"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:28:40.204790"], ["item_id", 3], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "255463bdbf8a88fc40792ccbbbe91901"], ["id", 41], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.8ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:28:40.210480"], ["campaign_id", 3], ["id", 41]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:28:40.210480"], ["item_id", 41], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 41\nuser_id: 21\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:28:40.190641000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:28:40.190641000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:28:40.190641000 Z\nsession_token: 255463bdbf8a88fc40792ccbbbe91901\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 41], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (3.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 41], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 5.2ms | Allocations: 1803)
  Rendered layout layouts/terminal.html.erb (Duration: 32.9ms | Allocations: 38496)
Completed 200 OK in 356ms (Views: 30.8ms | ActiveRecord: 21.4ms | Allocations: 132548)


Started GET "/cable" for ::1 at 2025-11-20 09:28:47 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 09:28:47 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 38], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA
TerminalDmChannel is streaming from terminal_session_38
  [1m[36mDmPendingAction Load (2.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 38], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 38, mode: "exploration", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 09:32:43 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "d4acb29ec66459cb328ffaeda8021e2c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:32:43.630757"], ["updated_at", "2025-11-20 17:32:43.630757"], ["session_token", "d4acb29ec66459cb328ffaeda8021e2c"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:32:43.630757"], ["item_id", 42], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (0.8ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:32:43.634418"], ["updated_at", "2025-11-20 17:32:43.634618"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:32:43.634618"], ["item_id", 4], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "d4acb29ec66459cb328ffaeda8021e2c"], ["id", 42], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (0.9ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:32:43.638747"], ["campaign_id", 4], ["id", 42]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:32:43.638747"], ["item_id", 42], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 42\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:32:43.630757000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:32:43.630757000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:32:43.630757000 Z\nsession_token: d4acb29ec66459cb328ffaeda8021e2c\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 42], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 42], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.1ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.4ms | Allocations: 1377)
Completed 200 OK in 20ms (Views: 1.4ms | ActiveRecord: 5.5ms | Allocations: 16411)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 09:32:43 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi8zOA
TerminalDmChannel stopped streaming from terminal_session_38
Started GET "/cable" for ::1 at 2025-11-20 09:32:43 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 09:32:43 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 42], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Mg
TerminalDmChannel is streaming from terminal_session_42
  [1m[36mDmPendingAction Load (2.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 42], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 42, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 42], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 42], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (2.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 42], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 42], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
TerminalDmChannel error: uninitialized constant NarrativeOutput::Redcarpet
/private/tmp/terminal-dnd/app/app/models/narrative_output.rb:55:in 'NarrativeOutput#render_markdown'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:403:in 'block in ActiveSupport::Callbacks::CallTemplate::MethodCall#make_lambda'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:202:in 'block (2 levels) in ActiveSupport::Callbacks::Filters::Before.halting'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:707:in 'block (2 levels) in ActiveSupport::Callbacks::CallbackChain#default_terminator'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:706:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:706:in 'block in ActiveSupport::Callbacks::CallbackChain#default_terminator'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:203:in 'block in ActiveSupport::Callbacks::Filters::Before.halting'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:598:in 'block in ActiveSupport::Callbacks::CallbackSequence#invoke_before'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:598:in 'Array#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:598:in 'ActiveSupport::Callbacks::CallbackSequence#invoke_before'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:109:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:952:in 'ActiveRecord::Base#_run_save_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/callbacks.rb:441:in 'ActiveRecord::Callbacks#create_or_update'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/timestamp.rb:127:in 'ActiveRecord::Timestamp#create_or_update'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/persistence.rb:751:in 'ActiveRecord::Persistence#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/validations.rb:55:in 'ActiveRecord::Validations#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:313:in 'block in ActiveRecord::Transactions#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:365:in 'block in ActiveRecord::Transactions#with_transaction_returning_status'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:342:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:361:in 'ActiveRecord::Transactions#with_transaction_returning_status'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:313:in 'ActiveRecord::Transactions#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/suppressor.rb:56:in 'ActiveRecord::Suppressor#save!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:371:in 'ActiveRecord::Associations::CollectionAssociation#insert_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:63:in 'ActiveRecord::Associations::HasManyAssociation#insert_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:358:in 'block (2 levels) in ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:462:in 'ActiveRecord::Associations::CollectionAssociation#replace_on_target'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:278:in 'ActiveRecord::Associations::CollectionAssociation#add_to_target'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:357:in 'block in ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:344:in 'ActiveRecord::ConnectionAdapters::DatabaseStatements#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/transactions.rb:212:in 'ActiveRecord::Transactions::ClassMethods#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:314:in 'ActiveRecord::Associations::CollectionAssociation#transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_association.rb:355:in 'ActiveRecord::Associations::CollectionAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/has_many_association.rb:147:in 'ActiveRecord::Associations::HasManyAssociation#_create_record'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/association.rb:211:in 'ActiveRecord::Associations::Association#create!'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/associations/collection_proxy.rb:366:in 'ActiveRecord::Associations::CollectionProxy#create!'
/private/tmp/terminal-dnd/app/app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:39:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Mg: {type: "error", message: "Error processing message: uninitialized constant NarrativeOutput::Redcarpet", timestamp: "2025-11-20T17:32:52Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: uninitialized constant NarrativeOutput::Redcarpet", "timestamp" => "2025-11-20T17:32:52Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Mg)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 09:33:19 -0800
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (2.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_40dd10313023e2d6@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_40dd10313023e2d6@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_40dd10313023e2d6"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.2ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_40dd10313023e2d6@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_40dd10313023e2d6"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 17:33:19.530043"], ["updated_at", "2025-11-20 17:33:19.530043"], ["encrypted_password", "$2a$12$dcqgVrOzu5IchlhdqlLBxuVfviF0VL3xTyFFZJB5PfwsAasHp1Ie2"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:19.530043"], ["item_id", 22], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "43e66470a9be29cbcc4dcbc07ac8c956"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.7ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 22], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:33:19.576606"], ["updated_at", "2025-11-20 17:33:19.576606"], ["session_token", "43e66470a9be29cbcc4dcbc07ac8c956"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:19.576606"], ["item_id", 43], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.4ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_40dd10313023e2d6"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:33:19.594297"], ["updated_at", "2025-11-20 17:33:19.605227"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:19.605227"], ["item_id", 5], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "43e66470a9be29cbcc4dcbc07ac8c956"], ["id", 43], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (2.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:33:19.617142"], ["campaign_id", 5], ["id", 43]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:19.617142"], ["item_id", 43], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 43\nuser_id: 22\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:33:19.576606000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:33:19.576606000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:33:19.576606000 Z\nsession_token: 43e66470a9be29cbcc4dcbc07ac8c956\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 43], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 43], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.9ms | Allocations: 1986)
  Rendered layout layouts/terminal.html.erb (Duration: 96.7ms | Allocations: 63395)
Completed 200 OK in 617ms (Views: 98.4ms | ActiveRecord: 81.3ms | Allocations: 475597)


Started GET "/" for ::1 at 2025-11-20 09:33:24 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (5.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "d2277f29ad81a44f61d846d32f2e512d"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:33:24.342118"], ["updated_at", "2025-11-20 17:33:24.342118"], ["session_token", "d2277f29ad81a44f61d846d32f2e512d"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:24.342118"], ["item_id", 44], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.2ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:33:24.345587"], ["updated_at", "2025-11-20 17:33:24.345868"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:24.345868"], ["item_id", 6], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "d2277f29ad81a44f61d846d32f2e512d"], ["id", 44], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.5ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:33:24.351297"], ["campaign_id", 6], ["id", 44]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (4.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:33:24.351297"], ["item_id", 44], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 44\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:33:24.342118000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:33:24.342118000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:33:24.342118000 Z\nsession_token: d2277f29ad81a44f61d846d32f2e512d\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 44], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 44], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.3ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.6ms | Allocations: 1374)
Completed 200 OK in 34ms (Views: 1.5ms | ActiveRecord: 15.6ms | Allocations: 17585)


Started GET "/cable" for ::1 at 2025-11-20 09:33:24 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 09:33:24 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 44], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA
TerminalDmChannel is streaming from terminal_session_44
  [1m[36mDmPendingAction Load (1.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 44, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 44], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 44], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.9ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "hello"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hello</p>\n"], ["created_at", "2025-11-20 17:33:33.780798"], ["updated_at", "2025-11-20 17:33:33.780798"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "**Welcome, adventurer!** \n\n*The flickering candlelight dances across ancient tomes and scattered dice as you step into my domain. The air hums with possibility and the promise of grand adventures yet to unfold.*\n\nGreetings! I am your **Dungeon Master**, ready to guide you through the realms of imagination and dice rolls. Whether you're looking to:\n\n- **Create a new character** for an epic journey\n- **Continue an existing adventure** \n- **Explore rules and mechanics** of D&D 5th Edition\n- **Begin a quick encounter** or story\n\nI'm here to help bring your tabletop dreams to life! \n\nWhat calls to you today? Are you ready to forge a new hero, or perhaps you have a character already in mind that you'd like to bring into the world?\n\n*The dice await your decision...*"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><strong>Welcome, adventurer!</strong> </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and scattered dice as you step into my domain. The air hums with possibility and the promise of grand adventures yet to unfold.</em></p>\n\n<p>Greetings! I am your <strong>Dungeon Master</strong>, ready to guide you through the realms of imagination and dice rolls. Whether you're looking to:</p>\n\n<ul>\n<li><strong>Create a new character</strong> for an epic journey</li>\n<li><strong>Continue an existing adventure</strong> </li>\n<li><strong>Explore rules and mechanics</strong> of D&amp;D 5th Edition</li>\n<li><strong>Begin a quick encounter</strong> or story</li>\n</ul>\n\n<p>I'm here to help bring your tabletop dreams to life! </p>\n\n<p>What calls to you today? Are you ready to forge a new hero, or perhaps you have a character already in mind that you'd like to bring into the world?</p>\n\n<p><em>The dice await your decision...</em></p>\n"], ["created_at", "2025-11-20 17:33:33.785887"], ["updated_at", "2025-11-20 17:33:33.785887"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA: {type: "dm_response", narrative: "<p><strong>Welcome, adventurer!</strong> </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and scattered dice as you step into my domain. The air hums with possibility and the promise of grand adventures yet to unfold.</em></p>\n\n<p>Greetings...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><strong>Welcome, adventurer!</strong> </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and scattered dice as you step into my domain. The air hums with possibility and the promise of grand adventures yet to unfold.</em></p>\n\n<p>G... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA)
TerminalDmChannel#send_message({"message" => "1"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 44], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 44], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "1"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>1</p>\n"], ["created_at", "2025-11-20 17:33:50.027570"], ["updated_at", "2025-11-20 17:33:50.027570"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "I see you've chosen option **1** - creating a new character! Excellent choice, adventurer.\n\n*The character creation tome opens before you, its pages glowing with potential. Each choice you make will shape the hero who will face the challenges ahead.*\n\nLet's bring your character to life! I'll need a few key details to get started:\n\n**Essential Information:**\n- **Name** - What shall your hero be called?\n- **Race** - Human, Elf, Dwarf, Halfling, Dragonborn, Tiefling, or another race?\n- **Class** - Fighter, Wizard, Rogue, Cleric, Ranger, Barbarian, or another class?\n\n**Optional Details** (we can add these later):\n- **Background** - What was your character's life before adventure?\n- **Ability Scores** - We can roll for these or use standard array\n- **Backstory** - What drives your character forward?\n\n*The quill hovers over parchment, ready to inscribe your hero's legend...*\n\nWhat name, race, and class call out to you for this new character?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I see you've chosen option <strong>1</strong> - creating a new character! Excellent choice, adventurer.</p>\n\n<p><em>The character creation tome opens before you, its pages glowing with potential. Each choice you make will shape the hero who will face the challenges ahead.</em></p>\n\n<p>Let's bring your character to life! I'll need a few key details to get started:</p>\n\n<p><strong>Essential Information:</strong><br>\n- <strong>Name</strong> - What shall your hero be called?<br>\n- <strong>Race</strong> - Human, Elf, Dwarf, Halfling, Dragonborn, Tiefling, or another race?<br>\n- <strong>Class</strong> - Fighter, Wizard, Rogue, Cleric, Ranger, Barbarian, or another class?</p>\n\n<p><strong>Optional Details</strong> (we can add these later):<br>\n- <strong>Background</strong> - What was your character's life before adventure?<br>\n- <strong>Ability Scores</strong> - We can roll for these or use standard array<br>\n- <strong>Backstory</strong> - What drives your character forward?</p>\n\n<p><em>The quill hovers over parchment, ready to inscribe your hero's legend...</em></p>\n\n<p>What name, race, and class call out to you for this new character?</p>\n"], ["created_at", "2025-11-20 17:33:50.033409"], ["updated_at", "2025-11-20 17:33:50.033409"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA: {type: "dm_response", narrative: "<p>I see you've chosen option <strong>1</strong> - creating a new character! Excellent choice, adventurer.</p>\n\n<p><em>The character creation tome opens before you, its pages glowing with potential. Each choice you make will shape the hero who will face the cha...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I see you've chosen option <strong>1</strong> - creating a new character! Excellent choice, adventurer.</p>\n\n<p><em>The character creation tome opens before you, its pages glowing with potential. Each choice you make will shape the hero who will face... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA)
TerminalDmChannel#send_message({"message" => "Aeor the Monk, level 1 Detective searching for his lost family"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 44], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 44], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (2.2ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:174:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (2.6ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Monk"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:175:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (3.2ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Detective"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:176:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:179:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:180:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (2.7ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68) RETURNING "id"[0m  [["name", "Aeor"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 6], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-20 17:34:28.903282"], ["updated_at", "2025-11-20 17:34:28.903282"], ["discarded_at", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:178:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:34:28.903282"], ["item_id", 1], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:178:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'constitution_modifier' for an instance of Character
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_methods.rb:511:in 'ActiveModel::AttributeMethods#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_methods.rb:503:in 'ActiveRecord::AttributeMethods#method_missing'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:197:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.6ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "Aeor the Monk, level 1 Detective searching for his lost family"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>Aeor the Monk, level 1 Detective searching for his lost family</p>\n"], ["created_at", "2025-11-20 17:34:28.911368"], ["updated_at", "2025-11-20 17:34:28.911368"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 44], ["content", "**Aeor the Monk** - what a compelling character concept! \n\n*The parchment begins to fill with details as your character takes shape. A detective monk searching for lost family... there's already a story of determination and mystery brewing.*\n\nLet me bring Aeor into existence:"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><strong>Aeor the Monk</strong> - what a compelling character concept! </p>\n\n<p><em>The parchment begins to fill with details as your character takes shape. A detective monk searching for lost family... there's already a story of determination and mystery brewing.</em></p>\n\n<p>Let me bring Aeor into existence:</p>\n"], ["created_at", "2025-11-20 17:34:28.914659"], ["updated_at", "2025-11-20 17:34:28.914659"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA: {type: "dm_response", narrative: "<p><strong>Aeor the Monk</strong> - what a compelling character concept! </p>\n\n<p><em>The parchment begins to fill with details as your character takes shape. A detective monk searching for lost family... there's already a story of determination and mystery bre...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><strong>Aeor the Monk</strong> - what a compelling character concept! </p>\n\n<p><em>The parchment begins to fill with details as your character takes shape. A detective monk searching for lost family... there's already a story of determination and mys... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA)
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 09:56:47 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA
TerminalDmChannel stopped streaming from terminal_session_44
Started GET "/" for ::1 at 2025-11-20 09:58:55 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (20.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (5.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_dfb4fd37e7e2900c@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_dfb4fd37e7e2900c@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_dfb4fd37e7e2900c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (2.2ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_dfb4fd37e7e2900c@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_dfb4fd37e7e2900c"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 17:58:55.456214"], ["updated_at", "2025-11-20 17:58:55.456214"], ["encrypted_password", "$2a$12$SUchy9Zryln5ZfYNB3RyXuCj5k133rrm2NgaDC3bpCCVyQvKNbM1G"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (2.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:58:55.456214"], ["item_id", 23], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "506da1f41fa5c19f2ca6c4a2f4ba2685"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 23], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 17:58:55.472801"], ["updated_at", "2025-11-20 17:58:55.472801"], ["session_token", "506da1f41fa5c19f2ca6c4a2f4ba2685"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:58:55.472801"], ["item_id", 45], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (2.7ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_dfb4fd37e7e2900c"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 17:58:55.483979"], ["updated_at", "2025-11-20 17:58:55.488459"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:58:55.488459"], ["item_id", 7], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "506da1f41fa5c19f2ca6c4a2f4ba2685"], ["id", 45], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.7ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 17:58:55.495913"], ["campaign_id", 7], ["id", 45]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 17:58:55.495913"], ["item_id", 45], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 45\nuser_id: 23\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 17:58:55.472801000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 17:58:55.472801000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 17:58:55.472801000 Z\nsession_token: 506da1f41fa5c19f2ca6c4a2f4ba2685\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 45], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 45], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.5ms | Allocations: 1803)
  Rendered layout layouts/terminal.html.erb (Duration: 15.3ms | Allocations: 34720)
Completed 200 OK in 343ms (Views: 15.1ms | ActiveRecord: 24.6ms | Allocations: 128821)


DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for ::1 at 2025-11-20 10:15:14 -0800
  [1m[35m (31.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:15:14 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 44], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA
TerminalDmChannel is streaming from terminal_session_44
  [1m[36mDmPendingAction Load (2.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 44], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 44, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 10:15:16 -0800
  [1m[35m (2.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "8ef96f02a19a53f014e83d2f0ca1a35f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.7ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 18:15:16.139203"], ["updated_at", "2025-11-20 18:15:16.139203"], ["session_token", "8ef96f02a19a53f014e83d2f0ca1a35f"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:15:16.139203"], ["item_id", 46], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.3ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 18:15:16.144131"], ["updated_at", "2025-11-20 18:15:16.144349"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:15:16.144349"], ["item_id", 8], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "8ef96f02a19a53f014e83d2f0ca1a35f"], ["id", 46], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.5ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 18:15:16.150337"], ["campaign_id", 8], ["id", 46]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:15:16.150337"], ["item_id", 46], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 46\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 18:15:16.139203000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:15:16.139203000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 18:15:16.139203000 Z\nsession_token: 8ef96f02a19a53f014e83d2f0ca1a35f\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 46], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 46], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.1ms | Allocations: 994)
  Rendered layout layouts/terminal.html.erb (Duration: 2.4ms | Allocations: 1378)
Completed 200 OK in 28ms (Views: 2.2ms | ActiveRecord: 10.4ms | Allocations: 16460)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 10:15:16 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80NA
TerminalDmChannel stopped streaming from terminal_session_44
Started GET "/cable" for ::1 at 2025-11-20 10:15:16 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:15:16 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 46], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 46, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel is streaming from terminal_session_46
Unable to process TerminalDmChannel#load_character
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 46], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (4.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 46], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "hi"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hi</p>\n"], ["created_at", "2025-11-20 18:15:32.649644"], ["updated_at", "2025-11-20 18:15:32.649644"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "Hello there, adventurer! Welcome to our D&D 5th Edition session! \n\n*The flickering candlelight dances across ancient tomes and weathered maps as you step into this realm of endless possibilities.*\n\nI'm your **Dungeon Master**, ready to guide you through epic quests, treacherous dungeons, and memorable encounters. Whether you're a seasoned veteran or new to the world of tabletop RPGs, we'll create an amazing story together!\n\n**What would you like to do?**\n\n- **Create a new character** - Build your hero from scratch with race, class, background, and abilities\n- **Start an adventure** - Jump into a pre-made scenario or let me craft something custom\n- **Learn the basics** - Get familiar with D&D 5e rules and mechanics\n- **Something else** - Tell me what you have in mind!\n\n*The dice await your decision, and destiny calls...*\n\nWhat speaks to your adventurous spirit today?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Hello there, adventurer! Welcome to our D&amp;D 5th Edition session! </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and weathered maps as you step into this realm of endless possibilities.</em></p>\n\n<p>I'm your <strong>Dungeon Master</strong>, ready to guide you through epic quests, treacherous dungeons, and memorable encounters. Whether you're a seasoned veteran or new to the world of tabletop RPGs, we'll create an amazing story together!</p>\n\n<p><strong>What would you like to do?</strong></p>\n\n<ul>\n<li><strong>Create a new character</strong> - Build your hero from scratch with race, class, background, and abilities</li>\n<li><strong>Start an adventure</strong> - Jump into a pre-made scenario or let me craft something custom</li>\n<li><strong>Learn the basics</strong> - Get familiar with D&amp;D 5e rules and mechanics</li>\n<li><strong>Something else</strong> - Tell me what you have in mind!</li>\n</ul>\n\n<p><em>The dice await your decision, and destiny calls...</em></p>\n\n<p>What speaks to your adventurous spirit today?</p>\n"], ["created_at", "2025-11-20 18:15:32.653843"], ["updated_at", "2025-11-20 18:15:32.653843"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng: {type: "dm_response", narrative: "<p>Hello there, adventurer! Welcome to our D&amp;D 5th Edition session! </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and weathered maps as you step into this realm of endless possibilities.</em></p>\n\n<p>I'm your <strong>Dungeon Master</...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Hello there, adventurer! Welcome to our D&amp;D 5th Edition session! </p>\n\n<p><em>The flickering candlelight dances across ancient tomes and weathered maps as you step into this realm of endless possibilities.</em></p>\n\n<p>I'm your <strong>Dungeon ... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng)
Unable to process TerminalDmChannel#load_character
TerminalDmChannel#send_message({"message" => "load a character, Aeor"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 46], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 46], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "load a character, Aeor"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>load a character, Aeor</p>\n"], ["created_at", "2025-11-20 18:15:57.211209"], ["updated_at", "2025-11-20 18:15:57.211209"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "I don't currently have the ability to load existing characters from a saved file or database. The tools available to me are focused on creating new characters and managing active game sessions.\n\n**However, I can help you recreate Aeor!** \n\nIf you'd like to rebuild your character, I can use the character creation tools to set up Aeor with all the details you remember. Just tell me:\n\n- **Race** (Human, Elf, Dwarf, etc.)\n- **Class** (Fighter, Wizard, Rogue, etc.) \n- **Background** (Acolyte, Criminal, Folk Hero, etc.)\n- **Ability Scores** (if you remember them)\n- **Level** (I can level them up after creation)\n- **Equipment and backstory** (I can add these details)\n\n*The ethereal mists swirl as memories of your character begin to take shape...*\n\nWould you like to recreate Aeor from scratch, or do you have another way you'd prefer to proceed? I'm here to make sure we get your character exactly as you envision them!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I don't currently have the ability to load existing characters from a saved file or database. The tools available to me are focused on creating new characters and managing active game sessions.</p>\n\n<p><strong>However, I can help you recreate Aeor!</strong> </p>\n\n<p>If you'd like to rebuild your character, I can use the character creation tools to set up Aeor with all the details you remember. Just tell me:</p>\n\n<ul>\n<li><strong>Race</strong> (Human, Elf, Dwarf, etc.)</li>\n<li><strong>Class</strong> (Fighter, Wizard, Rogue, etc.) </li>\n<li><strong>Background</strong> (Acolyte, Criminal, Folk Hero, etc.)</li>\n<li><strong>Ability Scores</strong> (if you remember them)</li>\n<li><strong>Level</strong> (I can level them up after creation)</li>\n<li><strong>Equipment and backstory</strong> (I can add these details)</li>\n</ul>\n\n<p><em>The ethereal mists swirl as memories of your character begin to take shape...</em></p>\n\n<p>Would you like to recreate Aeor from scratch, or do you have another way you'd prefer to proceed? I'm here to make sure we get your character exactly as you envision them!</p>\n"], ["created_at", "2025-11-20 18:15:57.215170"], ["updated_at", "2025-11-20 18:15:57.215170"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng: {type: "dm_response", narrative: "<p>I don't currently have the ability to load existing characters from a saved file or database. The tools available to me are focused on creating new characters and managing active game sessions.</p>\n\n<p><strong>However, I can help you recreate Aeor!</strong> ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I don't currently have the ability to load existing characters from a saved file or database. The tools available to me are focused on creating new characters and managing active game sessions.</p>\n\n<p><strong>However, I can help you recreate Aeor!</... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng)
TerminalDmChannel#send_message({"message" => "create a random character for me"})
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 46], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:204:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 46], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:243:in 'Enumerable#map'
Tool execution failed: unknown attribute 'execution_time_ms' for DmActionAuditLog.
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:51:in 'ActiveModel::AttributeAssignment#_assign_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:19:in 'block in ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:34:in 'ActiveModel::AttributeAssignment#assign_attributes'
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:333:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "create a random character for me"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>create a random character for me</p>\n"], ["created_at", "2025-11-20 18:16:15.647594"], ["updated_at", "2025-11-20 18:16:15.647594"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 46], ["content", "*The cosmic dice tumble through the astral plane, weaving fate and destiny into mortal form...*\n\nLet me create a unique character for you! I'll roll for some random elements to make this exciting."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><em>The cosmic dice tumble through the astral plane, weaving fate and destiny into mortal form...</em></p>\n\n<p>Let me create a unique character for you! I'll roll for some random elements to make this exciting.</p>\n"], ["created_at", "2025-11-20 18:16:15.650185"], ["updated_at", "2025-11-20 18:16:15.650185"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (2.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng: {type: "dm_response", narrative: "<p><em>The cosmic dice tumble through the astral plane, weaving fate and destiny into mortal form...</em></p>\n\n<p>Let me create a unique character for you! I'll roll for some random elements to make this exciting.</p>\n", is_html: true, tool_results: [{success:...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><em>The cosmic dice tumble through the astral plane, weaving fate and destiny into mortal form...</em></p>\n\n<p>Let me create a unique character for you! I'll roll for some random elements to make this exciting.</p>\n", "is_html" => true, "tool_result... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng)
Started GET "/cable?pp=help" for ::1 at 2025-11-20 10:16:43 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable?pp=help"[non-WebSocket] for ::1 at 2025-11-20 10:16:43 -0800
Failed to upgrade to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, HTTP_UPGRADE: )
Finished "/cable?pp=help"[non-WebSocket] for ::1 at 2025-11-20 10:16:43 -0800
Unsubscribing from channel: {"channel":"TerminalDmChannel","session_id":46}
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng
TerminalDmChannel stopped streaming from terminal_session_46
Started GET "/cable?pp=flamegraph" for ::1 at 2025-11-20 10:16:53 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable?pp=flamegraph"[non-WebSocket] for ::1 at 2025-11-20 10:16:53 -0800
Failed to upgrade to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, HTTP_UPGRADE: )
Finished "/cable?pp=flamegraph"[non-WebSocket] for ::1 at 2025-11-20 10:16:53 -0800
Started GET "/cable" for ::1 at 2025-11-20 10:16:54 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:16:54 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 46], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng
TerminalDmChannel is streaming from terminal_session_46
  [1m[36mDmPendingAction Load (10.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 46], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 46, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 10:17:04 -0800
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 10:17:04 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Ng
TerminalDmChannel stopped streaming from terminal_session_46
Started GET "/" for ::1 at 2025-11-20 10:17:09 -0800
  [1m[35m (2.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "e474cc1411c4d2c14fdd12a01031770c"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 18:17:09.731003"], ["updated_at", "2025-11-20 18:17:09.731003"], ["session_token", "e474cc1411c4d2c14fdd12a01031770c"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:17:09.731003"], ["item_id", 47], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.6ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 18:17:09.736423"], ["updated_at", "2025-11-20 18:17:09.736612"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:17:09.736612"], ["item_id", 9], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "e474cc1411c4d2c14fdd12a01031770c"], ["id", 47], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 18:17:09.743714"], ["campaign_id", 9], ["id", 47]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:17:09.743714"], ["item_id", 47], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 47\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 18:17:09.731003000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:17:09.731003000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 18:17:09.731003000 Z\nsession_token: e474cc1411c4d2c14fdd12a01031770c\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 47], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 47], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.3ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.6ms | Allocations: 1375)
Completed 200 OK in 28ms (Views: 1.5ms | ActiveRecord: 7.1ms | Allocations: 16436)


Started GET "/cable" for ::1 at 2025-11-20 10:17:09 -0800
  [1m[35m (4.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:17:09 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 47], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 47], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Nw
TerminalDmChannel is streaming from terminal_session_47
TerminalDmChannel transmitting {type: "connected", session_id: 47, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddCombatStatsToNpcs (20251120181813)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "strength" integer DEFAULT 10[0m
  [1m[35m (1.2ms)[0m  [1m[35mALTER TABLE "npcs" ADD "dexterity" integer DEFAULT 10[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "npcs" ADD "constitution" integer DEFAULT 10[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "intelligence" integer DEFAULT 10[0m
  [1m[35m (1.2ms)[0m  [1m[35mALTER TABLE "npcs" ADD "wisdom" integer DEFAULT 10[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "npcs" ADD "charisma" integer DEFAULT 10[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "armor_class" integer DEFAULT 10[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "npcs" ADD "hit_points" integer[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "npcs" ADD "max_hit_points" integer[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "hit_dice" character varying[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "level" integer DEFAULT 1[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "npcs" ADD "proficiency_bonus" integer DEFAULT 2[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "npcs" ADD "saving_throws" jsonb DEFAULT '{}'[0m
  [1m[35m (0.7ms)[0m  [1m[35mALTER TABLE "npcs" ADD "skills" jsonb DEFAULT '{}'[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "npcs" ADD "damage_resistances" text[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "damage_immunities" text[0m
  [1m[35m (0.2ms)[0m  [1m[35mALTER TABLE "npcs" ADD "condition_immunities" text[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "npcs" ADD "speed" integer DEFAULT 30[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "challenge_rating" decimal(4,2)[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "initiative" integer[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "npcs" ADD "conditions" text[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120181813') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.4ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (2.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddNpcToCombatParticipants (20251120182001)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.5ms)[0m  [1m[35mALTER TABLE "combat_participants" ADD "npc_id" integer[0m
  [1m[35m (3.1ms)[0m  [1m[35mCREATE INDEX "index_combat_participants_on_npc_id" ON "combat_participants" ("npc_id")[0m
  [1m[35m (5.4ms)[0m  [1m[35mALTER TABLE "combat_participants" ADD CONSTRAINT "fk_rails_064ef7ebdf"
FOREIGN KEY ("npc_id")
  REFERENCES "npcs" ("id")
[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120182001') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.4ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/characters/4/sheet" for ::1 at 2025-11-20 10:40:49 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (13.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/characters/4/sheet"):
  
Started GET "/npm/@kurkle/color@0.3.2/+esm" for ::1 at 2025-11-20 10:40:52 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/npm/@kurkle/color@0.3.2/+esm"):
  
Started GET "/cable" for ::1 at 2025-11-20 10:45:35 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:45:35 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 47], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Nw
TerminalDmChannel is streaming from terminal_session_47
  [1m[36mDmPendingAction Load (1.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 47], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 47, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 10:45:40 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "04d84fcd540d9957f8d8374432238026"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.3ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 18:45:40.549751"], ["updated_at", "2025-11-20 18:45:40.549751"], ["session_token", "04d84fcd540d9957f8d8374432238026"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:45:40.549751"], ["item_id", 48], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.5ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 18:45:40.568551"], ["updated_at", "2025-11-20 18:45:40.576827"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:45:40.576827"], ["item_id", 10], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "04d84fcd540d9957f8d8374432238026"], ["id", 48], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.9ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 18:45:40.590584"], ["campaign_id", 10], ["id", 48]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:45:40.590584"], ["item_id", 48], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 48\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 18:45:40.549751000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:45:40.549751000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 18:45:40.549751000 Z\nsession_token: 04d84fcd540d9957f8d8374432238026\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (2.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 48], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 48], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.1ms | Allocations: 1789)
  Rendered layout layouts/terminal.html.erb (Duration: 12.0ms | Allocations: 35034)
Completed 200 OK in 107ms (Views: 11.6ms | ActiveRecord: 55.5ms | Allocations: 87575)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 10:45:40 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80Nw
TerminalDmChannel stopped streaming from terminal_session_47
Started GET "/cable" for ::1 at 2025-11-20 10:45:40 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:45:40 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 48], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OA
TerminalDmChannel is streaming from terminal_session_48
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 48], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 48, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 10:47:10 -0800
  [1m[35m (1.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "fcedd8d047ab1bede1896b7242b662a1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 18:47:11.017601"], ["updated_at", "2025-11-20 18:47:11.017601"], ["session_token", "fcedd8d047ab1bede1896b7242b662a1"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:11.017601"], ["item_id", 49], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.4ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 18:47:11.022831"], ["updated_at", "2025-11-20 18:47:11.023182"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:11.023182"], ["item_id", 11], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "fcedd8d047ab1bede1896b7242b662a1"], ["id", 49], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.5ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 18:47:11.030582"], ["campaign_id", 11], ["id", 49]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:11.030582"], ["item_id", 49], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 49\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 18:47:11.017601000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:47:11.017601000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 18:47:11.017601000 Z\nsession_token: fcedd8d047ab1bede1896b7242b662a1\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 49], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 49], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.9ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 2.3ms | Allocations: 1374)
Completed 200 OK in 32ms (Views: 2.2ms | ActiveRecord: 8.0ms | Allocations: 16447)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 10:47:11 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OA
TerminalDmChannel stopped streaming from terminal_session_48
Started GET "/cable" for ::1 at 2025-11-20 10:47:11 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 10:47:11 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 49], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel is streaming from terminal_session_49
  [1m[36mDmPendingAction Load (3.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 49, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello, lets make a level 1 monk names aeor, a detective in search of his lost family"})
  [1m[36mCampaign Load (0.5ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 49], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:215:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mDmActionAuditLog Load (1.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 49], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:254:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (2.5ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:178:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (2.5ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Monk"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:179:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (2.3ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Investigator"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:180:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:183:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (2.6ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68) RETURNING "id"[0m  [["name", "Aeor"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 11], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-20 18:47:45.683993"], ["updated_at", "2025-11-20 18:47:45.683993"], ["discarded_at", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:182:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:45.683993"], ["item_id", 2], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:182:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (2.0ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-20 18:47:45.690787"], ["id", 2]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:45.690787"], ["item_id", 2], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 2\nname: Aeor\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 11\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 18:47:45.683993000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:47:45.683993000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 18:47:45.683993000 Z\ndiscarded_at:\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "fcedd8d047ab1bede1896b7242b662a1"], ["id", 49], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:206:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.7ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 2], ["updated_at", "2025-11-20 18:47:45.697807"], ["id", 49]]
  ↳ app/services/ai_dm/tool_executor.rb:206:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 18:47:45.697807"], ["item_id", 49], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 49\ncharacter_id:\nuser_id: 4\nsession_token: fcedd8d047ab1bede1896b7242b662a1\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-20 18:47:11.017601000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 18:47:11.017601000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-20 18:47:11.030582000 Z\n  zone: *1\n  time: 2025-11-20 18:47:11.030582000 Z\ncampaign_id: 11\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:206:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gold' for an instance of Character
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_methods.rb:511:in 'ActiveModel::AttributeMethods#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_methods.rb:503:in 'ActiveRecord::AttributeMethods#method_missing'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:946:in 'AiDm::ToolExecutor#capture_state'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:122:in 'AiDm::ToolExecutor#execute_immediately'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:28:in 'AiDm::ToolExecutor#execute'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:344:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.8ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 49], ["content", "hello, lets make a level 1 monk names aeor, a detective in search of his lost family"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hello, lets make a level 1 monk names aeor, a detective in search of his lost family</p>\n"], ["created_at", "2025-11-20 18:47:45.706026"], ["updated_at", "2025-11-20 18:47:45.706026"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 49], ["content", "Welcome to our D&D adventure! Let me help you create **Aeor**, the detective monk searching for his lost family. This sounds like a compelling character with great story potential!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Welcome to our D&amp;D adventure! Let me help you create <strong>Aeor</strong>, the detective monk searching for his lost family. This sounds like a compelling character with great story potential!</p>\n"], ["created_at", "2025-11-20 18:47:45.709657"], ["updated_at", "2025-11-20 18:47:45.709657"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ: {type: "dm_response", narrative: "<p>Welcome to our D&amp;D adventure! Let me help you create <strong>Aeor</strong>, the detective monk searching for his lost family. This sounds like a compelling character with great story potential!</p>\n", is_html: true, tool_results: [{success: false, error: ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Welcome to our D&amp;D adventure! Let me help you create <strong>Aeor</strong>, the detective monk searching for his lost family. This sounds like a compelling character with great story potential!</p>\n", "is_html" => true, "tool_results" => [{"succes... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (2.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (2.5ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddGoldToCharacters (20251120185117)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.0ms)[0m  [1m[35mALTER TABLE "characters" ADD "gold" integer DEFAULT 0 NOT NULL[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120185117') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 11:02:00 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel stopped streaming from terminal_session_49
Started GET "/cable" for ::1 at 2025-11-20 11:02:01 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (17.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 11:02:01 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (8.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 49], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel is streaming from terminal_session_49
  [1m[36mDmPendingAction Load (3.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 49, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 11:10:43 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel stopped streaming from terminal_session_49
Started GET "/cable" for ::1 at 2025-11-20 11:10:44 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 11:10:44 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 49], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 49, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel is streaming from terminal_session_49
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 11:47:20 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel stopped streaming from terminal_session_49
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCampaign Create (2.1ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Test"], ["description", nil], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 22:27:29.884555"], ["updated_at", "2025-11-20 22:27:29.884555"]]
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 22:27:29.884555"], ["item_id", 12], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[36mUser Exists? (3.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "test@test.com"], ["LIMIT", 1]]
  [1m[36mCACHE User Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "test@test.com"], ["LIMIT", 1]]
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "test"], ["LIMIT", 1]]
  [1m[36mUser Create (1.1ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "test@test.com"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "test"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-20 22:27:30.193461"], ["updated_at", "2025-11-20 22:27:30.193461"], ["encrypted_password", "$2a$12$kyqHxyx1wdJv9l3l1dP09uTWjuTbJcd5cSXQ8yNjzM6cC5n.qmTZW"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", false], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 22:27:30.193461"], ["item_id", 24], ["item_type", "User"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacter Create (5.4ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Hero"], ["level", 5], ["experience", nil], ["proficiency_bonus", nil], ["strength", 16], ["dexterity", 14], ["constitution", 15], ["intelligence", 10], ["wisdom", 12], ["charisma", 8], ["hit_points_current", 40], ["hit_points_max", 40], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 24], ["campaign_id", 12], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-20 22:27:30.254842"], ["updated_at", "2025-11-20 22:27:30.254842"], ["discarded_at", nil], ["gold", 100]]
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 22:27:30.254842"], ["item_id", 3], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mTerminalSession Exists? (2.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "d33e487a6f0b25220e928699c51c9f1e"], ["LIMIT", 1]]
  [1m[36mTerminalSession Create (3.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 24], ["title", nil], ["mode", "exploration"], ["active", true], ["character_id", 3], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 22:27:30.288191"], ["updated_at", "2025-11-20 22:27:30.288191"], ["session_token", "d33e487a6f0b25220e928699c51c9f1e"], ["campaign_id", 12]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 22:27:30.288191"], ["item_id", 50], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCombat Create (3.6ms)[0m  [1m[32mINSERT INTO "combats" ("game_session_id", "status", "current_round", "current_turn", "started_at", "created_at", "updated_at", "discarded_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING "id"[0m  [["game_session_id", nil], ["status", "active"], ["current_round", 3], ["current_turn", 0], ["started_at", nil], ["created_at", "2025-11-20 22:27:30.308386"], ["updated_at", "2025-11-20 22:27:30.308386"], ["discarded_at", nil]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 22:27:30.308386"], ["item_id", 1], ["item_type", "Combat"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterCombatTracker Load (1.2ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 3], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:950:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:950:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 3], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:950:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.8ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 3], ["action_resources", "{}"], ["death_saves", nil], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-20 22:27:30.331098"], ["updated_at", "2025-11-20 22:27:30.331098"]]
  ↳ app/services/ai_dm/tool_executor.rb:950:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:950:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:958:in 'AiDm::ToolExecutor#find_active_combat'
  [1m[36mCombat Load (2.5ms)[0m  [1m[34mSELECT "combats".* FROM "combats" INNER JOIN "combat_participants" ON "combat_participants"."discarded_at" IS NULL AND "combat_participants"."combat_id" = "combats"."id" WHERE "combats"."discarded_at" IS NULL AND "combats"."status" = $1 AND "combat_participants"."character_id" = $2 ORDER BY "combats"."id" ASC LIMIT $3[0m  [["status", "active"], ["character_id", 3], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:959:in 'AiDm::ToolExecutor#find_active_combat'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: unknown attribute 'execution_time_ms' for DmActionAuditLog.
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:51:in 'ActiveModel::AttributeAssignment#_assign_attribute'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:19:in 'block in ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'Hash#each'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_assignment.rb:11:in 'ActiveRecord::AttributeAssignment#_assign_attributes'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_assignment.rb:34:in 'ActiveModel::AttributeAssignment#assign_attributes'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.0ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddExecutionTimeMsToDmActionAuditLogs (20251120222816)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.6ms)[0m  [1m[35mALTER TABLE "dm_action_audit_logs" ADD "execution_time_ms" integer[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120222816') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
Migrating to AddConsequenceTrackingToQuestLogs (20251120223158)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.4ms)[0m  [1m[35mALTER TABLE "quest_logs" ADD "presentation_count" integer DEFAULT 0[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "quest_logs" ADD "last_presented_at" timestamp(6)[0m
  [1m[35m (0.9ms)[0m  [1m[35mALTER TABLE "quest_logs" ADD "consequence_applied" boolean DEFAULT FALSE[0m
  [1m[35m (0.5ms)[0m  [1m[35mALTER TABLE "quest_logs" ADD "escalation_level" integer DEFAULT 0[0m
  [1m[35m (0.3ms)[0m  [1m[35mALTER TABLE "quest_logs" ADD "resolution_type" character varying[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120223158') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Started GET "/cable" for ::1 at 2025-11-20 14:34:35 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (20.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 14:34:35 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.8ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 49], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel is streaming from terminal_session_49
  [1m[36mDmPendingAction Load (2.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 49, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 15:06:27 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel stopped streaming from terminal_session_49
Started GET "/cable" for ::1 at 2025-11-20 15:06:28 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (19.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 15:06:28 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (2.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 49], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel is streaming from terminal_session_49
  [1m[36mDmPendingAction Load (1.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 49], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 49, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 15:07:50 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "21129ccc85cdfaf37925273eb5fefdfc"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.3ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-20 23:07:50.857731"], ["updated_at", "2025-11-20 23:07:50.857731"], ["session_token", "21129ccc85cdfaf37925273eb5fefdfc"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:07:50.857731"], ["item_id", 51], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.9ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-20 23:07:50.868910"], ["updated_at", "2025-11-20 23:07:50.873400"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:07:50.873400"], ["item_id", 13], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "21129ccc85cdfaf37925273eb5fefdfc"], ["id", 51], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.6ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-20 23:07:50.879424"], ["campaign_id", 13], ["id", 51]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:07:50.879424"], ["item_id", 51], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 51\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 23:07:50.857731000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 23:07:50.857731000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 23:07:50.857731000 Z\nsession_token: 21129ccc85cdfaf37925273eb5fefdfc\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 51], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 51], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.9ms | Allocations: 1793)
  Rendered layout layouts/terminal.html.erb (Duration: 15.5ms | Allocations: 35038)
Completed 200 OK in 71ms (Views: 14.5ms | ActiveRecord: 12.6ms | Allocations: 85623)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 15:07:50 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi80OQ
TerminalDmChannel stopped streaming from terminal_session_49
Started GET "/cable" for ::1 at 2025-11-20 15:07:50 -0800
  [1m[35m (1.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 15:07:50 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mCampaign Load (0.3ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 13], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 51], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:216:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (3.0ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 13], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:234:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (3.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 51], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:285:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (3.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:375:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "hi"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hi</p>\n"], ["created_at", "2025-11-20 23:07:59.414208"], ["updated_at", "2025-11-20 23:07:59.414208"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "Hello! Welcome to our D&D 5th Edition adventure! 🎲\n\nI'm your Dungeon Master, ready to guide you through epic tales of heroism, mystery, and magic. Whether you're looking to:\n\n- **Create a new character** for our campaign\n- **Continue an existing adventure** \n- **Explore a new world** filled with danger and wonder\n- **Learn the rules** of D&D 5e\n\nI'm here to help make your tabletop experience memorable!\n\n*The dice are ready, the adventure awaits...*\n\nWhat would you like to do? Are you ready to create a character and begin your journey, or do you have something else in mind?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Hello! Welcome to our D&amp;D 5th Edition adventure! 🎲</p>\n\n<p>I'm your Dungeon Master, ready to guide you through epic tales of heroism, mystery, and magic. Whether you're looking to:</p>\n\n<ul>\n<li><strong>Create a new character</strong> for our campaign</li>\n<li><strong>Continue an existing adventure</strong> </li>\n<li><strong>Explore a new world</strong> filled with danger and wonder</li>\n<li><strong>Learn the rules</strong> of D&amp;D 5e</li>\n</ul>\n\n<p>I'm here to help make your tabletop experience memorable!</p>\n\n<p><em>The dice are ready, the adventure awaits...</em></p>\n\n<p>What would you like to do? Are you ready to create a character and begin your journey, or do you have something else in mind?</p>\n"], ["created_at", "2025-11-20 23:07:59.419686"], ["updated_at", "2025-11-20 23:07:59.419686"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ: {type: "dm_response", narrative: "<p>Hello! Welcome to our D&amp;D 5th Edition adventure! 🎲</p>\n\n<p>I'm your Dungeon Master, ready to guide you through epic tales of heroism, mystery, and magic. Whether you're looking to:</p>\n\n<ul>\n<li><strong>Create a new character</strong> for our campaign...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Hello! Welcome to our D&amp;D 5th Edition adventure! 🎲</p>\n\n<p>I'm your Dungeon Master, ready to guide you through epic tales of heroism, mystery, and magic. Whether you're looking to:</p>\n\n<ul>\n<li><strong>Create a new character</strong> for our ... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ)
TerminalDmChannel#quick_action({"params" => {}})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 51], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:216:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.4ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 13], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:234:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 51], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:285:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:375:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "I quick action."], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I quick action.</p>\n"], ["created_at", "2025-11-20 23:08:09.886697"], ["updated_at", "2025-11-20 23:08:09.886697"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "I'd be happy to help you with a quick action! However, I need a bit more context to assist you properly.\n\nAre you looking to:\n\n- **Make an attack** or cast a spell in combat?\n- **Use a specific ability** or magic item?\n- **Roll dice** for a skill check or saving throw?\n- **Take a game action** like moving, hiding, or interacting with something?\n\nOr did you mean something else by \"quick action\"?\n\n*The moment hangs in anticipation...*\n\nLet me know what you'd like to do, and I'll help make it happen!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'd be happy to help you with a quick action! However, I need a bit more context to assist you properly.</p>\n\n<p>Are you looking to:</p>\n\n<ul>\n<li><strong>Make an attack</strong> or cast a spell in combat?</li>\n<li><strong>Use a specific ability</strong> or magic item?</li>\n<li><strong>Roll dice</strong> for a skill check or saving throw?</li>\n<li><strong>Take a game action</strong> like moving, hiding, or interacting with something?</li>\n</ul>\n\n<p>Or did you mean something else by \"quick action\"?</p>\n\n<p><em>The moment hangs in anticipation...</em></p>\n\n<p>Let me know what you'd like to do, and I'll help make it happen!</p>\n"], ["created_at", "2025-11-20 23:08:09.889618"], ["updated_at", "2025-11-20 23:08:09.889618"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ: {type: "dm_response", narrative: "<p>I'd be happy to help you with a quick action! However, I need a bit more context to assist you properly.</p>\n\n<p>Are you looking to:</p>\n\n<ul>\n<li><strong>Make an attack</strong> or cast a spell in combat?</li>\n<li><strong>Use a specific ability</strong>...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'd be happy to help you with a quick action! However, I need a bit more context to assist you properly.</p>\n\n<p>Are you looking to:</p>\n\n<ul>\n<li><strong>Make an attack</strong> or cast a spell in combat?</li>\n<li><strong>Use a specific ability<... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ)
TerminalDmChannel#send_message({"message" => "lets create a level 1 druid tiefling"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 51], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:216:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.4ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 13], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:234:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 51], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:285:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:191:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (1.1ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Tiefling"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:191:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.8ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Druid"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:192:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:196:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.5ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68) RETURNING "id"[0m  [["name", "Tiefling Druid"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 13], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-20 23:08:44.661137"], ["updated_at", "2025-11-20 23:08:44.661137"], ["discarded_at", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:08:44.661137"], ["item_id", 4], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (1.6ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-20 23:08:44.665354"], ["id", 4]]
  ↳ app/services/ai_dm/tool_executor.rb:213:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:08:44.665354"], ["item_id", 4], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 4\nname: Tiefling Druid\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 13\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-20 23:08:44.661137000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 23:08:44.661137000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-20 23:08:44.661137000 Z\ndiscarded_at:\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:213:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "21129ccc85cdfaf37925273eb5fefdfc"], ["id", 51], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:219:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.7ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 4], ["updated_at", "2025-11-20 23:08:44.671177"], ["id", 51]]
  ↳ app/services/ai_dm/tool_executor.rb:219:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-20 23:08:44.671177"], ["item_id", 51], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 51\ncharacter_id:\nuser_id: 4\nsession_token: 21129ccc85cdfaf37925273eb5fefdfc\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-20 23:07:50.857731000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-20 23:07:50.857731000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-20 23:07:50.879424000 Z\n  zone: *1\n  time: 2025-11-20 23:07:50.879424000 Z\ncampaign_id: 13\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:219:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gold' for an instance of Character
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_methods.rb:511:in 'ActiveModel::AttributeMethods#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_methods.rb:503:in 'ActiveRecord::AttributeMethods#method_missing'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:1017:in 'AiDm::ToolExecutor#capture_state'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:135:in 'AiDm::ToolExecutor#execute_immediately'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:28:in 'AiDm::ToolExecutor#execute'
  [1m[36mDmPendingAction Load (0.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:375:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "lets create a level 1 druid tiefling"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>lets create a level 1 druid tiefling</p>\n"], ["created_at", "2025-11-20 23:08:44.677054"], ["updated_at", "2025-11-20 23:08:44.677054"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 51], ["content", "Excellent choice! A **Tiefling Druid** - what an intriguing combination of infernal heritage and natural magic! 🌿😈"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Excellent choice! A <strong>Tiefling Druid</strong> - what an intriguing combination of infernal heritage and natural magic! 🌿😈</p>\n"], ["created_at", "2025-11-20 23:08:44.679869"], ["updated_at", "2025-11-20 23:08:44.679869"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ: {type: "dm_response", narrative: "<p>Excellent choice! A <strong>Tiefling Druid</strong> - what an intriguing combination of infernal heritage and natural magic! 🌿😈</p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'gold' for an instance of Character", errors: ["unde...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Excellent choice! A <strong>Tiefling Druid</strong> - what an intriguing combination of infernal heritage and natural magic! 🌿😈</p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undefined method 'gold' for an instance of Ch... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ)
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 16:21:43 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 17:16:41 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (32.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 17:16:41 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (2.8ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (2.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 17:29:49 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 17:29:50 -0800
  [1m[35m (44.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 17:29:50 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (1.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 17:43:09 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 17:43:10 -0800
  [1m[35m (22.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 17:43:10 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 18:33:15 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 18:33:15 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (19.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 18:33:15 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (3.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (3.0ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 18:35:19 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 18:35:20 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 18:35:20 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 19:12:43 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 19:12:44 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (14.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:12:44 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (2.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 19:19:30 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel stopped streaming from terminal_session_51
Started GET "/cable" for ::1 at 2025-11-20 19:19:30 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:19:30 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 51], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81MQ
TerminalDmChannel is streaming from terminal_session_51
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 51], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 51, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (2.2ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterInventory Load (2.5ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterInventory Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "character_inventories" WHERE "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterInventory Create (0.8ms)[0m  [1m[32mINSERT INTO "character_inventories" ("character_id", "equipped_items", "inventory_grid", "carry_capacity", "current_weight", "equipment_sets", "active_set", "currency", "created_at", "updated_at", "discarded_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["character_id", 2], ["equipped_items", "{}"], ["inventory_grid", "[]"], ["carry_capacity", 150], ["current_weight", 0], ["equipment_sets", "{}"], ["active_set", nil], ["currency", "{\"cp\":0,\"sp\":0,\"ep\":0,\"gp\":0,\"pp\":0}"], ["created_at", "2025-11-21 03:27:55.515357"], ["updated_at", "2025-11-21 03:27:55.515357"], ["discarded_at", nil]]
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:27:55.515357"], ["item_id", 1], ["item_type", "CharacterInventory"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "character_inventories" WHERE "character_inventories"."character_id" = $1 AND "character_inventories"."id" != $2 LIMIT $3[0m  [["character_id", 2], ["id", 1], ["LIMIT", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Update (0.4ms)[0m  [1m[33mUPDATE "character_inventories" SET "current_weight" = $1, "currency" = $2, "updated_at" = $3 WHERE "character_inventories"."id" = $4[0m  [["current_weight", 10], ["currency", "{\"cp\":0,\"sp\":0,\"ep\":0,\"gp\":500,\"pp\":0}"], ["updated_at", "2025-11-21 03:27:55.536548"], ["id", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:27:55.536548"], ["item_id", 1], ["item_type", "CharacterInventory"], ["event", "update"], ["object", "---\nid: 1\ncharacter_id: 2\nequipped_items: \"{}\"\ninventory_grid: \"[]\"\ncarry_capacity: 150\ncurrent_weight: 0\nequipment_sets: \"{}\"\nactive_set:\ncurrency: '{\"cp\":0,\"sp\":0,\"ep\":0,\"gp\":0,\"pp\":0}'\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:27:55.515357000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:27:55.515357000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:27:55.515357000 Z\ndiscarded_at:\n"]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "character_inventories" WHERE "character_inventories"."character_id" = $1 AND "character_inventories"."id" != $2 LIMIT $3[0m  [["character_id", 2], ["id", 1], ["LIMIT", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Update (0.3ms)[0m  [1m[33mUPDATE "character_inventories" SET "current_weight" = $1, "currency" = $2, "updated_at" = $3 WHERE "character_inventories"."id" = $4[0m  [["current_weight", 12], ["currency", "{\"cp\":0,\"sp\":100,\"ep\":0,\"gp\":500,\"pp\":0}"], ["updated_at", "2025-11-21 03:27:55.541143"], ["id", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:27:55.541143"], ["item_id", 1], ["item_type", "CharacterInventory"], ["event", "update"], ["object", "---\nid: 1\ncharacter_id: 2\nequipped_items: \"{}\"\ninventory_grid: \"[]\"\ncarry_capacity: 150\ncurrent_weight: 10\nequipment_sets: \"{}\"\nactive_set:\ncurrency: '{\"cp\":0,\"sp\":0,\"ep\":0,\"gp\":500,\"pp\":0}'\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:27:55.515357000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:27:55.515357000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:27:55.536548000 Z\n  zone: *1\n  time: 2025-11-21 03:27:55.536548000 Z\ndiscarded_at:\n"]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Exists? (0.6ms)[0m  [1m[34mSELECT 1 AS one FROM "character_inventories" WHERE "character_inventories"."character_id" = $1 AND "character_inventories"."id" != $2 LIMIT $3[0m  [["character_id", 2], ["id", 1], ["LIMIT", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterInventory Update (0.2ms)[0m  [1m[33mUPDATE "character_inventories" SET "currency" = $1, "updated_at" = $2 WHERE "character_inventories"."id" = $3[0m  [["currency", "{\"cp\":0,\"sp\":100,\"ep\":0,\"gp\":500,\"pp\":5}"], ["updated_at", "2025-11-21 03:27:55.544580"], ["id", 1]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:27:55.544580"], ["item_id", 1], ["item_type", "CharacterInventory"], ["event", "update"], ["object", "---\nid: 1\ncharacter_id: 2\nequipped_items: \"{}\"\ninventory_grid: \"[]\"\ncarry_capacity: 150\ncurrent_weight: 12\nequipment_sets: \"{}\"\nactive_set:\ncurrency: '{\"cp\":0,\"sp\":100,\"ep\":0,\"gp\":500,\"pp\":0}'\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:27:55.515357000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:27:55.515357000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:27:55.541143000 Z\n  zone: *1\n  time: 2025-11-21 03:27:55.541143000 Z\ndiscarded_at:\n"]]
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/character_inventory.rb:454:in 'CharacterInventory#add_currency'
  [1m[36mCharacterSpellManager Load (2.1ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterSpellManager Exists? (1.5ms)[0m  [1m[34mSELECT 1 AS one FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Create (1.1ms)[0m  [1m[32mINSERT INTO "character_spell_managers" ("character_id", "spell_slots", "prepared_spells", "known_spells", "ritual_spells", "spell_book", "spellcasting_ability", "spell_save_dc", "spell_attack_bonus", "cantrips_known", "concentration", "lock_version", "sorcery_points_max", "sorcery_points_current", "known_metamagics", "metamagic_options", "wild_magic_surge_count", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19) RETURNING "id"[0m  [["character_id", 2], ["spell_slots", "{}"], ["prepared_spells", "[]"], ["known_spells", "[]"], ["ritual_spells", "[]"], ["spell_book", "[]"], ["spellcasting_ability", "intelligence"], ["spell_save_dc", nil], ["spell_attack_bonus", nil], ["cantrips_known", 4], ["concentration", "{}"], ["lock_version", 0], ["sorcery_points_max", 0], ["sorcery_points_current", 0], ["known_metamagics", "[]"], ["metamagic_options", "{}"], ["wild_magic_surge_count", 0], ["created_at", "2025-11-21 03:27:55.587403"], ["updated_at", "2025-11-21 03:27:55.587403"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (1.2ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterInventory Load (0.8ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.8ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.6ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterCombatTracker Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Create (0.7ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 2], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 03:28:16.098730"], ["updated_at", "2025-11-21 03:28:16.098730"]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (1.0ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterInventory Load (0.7ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.7ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.7ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (1.2ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterInventory Load (0.6ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.8ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.6ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mSpell Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "spells" WHERE "spells"."discarded_at" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.9ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddInventoryPerformanceIndexes (20251120193131)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (4.2ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_inventory_grid" ON "character_inventories" USING gin ("inventory_grid")[0m
  [1m[35m (1.7ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_inventories_on_inventory_grid" IS 'Fast inventory grid searches for items and stacking'[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_equipped_items" ON "character_inventories" USING gin ("equipped_items")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_inventories_on_equipped_items" IS 'Fast equipped items lookups by slot'[0m
  [1m[35m (1.2ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_currency" ON "character_inventories" USING gin ("currency")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_inventories_on_currency" IS 'Fast currency queries for spell material costs'[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_character_inventories_on_equipment_sets" ON "character_inventories" USING gin ("equipment_sets")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_inventories_on_equipment_sets" IS 'Fast equipment set switching and loadout queries'[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_character_combat_trackers_on_action_resources" ON "character_combat_trackers" USING gin ("action_resources")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_combat_trackers_on_action_resources" IS 'Fast action economy and attunement lookups'[0m
  [1m[35m (1.3ms)[0m  [1m[35mCREATE INDEX "index_character_spell_managers_on_spell_slots" ON "character_spell_managers" USING gin ("spell_slots")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_spell_managers_on_spell_slots" IS 'Fast spell slot availability queries'[0m
  [1m[35m (1.7ms)[0m  [1m[35mCREATE INDEX "index_character_spell_managers_on_prepared_spells" ON "character_spell_managers" USING gin ("prepared_spells")[0m
  [1m[35m (0.3ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_spell_managers_on_prepared_spells" IS 'Fast prepared spell lookups'[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_character_spell_managers_on_known_spells" ON "character_spell_managers" USING gin ("known_spells")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_spell_managers_on_known_spells" IS 'Fast known spell queries for Sorcerers/Bards'[0m
  [1m[35m (1.1ms)[0m  [1m[35mCREATE INDEX "index_character_spell_managers_on_concentration" ON "character_spell_managers" USING gin ("concentration")[0m
  [1m[35m (0.3ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_spell_managers_on_concentration" IS 'Fast active concentration spell lookups'[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE INDEX "index_character_spell_managers_on_known_metamagics" ON "character_spell_managers" USING gin ("known_metamagics")[0m
  [1m[35m (0.3ms)[0m  [1m[35mCOMMENT ON INDEX "index_character_spell_managers_on_known_metamagics" IS 'Fast metamagic option queries for Sorcerers'[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.5ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251120193131') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (9.1ms)[0m  [1m[34m
  SELECT tablename, indexname, indexdef 
  FROM pg_indexes 
  WHERE tablename IN ('character_inventories', 'character_spell_managers', 'character_combat_trackers')
  AND indexdef LIKE '%gin%'
  ORDER BY tablename, indexname
[0m
Started GET "/" for ::1 at 2025-11-20 19:36:21 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (19.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (2.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "2842f332dfb9bd036e3993551e93d2c3"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:36:21.515756"], ["updated_at", "2025-11-21 03:36:21.515756"], ["session_token", "2842f332dfb9bd036e3993551e93d2c3"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:36:21.515756"], ["item_id", 52], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (4.0ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:36:21.529103"], ["updated_at", "2025-11-21 03:36:21.533827"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:36:21.533827"], ["item_id", 14], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "2842f332dfb9bd036e3993551e93d2c3"], ["id", 52], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (3.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:36:21.542858"], ["campaign_id", 14], ["id", 52]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:36:21.542858"], ["item_id", 52], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 52\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:36:21.515756000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:36:21.515756000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:36:21.515756000 Z\nsession_token: 2842f332dfb9bd036e3993551e93d2c3\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 52], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 52], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.2ms | Allocations: 1794)
  Rendered layout layouts/terminal.html.erb (Duration: 16.2ms | Allocations: 35039)
Completed 200 OK in 104ms (Views: 15.1ms | ActiveRecord: 23.3ms | Allocations: 119998)


Started GET "/cable" for ::1 at 2025-11-20 19:36:21 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:36:21 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 52], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mg
TerminalDmChannel is streaming from terminal_session_52
  [1m[36mDmPendingAction Load (1.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 52], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 52, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hi"})
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 14], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 52], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 52], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:220:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 14], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:238:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (8.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:36:24.192997') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 52], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:36:24.204845') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 52], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:36:24.206015') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 52], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: undefined method 'world_state' for an instance of Campaign
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_methods.rb:511:in 'ActiveModel::AttributeMethods#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_methods.rb:503:in 'ActiveRecord::AttributeMethods#method_missing'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:317:in 'Narrative::ArcTracker#all_arcs'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:147:in 'Narrative::ArcTracker#active_arcs'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:200:in 'Narrative::ArcTracker#dm_context_message'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:327:in 'AiDm::Orchestrator#narrative_arc_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:146:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mg: {type: "error", message: "Error processing message: undefined method 'world_state' for an instance of Campaign", timestamp: "2025-11-21T03:36:24Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: undefined method 'world_state' for an instance of Campaign", "timestamp" => "2025-11-21T03:36:24Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mg)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (2.6ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (1.4ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.8ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (3.6ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (1.1ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.8ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacterInventory Load (0.4ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCampaign Load (1.0ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (3.3ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (0.6ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.7ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacterInventory Load (0.3ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCampaign Load (1.1ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.4ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (4.0ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (0.7ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.6ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacterInventory Load (0.3ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCampaign Load (0.8ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.3ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (3.5ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (1.0ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.7ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacterInventory Load (0.4ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCampaign Load (2.6ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.4ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (2.6ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (0.9ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.8ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacterInventory Load (0.3ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCampaign Load (0.9ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.4ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 19:45:00 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 19:45:00 -0800
  [1m[35m (16.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (3.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (5.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "acd18a9c74b626ae5056c483a77ebdcf"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:45:00.676635"], ["updated_at", "2025-11-21 03:45:00.676635"], ["session_token", "acd18a9c74b626ae5056c483a77ebdcf"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:00.676635"], ["item_id", 53], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.8ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:45:00.689712"], ["updated_at", "2025-11-21 03:45:00.694040"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:00.694040"], ["item_id", 15], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "acd18a9c74b626ae5056c483a77ebdcf"], ["id", 53], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (2.9ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:45:00.700696"], ["campaign_id", 15], ["id", 53]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:00.700696"], ["item_id", 53], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 53\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:45:00.676635000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:45:00.676635000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:45:00.676635000 Z\nsession_token: acd18a9c74b626ae5056c483a77ebdcf\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (2.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.1ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (2.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 53], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.1ms | Allocations: 1792)
  Rendered layout layouts/terminal.html.erb (Duration: 13.7ms | Allocations: 35037)
Completed 200 OK in 97ms (Views: 12.6ms | ActiveRecord: 22.4ms | Allocations: 119729)


[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" for ::1 at 2025-11-20 19:45:00 -0800
Processing by TerminalController#show as */*
  [1m[35m (18.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:45:00 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (1.7ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 53], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw
TerminalDmChannel is streaming from terminal_session_53
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 53, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_47702b0c5e05f498@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_47702b0c5e05f498@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_47702b0c5e05f498"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.0ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_47702b0c5e05f498@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_47702b0c5e05f498"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 03:45:01.078565"], ["updated_at", "2025-11-21 03:45:01.078565"], ["encrypted_password", "$2a$12$cxjzK3rkxN5fSNqFlM0owOgzPEhkKDDbeO66zWddehJeTM1.3vzCC"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:01.078565"], ["item_id", 25], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "6e1aaf0ef1de29f36c778262e4cdfaaf"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 25], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:45:01.086205"], ["updated_at", "2025-11-21 03:45:01.086205"], ["session_token", "6e1aaf0ef1de29f36c778262e4cdfaaf"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:01.086205"], ["item_id", 54], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.1ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28) RETURNING "id"[0m  [["name", "Terminal Session - guest_47702b0c5e05f498"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:45:01.104854"], ["updated_at", "2025-11-21 03:45:01.113486"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:01.113486"], ["item_id", 16], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "6e1aaf0ef1de29f36c778262e4cdfaaf"], ["id", 54], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.0ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:45:01.122824"], ["campaign_id", 16], ["id", 54]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:45:01.122824"], ["item_id", 54], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 54\nuser_id: 25\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:45:01.086205000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:45:01.086205000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:45:01.086205000 Z\nsession_token: 6e1aaf0ef1de29f36c778262e4cdfaaf\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 54], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 54], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.1ms | Allocations: 1788)
  Rendered layout layouts/terminal.html.erb (Duration: 13.8ms | Allocations: 35031)
Completed 200 OK in 384ms (Views: 14.2ms | ActiveRecord: 50.6ms | Allocations: 160193)


TerminalDmChannel#send_message({"message" => "hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though"})
  [1m[36mCampaign Load (0.9ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 15], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (4.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.2ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 15], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (2.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:45:37.533019') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:45:37.543157') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:45:37.544558') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: undefined method 'world_state' for an instance of Campaign
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activemodel-7.1.6/lib/active_model/attribute_methods.rb:511:in 'ActiveModel::AttributeMethods#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/attribute_methods.rb:503:in 'ActiveRecord::AttributeMethods#method_missing'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:317:in 'Narrative::ArcTracker#all_arcs'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:147:in 'Narrative::ArcTracker#active_arcs'
/private/tmp/terminal-dnd/app/app/services/narrative/arc_tracker.rb:200:in 'Narrative::ArcTracker#dm_context_message'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:329:in 'AiDm::Orchestrator#narrative_arc_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:146:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw: {type: "error", message: "Error processing message: undefined method 'world_state' for an instance of Campaign", timestamp: "2025-11-21T03:45:37Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: undefined method 'world_state' for an instance of Campaign", "timestamp" => "2025-11-21T03:45:37Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.9ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddWorldStateToCampaigns (20251121034622)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.2ms)[0m  [1m[35mALTER TABLE "campaigns" ADD "world_state" jsonb DEFAULT '{}'[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251121034622') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 19:47:00 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_e4855134f3c3f8d5@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_e4855134f3c3f8d5@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_e4855134f3c3f8d5"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.3ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_e4855134f3c3f8d5@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_e4855134f3c3f8d5"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 03:47:01.245856"], ["updated_at", "2025-11-21 03:47:01.245856"], ["encrypted_password", "$2a$12$wlMqaNBkG0Ut6WtA3rykA.LPdiEWZ6R3aOG8KfjpWPGBd7zkW6Zpa"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (2.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:47:01.245856"], ["item_id", 26], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "54c3ee082f565e4c4fb3fb294fd47aa8"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.6ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 26], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:47:01.263946"], ["updated_at", "2025-11-21 03:47:01.263946"], ["session_token", "54c3ee082f565e4c4fb3fb294fd47aa8"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:47:01.263946"], ["item_id", 55], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (2.1ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_e4855134f3c3f8d5"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:47:01.277257"], ["updated_at", "2025-11-21 03:47:01.284707"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:47:01.284707"], ["item_id", 17], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "54c3ee082f565e4c4fb3fb294fd47aa8"], ["id", 55], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.8ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:47:01.295258"], ["campaign_id", 17], ["id", 55]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:47:01.295258"], ["item_id", 55], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 55\nuser_id: 26\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:47:01.263946000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:47:01.263946000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:47:01.263946000 Z\nsession_token: 54c3ee082f565e4c4fb3fb294fd47aa8\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 55], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 55], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.9ms | Allocations: 1789)
  Rendered layout layouts/terminal.html.erb (Duration: 24.1ms | Allocations: 34904)
Completed 200 OK in 383ms (Views: 24.1ms | ActiveRecord: 51.8ms | Allocations: 132988)


Started GET "/cable" for ::1 at 2025-11-20 19:47:12 -0800
  [1m[35m (1.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:47:12 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 53], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw
TerminalDmChannel is streaming from terminal_session_53
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 53, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though"})
  [1m[36mCampaign Load (0.3ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 15], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.9ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 15], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (2.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:47:56.880012') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:47:56.890391') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:47:56.891961') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:372:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (1.2ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Dwarf"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (1.1ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:196:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (1.0ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Soldier"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:197:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (2.4ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Thorin Ironbeard"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 15], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 03:48:02.076106"], ["updated_at", "2025-11-21 03:48:02.076106"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:48:02.076106"], ["item_id", 5], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (1.7ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 03:48:02.082505"], ["id", 5]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:48:02.082505"], ["item_id", 5], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 5\nname: Thorin Ironbeard\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 15\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:48:02.076106000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:48:02.076106000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:48:02.076106000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "acd18a9c74b626ae5056c483a77ebdcf"], ["id", 53], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.6ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 5], ["updated_at", "2025-11-21 03:48:02.089467"], ["id", 53]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:48:02.089467"], ["item_id", 53], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 53\ncharacter_id:\nuser_id: 4\nsession_token: acd18a9c74b626ae5056c483a77ebdcf\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:45:00.676635000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:45:00.676635000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:45:00.700696000 Z\n  zone: *1\n  time: 2025-11-21 03:45:00.700696000 Z\ncampaign_id: 15\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (1.6ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (1.1ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (1.0ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 5], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 03:48:02.117230"], ["updated_at", "2025-11-21 03:48:02.117230"]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (5.5ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 53], ["character_id", 5], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Thorin Ironbeard\",\"race\":\"Dwarf\",\"character_class\":\"Fighter\",\"background\":\"Soldier\"}"], ["result", "{\"success\":true,\"message\":\"Created character Thorin Ironbeard\",\"character\":{\"id\":5,\"name\":\"Thorin Ironbeard\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 0], ["trigger_source", "ai"], ["created_at", "2025-11-21 03:48:02.129634"], ["updated_at", "2025-11-21 03:48:02.129634"], ["execution_time_ms", 82]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_53: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Thorin Ironbeard", character: {id: 5, name: "Thorin Ironbeard", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T03:48:02Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Thorin Ironbeard", "character" => {"id" => 5, "name" => "Thorin Ironbeard", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T03:48:... (via streamed from terminal_session_53)
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:462:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 53], ["content", "hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though</p>\n"], ["created_at", "2025-11-21 03:48:02.141541"], ["updated_at", "2025-11-21 03:48:02.141541"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 53], ["content", "Welcome to our D&D adventure! Let's create your level 4 dwarf warrior. I'll help you build this character step by step.\n\nFirst, let me create the basic character framework. For the name, how about we go with something classic and fitting? I'll suggest **\"Thorin Ironbeard\"** - but feel free to change it to whatever feels right for your character!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Welcome to our D&amp;D adventure! Let's create your level 4 dwarf warrior. I'll help you build this character step by step.</p>\n\n<p>First, let me create the basic character framework. For the name, how about we go with something classic and fitting? I'll suggest <strong>\"Thorin Ironbeard\"</strong> - but feel free to change it to whatever feels right for your character!</p>\n"], ["created_at", "2025-11-21 03:48:02.146720"], ["updated_at", "2025-11-21 03:48:02.146720"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw: {type: "dm_response", narrative: "<p>Welcome to our D&amp;D adventure! Let's create your level 4 dwarf warrior. I'll help you build this character step by step.</p>\n\n<p>First, let me create the basic character framework. For the name, how about we go with something classic and fitting? I'll sug...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Welcome to our D&amp;D adventure! Let's create your level 4 dwarf warrior. I'll help you build this character step by step.</p>\n\n<p>First, let me create the basic character framework. For the name, how about we go with something classic and fitting? ... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw)
TerminalDmChannel#send_message({"message" => "what next?"})
  [1m[36mNarrativeOutput Load (1.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterInventory Load (4.6ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:526:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (2.8ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 5], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.7ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 15], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (1.0ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:48:23.362695') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:48:23.365410') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:48:23.368084') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: World is not a module
/private/tmp/terminal-dnd/app/app/models/world.rb:3: previous definition of World was here
/private/tmp/terminal-dnd/app/app/services/world/faction_reputation_manager.rb:3:in '<main>'
/opt/homebrew/Cellar/ruby/3.4.4/lib/ruby/3.4.0/bundled_gems.rb:82:in 'Kernel.require'
/opt/homebrew/Cellar/ruby/3.4.4/lib/ruby/3.4.0/bundled_gems.rb:82:in 'block (2 levels) in Kernel#replace_require'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/bootsnap-1.19.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in 'Kernel#require'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/zeitwerk-2.7.3/lib/zeitwerk/core_ext/kernel.rb:26:in 'Kernel#require'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:304:in 'AiDm::Orchestrator#faction_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:145:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw: {type: "error", message: "Error processing message: World is not a module\n/private/tmp/terminal-dnd/app/app/models/world.rb:3: previous definition of World was here", timestamp: "2025-11-21T03:48:23Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: World is not a module\n/private/tmp/terminal-dnd/app/app/models/world.rb:3: previous definition of World was here", "timestamp" => "2025-11-21T03:48:23Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw)
Started GET "/" for ::1 at 2025-11-20 19:50:12 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_b2e80dab55138148@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_b2e80dab55138148@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_b2e80dab55138148"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_b2e80dab55138148@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_b2e80dab55138148"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 03:50:12.829225"], ["updated_at", "2025-11-21 03:50:12.829225"], ["encrypted_password", "$2a$12$dboF0CJ1l1Uyv1k50.whAeMfCk/wdOzBQxpLX5peVoF5YBiY.T1KW"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:50:12.829225"], ["item_id", 27], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "a4b724e620c13a80a8b7c51609c7980b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 27], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:50:12.847740"], ["updated_at", "2025-11-21 03:50:12.847740"], ["session_token", "a4b724e620c13a80a8b7c51609c7980b"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:50:12.847740"], ["item_id", 56], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.1ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_b2e80dab55138148"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:50:12.862841"], ["updated_at", "2025-11-21 03:50:12.871902"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:50:12.871902"], ["item_id", 18], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "a4b724e620c13a80a8b7c51609c7980b"], ["id", 56], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:50:12.882034"], ["campaign_id", 18], ["id", 56]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:50:12.882034"], ["item_id", 56], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 56\nuser_id: 27\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:50:12.847740000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:50:12.847740000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:50:12.847740000 Z\nsession_token: a4b724e620c13a80a8b7c51609c7980b\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 56], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.2ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 56], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.2ms | Allocations: 1791)
  Rendered layout layouts/terminal.html.erb (Duration: 12.6ms | Allocations: 35039)
Completed 200 OK in 376ms (Views: 12.7ms | ActiveRecord: 51.6ms | Allocations: 132745)


Started GET "/cable" for ::1 at 2025-11-20 19:50:26 -0800
  [1m[35m (2.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:50:26 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 53], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw
TerminalDmChannel is streaming from terminal_session_53
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 53, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though"})
  [1m[36mCharacter Load (0.3ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL AND "characters"."id" = $1 LIMIT $2[0m  [["id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:11:in 'AiDm::Orchestrator#initialize'
  [1m[36mCampaign Load (0.6ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 15], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterCombatTracker Load (0.2ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:212:in 'AiDm::Orchestrator#conditions_text'
  [1m[36mCharacterInventory Load (0.2ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:526:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (0.3ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 5], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 5], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 15], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:50:34.205302') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:50:34.217035') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:50:34.218218') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: uninitialized constant AiDm::Orchestrator::WorldServices
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:304:in 'AiDm::Orchestrator#faction_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:145:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw: {type: "error", message: "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", timestamp: "2025-11-21T03:50:34Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", "timestamp" => "2025-11-21T03:50:34Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw)
Started GET "/" for ::1 at 2025-11-20 19:52:19 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_0fdd5e06ee7b682e@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_0fdd5e06ee7b682e@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_0fdd5e06ee7b682e"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.1ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_0fdd5e06ee7b682e@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_0fdd5e06ee7b682e"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 03:52:19.322727"], ["updated_at", "2025-11-21 03:52:19.322727"], ["encrypted_password", "$2a$12$Zg9eBWQfNRcEu6Jcp8XMCePH9mMo0iyAjE6Max2iKrZzVX7dSCuMS"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:52:19.322727"], ["item_id", 28], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "9848882c5772bb6551c42b32d45fbd9b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 28], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:52:19.329688"], ["updated_at", "2025-11-21 03:52:19.329688"], ["session_token", "9848882c5772bb6551c42b32d45fbd9b"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:52:19.329688"], ["item_id", 57], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.0ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_0fdd5e06ee7b682e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:52:19.333174"], ["updated_at", "2025-11-21 03:52:19.333447"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:52:19.333447"], ["item_id", 19], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "9848882c5772bb6551c42b32d45fbd9b"], ["id", 57], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.2ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:52:19.338324"], ["campaign_id", 19], ["id", 57]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:52:19.338324"], ["item_id", 57], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 57\nuser_id: 28\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:52:19.329688000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:52:19.329688000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:52:19.329688000 Z\nsession_token: 9848882c5772bb6551c42b32d45fbd9b\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 57], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 57], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.1ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.3ms | Allocations: 1377)
Completed 200 OK in 268ms (Views: 1.2ms | ActiveRecord: 10.0ms | Allocations: 23657)


DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCampaign Load (1.0ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL ORDER BY "campaigns"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacter Load (3.6ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCACHE Campaign Load (0.0ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL ORDER BY "campaigns"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacter Load (0.5ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterCombatTracker Load (0.8ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/rules_validation_service.rb:98:in 'AiDm::RulesValidationService#validate_action'
  [1m[36mCharacter Load (0.7ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterInventory Load (0.4ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacter Load (0.9ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCharacterSpellManager Load (0.4ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCharacter Load (0.9ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_combat_trackers" ON "character_combat_trackers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCACHE CharacterCombatTracker Load (0.0ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  [1m[36mCACHE Character Load (0.0ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mSpell Load (1.1ms)[0m  [1m[34mSELECT "spells".* FROM "spells" WHERE "spells"."discarded_at" IS NULL ORDER BY "spells"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCACHE Character Load (0.0ms)[0m  [1m[34mSELECT "characters".* FROM "characters" INNER JOIN "character_inventories" ON "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = "characters"."id" INNER JOIN "character_spell_managers" ON "character_spell_managers"."character_id" = "characters"."id" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 11], ["LIMIT", 1]]
  [1m[36mCACHE CharacterCombatTracker Load (0.0ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:212:in 'AiDm::Orchestrator#conditions_text'
  [1m[36mCACHE CharacterInventory Load (0.0ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:526:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCACHE CharacterSpellManager Load (0.0ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 2], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
TerminalDmChannel#send_message({"message" => "hello, lets create a new level 4 warrior dwarf with an axe. IDK what to call him though"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 53], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 53], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.2ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 5], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 15], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:54:03.285705') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:54:03.286920') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:54:03.287869') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 53], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: uninitialized constant AiDm::Orchestrator::WorldServices
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:304:in 'AiDm::Orchestrator#faction_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:145:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw: {type: "error", message: "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", timestamp: "2025-11-21T03:54:03Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", "timestamp" => "2025-11-21T03:54:03Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw)
Started GET "/" for ::1 at 2025-11-20 19:54:06 -0800
  [1m[35m (2.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "9f81b1f41fbb8f9c4bfe93873836f04f"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (3.2ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:54:06.542020"], ["updated_at", "2025-11-21 03:54:06.542020"], ["session_token", "9f81b1f41fbb8f9c4bfe93873836f04f"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:06.542020"], ["item_id", 58], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (2.3ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:54:06.549386"], ["updated_at", "2025-11-21 03:54:06.549793"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (19.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:06.549793"], ["item_id", 20], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "9f81b1f41fbb8f9c4bfe93873836f04f"], ["id", 58], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.3ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:54:06.576858"], ["campaign_id", 20], ["id", 58]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:06.576858"], ["item_id", 58], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 58\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:54:06.542020000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:54:06.542020000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:54:06.542020000 Z\nsession_token: 9f81b1f41fbb8f9c4bfe93873836f04f\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 58], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.0ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 58], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.5ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.8ms | Allocations: 1374)
Completed 200 OK in 55ms (Views: 1.7ms | ActiveRecord: 11.9ms | Allocations: 16450)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 19:54:06 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81Mw
TerminalDmChannel stopped streaming from terminal_session_53
Started GET "/cable" for ::1 at 2025-11-20 19:54:06 -0800
  [1m[35m (2.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:54:06 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 58], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA
TerminalDmChannel is streaming from terminal_session_58
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 58], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 58, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "lets roll an elf mage"})
  [1m[36mCampaign Load (0.8ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 20], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 58], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.9ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 58], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (1.0ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 20], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:54:27.151070') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:54:27.153012') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:54:27.155038') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:372:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (0.9ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Elf"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.6ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Wizard"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:196:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.1ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Elf Mage"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 20], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 03:54:30.723714"], ["updated_at", "2025-11-21 03:54:30.723714"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:30.723714"], ["item_id", 6], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (0.6ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 03:54:30.729064"], ["id", 6]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:30.729064"], ["item_id", 6], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 6\nname: Elf Mage\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 20\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:54:30.723714000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:54:30.723714000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:54:30.723714000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "9f81b1f41fbb8f9c4bfe93873836f04f"], ["id", 58], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.6ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 6], ["updated_at", "2025-11-21 03:54:30.734515"], ["id", 58]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:54:30.734515"], ["item_id", 58], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 58\ncharacter_id:\nuser_id: 4\nsession_token: 9f81b1f41fbb8f9c4bfe93873836f04f\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:54:06.542020000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:54:06.542020000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:54:06.576858000 Z\n  zone: *1\n  time: 2025-11-21 03:54:06.576858000 Z\ncampaign_id: 20\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (0.8ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (1.3ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.5ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 6], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 03:54:30.744853"], ["updated_at", "2025-11-21 03:54:30.744853"]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (2.4ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 58], ["character_id", 6], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Elf Mage\",\"race\":\"Elf\",\"character_class\":\"Wizard\"}"], ["result", "{\"success\":true,\"message\":\"Created character Elf Mage\",\"character\":{\"id\":6,\"name\":\"Elf Mage\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 0], ["trigger_source", "ai"], ["created_at", "2025-11-21 03:54:30.747785"], ["updated_at", "2025-11-21 03:54:30.747785"], ["execution_time_ms", 48]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_58: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Elf Mage", character: {id: 6, name: "Elf Mage", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T03:54:30Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Elf Mage", "character" => {"id" => 6, "name" => "Elf Mage", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T03:54:30Z"} (via streamed from terminal_session_58)
  [1m[36mDmPendingAction Load (1.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 58], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:462:in 'Enumerable#map'
  [1m[36mTRANSACTION (3.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 58], ["content", "lets roll an elf mage"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>lets roll an elf mage</p>\n"], ["created_at", "2025-11-21 03:54:30.755557"], ["updated_at", "2025-11-21 03:54:30.755557"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.8ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 58], ["content", "I'll help you create an elf mage! Let me set up your character with the classic combination."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll help you create an elf mage! Let me set up your character with the classic combination.</p>\n"], ["created_at", "2025-11-21 03:54:30.761223"], ["updated_at", "2025-11-21 03:54:30.761223"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA: {type: "dm_response", narrative: "<p>I'll help you create an elf mage! Let me set up your character with the classic combination.</p>\n", is_html: true, tool_results: [{success: true, message: "Created character Elf Mage", character: {id: 6, name: "Elf Mage", race: nil, class: nil, level: 1, hp: ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll help you create an elf mage! Let me set up your character with the classic combination.</p>\n", "is_html" => true, "tool_results" => [{"success" => true, "message" => "Created character Elf Mage", "character" => {"id" => 6, "name" => "Elf Mage", "... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA)
TerminalDmChannel#send_message({"message" => "what's next?"})
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 58], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterInventory Load (0.6ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:526:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (0.4ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 58], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 6], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.7ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 20], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (3.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:54:55.625045') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (1.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:54:55.630178') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (2.0ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:54:55.632940') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 58], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: uninitialized constant AiDm::Orchestrator::WorldServices
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:304:in 'AiDm::Orchestrator#faction_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:145:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA: {type: "error", message: "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", timestamp: "2025-11-21T03:54:55Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", "timestamp" => "2025-11-21T03:54:55Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA)
Started GET "/" for ::1 at 2025-11-20 19:57:13 -0800
  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_802c29151fa488ff@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_802c29151fa488ff@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_802c29151fa488ff"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.0ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_802c29151fa488ff@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_802c29151fa488ff"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 03:57:14.183086"], ["updated_at", "2025-11-21 03:57:14.183086"], ["encrypted_password", "$2a$12$rDSj10TOkcOJTt2k5VMSH.1BrQWYHHpeemM/gvrohKyuw.D.SRe4K"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:57:14.183086"], ["item_id", 29], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.6ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "aeced737af69dcd492b6d44bf47806b9"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 29], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:57:14.190226"], ["updated_at", "2025-11-21 03:57:14.190226"], ["session_token", "aeced737af69dcd492b6d44bf47806b9"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:57:14.190226"], ["item_id", 59], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (0.9ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_802c29151fa488ff"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:57:14.193118"], ["updated_at", "2025-11-21 03:57:14.193361"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:57:14.193361"], ["item_id", 21], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "aeced737af69dcd492b6d44bf47806b9"], ["id", 59], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (0.9ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:57:14.197789"], ["campaign_id", 21], ["id", 59]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:57:14.197789"], ["item_id", 59], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 59\nuser_id: 29\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:57:14.190226000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:57:14.190226000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:57:14.190226000 Z\nsession_token: aeced737af69dcd492b6d44bf47806b9\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 59], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 59], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.3ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.6ms | Allocations: 1377)
Completed 200 OK in 268ms (Views: 1.5ms | ActiveRecord: 8.2ms | Allocations: 23649)


Started GET "/" for ::1 at 2025-11-20 19:58:43 -0800
  [1m[35m (2.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "3ecb700a3ec2ffeb8bf3f27db04fa8d2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 03:58:43.068854"], ["updated_at", "2025-11-21 03:58:43.068854"], ["session_token", "3ecb700a3ec2ffeb8bf3f27db04fa8d2"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:58:43.068854"], ["item_id", 60], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (0.8ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 03:58:43.073637"], ["updated_at", "2025-11-21 03:58:43.073866"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:58:43.073866"], ["item_id", 22], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "3ecb700a3ec2ffeb8bf3f27db04fa8d2"], ["id", 60], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.0ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 03:58:43.078570"], ["campaign_id", 22], ["id", 60]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:58:43.078570"], ["item_id", 60], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 60\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:58:43.068854000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:58:43.068854000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:58:43.068854000 Z\nsession_token: 3ecb700a3ec2ffeb8bf3f27db04fa8d2\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 60], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.0ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 60], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:71:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.5ms | Allocations: 990)
  Rendered layout layouts/terminal.html.erb (Duration: 1.7ms | Allocations: 1374)
Completed 200 OK in 22ms (Views: 1.4ms | ActiveRecord: 7.3ms | Allocations: 16448)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 19:58:43 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi81OA
TerminalDmChannel stopped streaming from terminal_session_58
Started GET "/cable" for ::1 at 2025-11-20 19:58:43 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 19:58:43 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 60], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 60], ["status", "pending"]]
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA
TerminalDmChannel is streaming from terminal_session_60
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 60, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "create me an unusual character"})
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 22], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 60], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 60], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 22], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:59:02.581233') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:59:02.582109') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:59:02.582728') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:372:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.6ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Kenku"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:195:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Druid"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:196:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (0.5ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Hermit"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:197:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.2ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Whisper Thornweave"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 22], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 03:59:06.732784"], ["updated_at", "2025-11-21 03:59:06.732784"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:59:06.732784"], ["item_id", 7], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (0.6ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 03:59:06.739668"], ["id", 7]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:59:06.739668"], ["item_id", 7], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 7\nname: Whisper Thornweave\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 22\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 03:59:06.732784000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:59:06.732784000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 03:59:06.732784000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:217:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "3ecb700a3ec2ffeb8bf3f27db04fa8d2"], ["id", 60], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.8ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 7], ["updated_at", "2025-11-21 03:59:06.748700"], ["id", 60]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 03:59:06.748700"], ["item_id", 60], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 60\ncharacter_id:\nuser_id: 4\nsession_token: 3ecb700a3ec2ffeb8bf3f27db04fa8d2\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:58:43.068854000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 03:58:43.068854000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 03:58:43.078570000 Z\n  zone: *1\n  time: 2025-11-21 03:58:43.078570000 Z\ncampaign_id: 22\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:223:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (0.4ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 7], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (1.6ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 7], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.6ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 7], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 03:59:06.760370"], ["updated_at", "2025-11-21 03:59:06.760370"]]
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1103:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (1.8ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 60], ["character_id", 7], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Whisper Thornweave\",\"race\":\"Kenku\",\"character_class\":\"Druid\",\"background\":\"Hermit\"}"], ["result", "{\"success\":true,\"message\":\"Created character Whisper Thornweave\",\"character\":{\"id\":7,\"name\":\"Whisper Thornweave\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 0], ["trigger_source", "ai"], ["created_at", "2025-11-21 03:59:06.763618"], ["updated_at", "2025-11-21 03:59:06.763618"], ["execution_time_ms", 37]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_60: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Whisper Thornweave", character: {id: 7, name: "Whisper Thornweave", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T03:59:06Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Whisper Thornweave", "character" => {"id" => 7, "name" => "Whisper Thornweave", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T03... (via streamed from terminal_session_60)
  [1m[36mDmPendingAction Load (0.9ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 60], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:462:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 60], ["content", "create me an unusual character"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>create me an unusual character</p>\n"], ["created_at", "2025-11-21 03:59:06.771285"], ["updated_at", "2025-11-21 03:59:06.771285"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 60], ["content", "I'll create an unusual and intriguing character for you! Let me craft something unique that will make for interesting roleplay."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll create an unusual and intriguing character for you! Let me craft something unique that will make for interesting roleplay.</p>\n"], ["created_at", "2025-11-21 03:59:06.777654"], ["updated_at", "2025-11-21 03:59:06.777654"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA: {type: "dm_response", narrative: "<p>I'll create an unusual and intriguing character for you! Let me craft something unique that will make for interesting roleplay.</p>\n", is_html: true, tool_results: [{success: true, message: "Created character Whisper Thornweave", character: {id: 7, name: "Whi...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll create an unusual and intriguing character for you! Let me craft something unique that will make for interesting roleplay.</p>\n", "is_html" => true, "tool_results" => [{"success" => true, "message" => "Created character Whisper Thornweave", "char... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA)
TerminalDmChannel#send_message({"message" => "what next?"})
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 60], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterInventory Load (0.8ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 7], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:526:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (0.5ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 7], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:572:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.9ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 60], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:222:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 7], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:223:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.6ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 22], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:240:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:59:25.851511') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-20 23:59:25.853714') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-20 23:59:25.855417') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 60], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
TerminalDmChannel error: uninitialized constant AiDm::Orchestrator::WorldServices
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:304:in 'AiDm::Orchestrator#faction_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:145:in 'AiDm::Orchestrator#build_dm_context'
/private/tmp/terminal-dnd/app/app/services/ai_dm/orchestrator.rb:24:in 'AiDm::Orchestrator#process_message'
/private/tmp/terminal-dnd/app/app/channels/terminal_dm_channel.rb:36:in 'TerminalDmChannel#send_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'Kernel#public_send'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:273:in 'ActionCable::Channel::Base#dispatch_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:173:in 'block in ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'block in ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications/instrumenter.rb:58:in 'ActiveSupport::Notifications::Instrumenter#instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/notifications.rb:206:in 'ActiveSupport::Notifications.instrument'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/channel/base.rb:172:in 'ActionCable::Channel::Base#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:58:in 'ActionCable::Connection::Subscriptions#perform_action'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/subscriptions.rb:21:in 'ActionCable::Connection::Subscriptions#execute_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:100:in 'block in ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:101:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:99:in 'ActionCable::Connection::Base#handle_channel_command'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/base.rb:92:in 'ActionCable::Connection::Base#dispatch_websocket_message'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:58:in 'block in ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:121:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'block in ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:39:in 'ActiveSupport::TaggedLogging::Formatter#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/tagged_logging.rb:139:in 'ActiveSupport::TaggedLogging#tagged'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/broadcast_logger.rb:241:in 'ActiveSupport::BroadcastLogger#method_missing'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/connection/tagged_logger_proxy.rb:26:in 'ActionCable::Connection::TaggedLoggerProxy#tag'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker/active_record_connection_management.rb:16:in 'ActionCable::Server::Worker::ActiveRecordConnectionManagement#with_database_connections'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:79:in 'block (4 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/execution_wrapper.rb:92:in 'ActiveSupport::ExecutionWrapper.wrap'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/engine.rb:74:in 'block (3 levels) in <class:Engine>'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'BasicObject#instance_exec'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:130:in 'block in ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/callbacks.rb:141:in 'ActiveSupport::Callbacks#run_callbacks'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:41:in 'ActionCable::Server::Worker#work'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:57:in 'ActionCable::Server::Worker#invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/actioncable-7.1.6/lib/action_cable/server/worker.rb:52:in 'block in ActionCable::Server::Worker#async_invoke'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:359:in 'Concurrent::RubyThreadPoolExecutor::Worker#run_task'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:350:in 'block (3 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
<internal:kernel>:168:in 'Kernel#loop'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:341:in 'block (2 levels) in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'Kernel#catch'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/concurrent-ruby-1.3.5/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:340:in 'block in Concurrent::RubyThreadPoolExecutor::Worker#create_worker'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA: {type: "error", message: "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", timestamp: "2025-11-21T03:59:25Z"}
TerminalDmChannel transmitting {"type" => "error", "message" => "Error processing message: uninitialized constant AiDm::Orchestrator::WorldServices", "timestamp" => "2025-11-21T03:59:25Z"} (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA)
Started GET "/" for ::1 at 2025-11-20 20:08:35 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (14.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (3.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_c9918691ca1e51e1@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_c9918691ca1e51e1@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_c9918691ca1e51e1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.0ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_c9918691ca1e51e1@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_c9918691ca1e51e1"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 04:08:35.916225"], ["updated_at", "2025-11-21 04:08:35.916225"], ["encrypted_password", "$2a$12$bsI6gqjtOmAYFyHZlst2zexw9mVGQtLw5FDHtLhaApyOV/.jN4HM2"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:08:35.916225"], ["item_id", 30], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "6584bd385437c694a3d3781a385693c1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 30], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:08:35.929116"], ["updated_at", "2025-11-21 04:08:35.929116"], ["session_token", "6584bd385437c694a3d3781a385693c1"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:08:35.929116"], ["item_id", 61], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.4ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_c9918691ca1e51e1"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:08:35.939833"], ["updated_at", "2025-11-21 04:08:35.944411"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:08:35.944411"], ["item_id", 23], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "6584bd385437c694a3d3781a385693c1"], ["id", 61], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.6ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:08:35.950455"], ["campaign_id", 23], ["id", 61]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:08:35.950455"], ["item_id", 61], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 61\nuser_id: 30\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:08:35.929116000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:08:35.929116000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:08:35.929116000 Z\nsession_token: 6584bd385437c694a3d3781a385693c1\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 61], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.4ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 61], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.0ms | Allocations: 2034)
  Rendered layout layouts/terminal.html.erb (Duration: 17.5ms | Allocations: 37369)
Completed 200 OK in 341ms (Views: 17.4ms | ActiveRecord: 14.9ms | Allocations: 131507)


Started GET "/cable" for ::1 at 2025-11-20 20:08:47 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:08:47 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.7ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 60], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA
TerminalDmChannel is streaming from terminal_session_60
  [1m[36mDmPendingAction Load (2.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 60], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 60, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/" for ::1 at 2025-11-20 20:09:46 -0800
  [1m[35m (3.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "b5eb935264f82520fb927b11c643bc0b"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.1ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 4], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:09:46.234155"], ["updated_at", "2025-11-21 04:09:46.234155"], ["session_token", "b5eb935264f82520fb927b11c643bc0b"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:09:46.234155"], ["item_id", 62], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (0.8ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_783526d0aba7998e"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:09:46.237636"], ["updated_at", "2025-11-21 04:09:46.237896"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:09:46.237896"], ["item_id", 24], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "b5eb935264f82520fb927b11c643bc0b"], ["id", 62], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.0ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:09:46.243340"], ["campaign_id", 24], ["id", 62]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:09:46.243340"], ["item_id", 62], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 62\nuser_id: 4\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:09:46.234155000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:09:46.234155000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:09:46.234155000 Z\nsession_token: b5eb935264f82520fb927b11c643bc0b\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (5.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 62], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 62], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.4ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.6ms | Allocations: 1375)
Completed 200 OK in 27ms (Views: 1.5ms | ActiveRecord: 11.3ms | Allocations: 16467)


Finished "/cable" [WebSocket] for ::1 at 2025-11-20 20:09:46 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82MA
TerminalDmChannel stopped streaming from terminal_session_60
Started GET "/cable" for ::1 at 2025-11-20 20:09:46 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:09:46 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.7ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 62], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel is streaming from terminal_session_62
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:226:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 62, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "create me a Dragonborn fighter"})
  [1m[36mCampaign Load (0.6ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 24], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 62], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.0ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 24], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (2.1ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:10:08.997278') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (1.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:10:09.002413') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:10:09.004519') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.9ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Dragonborn"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (1.2ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (2.1ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Dragonborn Fighter"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 24], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:10:12.359184"], ["updated_at", "2025-11-21 04:10:12.359184"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:10:12.359184"], ["item_id", 8], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (1.4ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 04:10:12.364980"], ["id", 8]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:10:12.364980"], ["item_id", 8], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 8\nname: Dragonborn Fighter\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 24\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:10:12.359184000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:10:12.359184000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:10:12.359184000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "b5eb935264f82520fb927b11c643bc0b"], ["id", 62], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.8ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 8], ["updated_at", "2025-11-21 04:10:12.370233"], ["id", 62]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:10:12.370233"], ["item_id", 62], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 62\ncharacter_id:\nuser_id: 4\nsession_token: b5eb935264f82520fb927b11c643bc0b\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:09:46.234155000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:09:46.234155000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:09:46.243340000 Z\n  zone: *1\n  time: 2025-11-21 04:09:46.243340000 Z\ncampaign_id: 24\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (1.3ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (1.1ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.6ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 8], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 04:10:12.383999"], ["updated_at", "2025-11-21 04:10:12.383999"]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (1.8ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 62], ["character_id", 8], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Dragonborn Fighter\",\"race\":\"Dragonborn\",\"character_class\":\"Fighter\"}"], ["result", "{\"success\":true,\"message\":\"Created character Dragonborn Fighter\",\"character\":{\"id\":8,\"name\":\"Dragonborn Fighter\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 0], ["trigger_source", "ai"], ["created_at", "2025-11-21 04:10:12.388587"], ["updated_at", "2025-11-21 04:10:12.388587"], ["execution_time_ms", 40]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_62: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Dragonborn Fighter", character: {id: 8, name: "Dragonborn Fighter", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T04:10:12Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Dragonborn Fighter", "character" => {"id" => 8, "name" => "Dragonborn Fighter", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T04... (via streamed from terminal_session_62)
  [1m[36mDmPendingAction Load (4.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 62], ["content", "create me a Dragonborn fighter"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>create me a Dragonborn fighter</p>\n"], ["created_at", "2025-11-21 04:10:12.403673"], ["updated_at", "2025-11-21 04:10:12.403673"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.8ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 62], ["content", "I'll create a Dragonborn Fighter character for you! Let me set up the basic framework, and then we can customize the details."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll create a Dragonborn Fighter character for you! Let me set up the basic framework, and then we can customize the details.</p>\n"], ["created_at", "2025-11-21 04:10:12.408577"], ["updated_at", "2025-11-21 04:10:12.408577"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg: {type: "dm_response", narrative: "<p>I'll create a Dragonborn Fighter character for you! Let me set up the basic framework, and then we can customize the details.</p>\n", is_html: true, tool_results: [{success: true, message: "Created character Dragonborn Fighter", character: {id: 8, name: "Drago...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll create a Dragonborn Fighter character for you! Let me set up the basic framework, and then we can customize the details.</p>\n", "is_html" => true, "tool_results" => [{"success" => true, "message" => "Created character Dragonborn Fighter", "charac... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacter Load (1.2ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL ORDER BY "characters"."id" DESC LIMIT $1[0m  [["LIMIT", 1]]
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 20:15:31 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (3.9ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_52bd1ca9123e904a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_52bd1ca9123e904a@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_52bd1ca9123e904a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (0.9ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_52bd1ca9123e904a@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_52bd1ca9123e904a"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 04:15:32.002635"], ["updated_at", "2025-11-21 04:15:32.002635"], ["encrypted_password", "$2a$12$vuNkLGMGOd.7sWyUHkpfy.WRfb8VSqAl3.pg7WBekwRHhrNTOsOHS"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:15:32.002635"], ["item_id", 31], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "74868d542d1f76abb77a5db0304cde94"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (0.9ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 31], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:15:32.020466"], ["updated_at", "2025-11-21 04:15:32.020466"], ["session_token", "74868d542d1f76abb77a5db0304cde94"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:15:32.020466"], ["item_id", 63], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.0ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_52bd1ca9123e904a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:15:32.033429"], ["updated_at", "2025-11-21 04:15:32.040212"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:15:32.040212"], ["item_id", 25], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "74868d542d1f76abb77a5db0304cde94"], ["id", 63], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (0.9ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:15:32.050355"], ["campaign_id", 25], ["id", 63]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:15:32.050355"], ["item_id", 63], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 63\nuser_id: 31\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:15:32.020466000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:15:32.020466000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:15:32.020466000 Z\nsession_token: 74868d542d1f76abb77a5db0304cde94\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 63], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.7ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 63], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.1ms | Allocations: 2017)
  Rendered layout layouts/terminal.html.erb (Duration: 15.8ms | Allocations: 37340)
Completed 200 OK in 377ms (Views: 16.3ms | ActiveRecord: 49.5ms | Allocations: 134954)


Started GET "/cable" for ::1 at 2025-11-20 20:15:40 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:15:40 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 62], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel is streaming from terminal_session_62
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 62, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "create me a Dragonborn fighter"})
  [1m[36mCharacter Load (0.4ms)[0m  [1m[34mSELECT "characters".* FROM "characters" WHERE "characters"."discarded_at" IS NULL AND "characters"."id" = $1 LIMIT $2[0m  [["id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:15:in 'AiDm::Orchestrator#initialize'
  [1m[36mCampaign Load (0.9ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 24], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (1.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 62], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterCombatTracker Load (0.4ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:216:in 'AiDm::Orchestrator#conditions_text'
  [1m[36mCharacterInventory Load (4.5ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:530:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (2.0ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:576:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.8ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 8], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:227:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.4ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 24], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:16:15.106831') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:16:15.123929') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:16:15.125163') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mCombat Load (3.5ms)[0m  [1m[34mSELECT "combats".* FROM "combats" INNER JOIN "combat_participants" ON "combat_participants"."discarded_at" IS NULL AND "combat_participants"."combat_id" = "combats"."id" WHERE "combats"."discarded_at" IS NULL AND "combats"."status" = $1 AND "combat_participants"."character_id" = $2 ORDER BY "combats"."id" ASC LIMIT $3[0m  [["status", "active"], ["character_id", 8], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:516:in 'AiDm::Orchestrator#find_active_combat'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 62], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (0.3ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Dragonborn"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.5ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (1.0ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Soldier"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (0.8ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Dragonborn Fighter"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 4], ["campaign_id", 24], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:16:19.406676"], ["updated_at", "2025-11-21 04:16:19.406676"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:16:19.406676"], ["item_id", 9], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (0.5ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 04:16:19.410744"], ["id", 9]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:16:19.410744"], ["item_id", 9], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 9\nname: Dragonborn Fighter\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 4\ncampaign_id: 24\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:16:19.406676000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:16:19.406676000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:16:19.406676000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "b5eb935264f82520fb927b11c643bc0b"], ["id", 62], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.5ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 9], ["updated_at", "2025-11-21 04:16:19.415240"], ["id", 62]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:16:19.415240"], ["item_id", 62], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 62\ncharacter_id: 8\nuser_id: 4\nsession_token: b5eb935264f82520fb927b11c643bc0b\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:09:46.234155000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:09:46.234155000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:10:12.370233000 Z\n  zone: *1\n  time: 2025-11-21 04:10:12.370233000 Z\ncampaign_id: 24\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (0.5ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 9], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 9], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.3ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 9], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 04:16:19.422188"], ["updated_at", "2025-11-21 04:16:19.422188"]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (0.9ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 62], ["character_id", 9], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Dragonborn Fighter\",\"race\":\"Dragonborn\",\"character_class\":\"Fighter\",\"background\":\"Soldier\"}"], ["result", "{\"success\":true,\"message\":\"Created character Dragonborn Fighter\",\"character\":{\"id\":9,\"name\":\"Dragonborn Fighter\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 2], ["trigger_source", "ai"], ["created_at", "2025-11-21 04:16:19.424056"], ["updated_at", "2025-11-21 04:16:19.424056"], ["execution_time_ms", 43]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_62: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Dragonborn Fighter", character: {id: 9, name: "Dragonborn Fighter", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T04:16:19Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Dragonborn Fighter", "character" => {"id" => 9, "name" => "Dragonborn Fighter", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T04... (via streamed from terminal_session_62)
  [1m[36mDmPendingAction Load (1.0ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (2.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 62], ["content", "create me a Dragonborn fighter"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>create me a Dragonborn fighter</p>\n"], ["created_at", "2025-11-21 04:16:19.430286"], ["updated_at", "2025-11-21 04:16:19.430286"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 62], ["content", "I see you already have a character named \"Dragonborn Fighter\" but it looks like the race and class details weren't properly set. Let me create a proper Dragonborn Fighter for you with appropriate starting attributes!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I see you already have a character named \"Dragonborn Fighter\" but it looks like the race and class details weren't properly set. Let me create a proper Dragonborn Fighter for you with appropriate starting attributes!</p>\n"], ["created_at", "2025-11-21 04:16:19.435720"], ["updated_at", "2025-11-21 04:16:19.435720"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg: {type: "dm_response", narrative: "<p>I see you already have a character named \"Dragonborn Fighter\" but it looks like the race and class details weren't properly set. Let me create a proper Dragonborn Fighter for you with appropriate starting attributes!</p>\n", is_html: true, tool_results: [{su...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I see you already have a character named \"Dragonborn Fighter\" but it looks like the race and class details weren't properly set. Let me create a proper Dragonborn Fighter for you with appropriate starting attributes!</p>\n", "is_html" => true, "tool_... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg)
Started GET "/apple-touch-icon-precomposed.png" for ::1 at 2025-11-20 20:16:53 -0800
Started GET "/favicon.ico" for ::1 at 2025-11-20 20:16:53 -0800
Started GET "/apple-touch-icon.png" for ::1 at 2025-11-20 20:16:53 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/apple-touch-icon.png"):
  
  [1m[35m (1.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/favicon.ico"):
  
  [1m[35m (61.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
  
ActionController::RoutingError (No route matches [GET] "/apple-touch-icon-precomposed.png"):
  
Started GET "/" for 127.0.0.1 at 2025-11-20 20:17:01 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (3.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "28b376a04f4d14373e2c5dd3e29053f2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (3.5ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:17:01.158283"], ["updated_at", "2025-11-21 04:17:01.158283"], ["session_token", "28b376a04f4d14373e2c5dd3e29053f2"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:01.158283"], ["item_id", 64], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.1ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_7026ef013676f38a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:17:01.164599"], ["updated_at", "2025-11-21 04:17:01.164819"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:01.164819"], ["item_id", 26], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "28b376a04f4d14373e2c5dd3e29053f2"], ["id", 64], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.4ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:17:01.169895"], ["campaign_id", 26], ["id", 64]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:01.169895"], ["item_id", 64], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 64\nuser_id: 6\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:17:01.158283000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:17:01.158283000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:17:01.158283000 Z\nsession_token: 28b376a04f4d14373e2c5dd3e29053f2\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.3ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 64], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 2.2ms | Allocations: 993)
  Rendered layout layouts/terminal.html.erb (Duration: 2.5ms | Allocations: 1379)
Completed 200 OK in 31ms (Views: 2.0ms | ActiveRecord: 13.1ms | Allocations: 16516)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 20:17:01 -0800
  [1m[35m (1.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:17:01 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 64], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA
TerminalDmChannel is streaming from terminal_session_64
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 64, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "lets make a character"})
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 26], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 26], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:17:14.039224') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:17:14.040073') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:17:14.040790') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (3.7ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "lets make a character"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>lets make a character</p>\n"], ["created_at", "2025-11-21 04:17:24.052561"], ["updated_at", "2025-11-21 04:17:24.052561"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (5.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "I'd be happy to help you create a D&D 5e character! Let's start with the basics.\n\n**Character Creation**\n\nTo get started, I'll need a few key details:\n\n1. **Name** - What would you like your character to be called?\n\n2. **Race** - What race appeals to you? Some popular options include:\n   - Human (versatile, extra skill/feat)\n   - Elf (darkvision, keen senses, magic resistance)\n   - Dwarf (tough, weapon/tool proficiencies)\n   - Halfling (lucky, brave, nimble)\n   - Dragonborn (breath weapon, draconic ancestry)\n   - Tiefling (infernal heritage, charisma bonus)\n\n3. **Class** - What role do you want to play?\n   - **Fighter** (versatile warrior, multiple attacks)\n   - **Wizard** (arcane spellcaster, ritual magic)\n   - **Rogue** (stealth, skills, sneak attack)\n   - **Cleric** (divine magic, healing, support)\n   - **Ranger** (nature warrior, tracking, spells)\n   - **Barbarian** (rage, tough, primal warrior)\n   - **Bard** (jack-of-all-trades, inspiration, magic)\n   - **Paladin** (holy warrior, smite, healing)\n   - **Warlock** (pact magic, eldritch invocations)\n   - **Sorcerer** (innate magic, metamagic)\n   - **Druid** (nature magic, wild shape)\n   - **Monk** (martial arts, ki powers)\n\n4. **Background** (optional) - This gives your character skills and backstory hooks:\n   - Acolyte, Criminal, Folk Hero, Noble, Sage, Soldier, etc.\n\nOnce you give me these details, I'll create your character and we can work on ability scores, equipment, and backstory together!\n\nWhat sounds interesting to you?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'd be happy to help you create a D&amp;D 5e character! Let's start with the basics.</p>\n\n<p><strong>Character Creation</strong></p>\n\n<p>To get started, I'll need a few key details:</p>\n\n<ol>\n<li><p><strong>Name</strong> - What would you like your character to be called?</p></li>\n<li><p><strong>Race</strong> - What race appeals to you? Some popular options include:</p>\n\n<ul>\n<li>Human (versatile, extra skill/feat)</li>\n<li>Elf (darkvision, keen senses, magic resistance)</li>\n<li>Dwarf (tough, weapon/tool proficiencies)</li>\n<li>Halfling (lucky, brave, nimble)</li>\n<li>Dragonborn (breath weapon, draconic ancestry)</li>\n<li>Tiefling (infernal heritage, charisma bonus)</li>\n</ul></li>\n<li><p><strong>Class</strong> - What role do you want to play?</p>\n\n<ul>\n<li><strong>Fighter</strong> (versatile warrior, multiple attacks)</li>\n<li><strong>Wizard</strong> (arcane spellcaster, ritual magic)</li>\n<li><strong>Rogue</strong> (stealth, skills, sneak attack)</li>\n<li><strong>Cleric</strong> (divine magic, healing, support)</li>\n<li><strong>Ranger</strong> (nature warrior, tracking, spells)</li>\n<li><strong>Barbarian</strong> (rage, tough, primal warrior)</li>\n<li><strong>Bard</strong> (jack-of-all-trades, inspiration, magic)</li>\n<li><strong>Paladin</strong> (holy warrior, smite, healing)</li>\n<li><strong>Warlock</strong> (pact magic, eldritch invocations)</li>\n<li><strong>Sorcerer</strong> (innate magic, metamagic)</li>\n<li><strong>Druid</strong> (nature magic, wild shape)</li>\n<li><strong>Monk</strong> (martial arts, ki powers)</li>\n</ul></li>\n<li><p><strong>Background</strong> (optional) - This gives your character skills and backstory hooks:</p>\n\n<ul>\n<li>Acolyte, Criminal, Folk Hero, Noble, Sage, Soldier, etc.</li>\n</ul></li>\n</ol>\n\n<p>Once you give me these details, I'll create your character and we can work on ability scores, equipment, and backstory together!</p>\n\n<p>What sounds interesting to you?</p>\n"], ["created_at", "2025-11-21 04:17:24.056408"], ["updated_at", "2025-11-21 04:17:24.056408"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA: {type: "dm_response", narrative: "<p>I'd be happy to help you create a D&amp;D 5e character! Let's start with the basics.</p>\n\n<p><strong>Character Creation</strong></p>\n\n<p>To get started, I'll need a few key details:</p>\n\n<ol>\n<li><p><strong>Name</strong> - What would you like your chara...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'd be happy to help you create a D&amp;D 5e character! Let's start with the basics.</p>\n\n<p><strong>Character Creation</strong></p>\n\n<p>To get started, I'll need a few key details:</p>\n\n<ol>\n<li><p><strong>Name</strong> - What would you like yo... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA)
TerminalDmChannel#quick_action({"params" => {}})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.8ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 26], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:17:46.153624') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:17:46.154424') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:17:46.155172') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.3ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (0.3ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Soldier"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.5ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Kael Swiftblade"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 26], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:17:50.045332"], ["updated_at", "2025-11-21 04:17:50.045332"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:50.045332"], ["item_id", 10], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (0.3ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 04:17:50.049570"], ["id", 10]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:50.049570"], ["item_id", 10], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 10\nname: Kael Swiftblade\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 6\ncampaign_id: 26\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:17:50.045332000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:17:50.045332000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:17:50.045332000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "28b376a04f4d14373e2c5dd3e29053f2"], ["id", 64], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (2.4ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 10], ["updated_at", "2025-11-21 04:17:50.053282"], ["id", 64]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:17:50.053282"], ["item_id", 64], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 64\ncharacter_id:\nuser_id: 6\nsession_token: 28b376a04f4d14373e2c5dd3e29053f2\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:17:01.158283000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:17:01.158283000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:17:01.169895000 Z\n  zone: *1\n  time: 2025-11-21 04:17:01.169895000 Z\ncampaign_id: 26\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (0.2ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (2.7ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 10], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 04:17:50.060855"], ["updated_at", "2025-11-21 04:17:50.060855"]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (1.0ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 64], ["character_id", 10], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Kael Swiftblade\",\"race\":\"Human\",\"character_class\":\"Fighter\",\"background\":\"Soldier\"}"], ["result", "{\"success\":true,\"message\":\"Created character Kael Swiftblade\",\"character\":{\"id\":10,\"name\":\"Kael Swiftblade\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 2], ["trigger_source", "ai"], ["created_at", "2025-11-21 04:17:50.065154"], ["updated_at", "2025-11-21 04:17:50.065154"], ["execution_time_ms", 17]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_64: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Kael Swiftblade", character: {id: 10, name: "Kael Swiftblade", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T04:17:50Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Kael Swiftblade", "character" => {"id" => 10, "name" => "Kael Swiftblade", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T04:17:5... (via streamed from terminal_session_64)
  [1m[36mDmPendingAction Load (0.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (3.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "I quick action."], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I quick action.</p>\n"], ["created_at", "2025-11-21 04:17:50.069241"], ["updated_at", "2025-11-21 04:17:50.069241"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "Got it! Let's make this quick and get you into the action.\n\nI'll create a classic, ready-to-play character for you:"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Got it! Let's make this quick and get you into the action.</p>\n\n<p>I'll create a classic, ready-to-play character for you:</p>\n"], ["created_at", "2025-11-21 04:17:50.074859"], ["updated_at", "2025-11-21 04:17:50.074859"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA: {type: "dm_response", narrative: "<p>Got it! Let's make this quick and get you into the action.</p>\n\n<p>I'll create a classic, ready-to-play character for you:</p>\n", is_html: true, tool_results: [{success: true, message: "Created character Kael Swiftblade", character: {id: 10, name: "Kael Swi...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Got it! Let's make this quick and get you into the action.</p>\n\n<p>I'll create a classic, ready-to-play character for you:</p>\n", "is_html" => true, "tool_results" => [{"success" => true, "message" => "Created character Kael Swiftblade", "character"... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA)
TerminalDmChannel#send_message({"message" => "where am I?"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterInventory Load (0.3ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:530:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (0.2ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:576:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 10], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:227:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.0ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 26], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:18:12.542829') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:18:12.544116') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (1.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:18:12.545462') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mCombat Load (0.4ms)[0m  [1m[34mSELECT "combats".* FROM "combats" INNER JOIN "combat_participants" ON "combat_participants"."discarded_at" IS NULL AND "combat_participants"."combat_id" = "combats"."id" WHERE "combats"."discarded_at" IS NULL AND "combats"."status" = $1 AND "combat_participants"."character_id" = $2 ORDER BY "combats"."id" ASC LIMIT $3[0m  [["status", "active"], ["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:516:in 'AiDm::Orchestrator#find_active_combat'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (4.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "where am I?"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>where am I?</p>\n"], ["created_at", "2025-11-21 04:18:21.245262"], ["updated_at", "2025-11-21 04:18:21.245262"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.6ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "You find yourself standing at the edge of **Millhaven**, a modest trading town nestled in a valley between rolling green hills. The late afternoon sun casts long shadows across the cobblestone streets, and you can hear the distant sound of merchants hawking their wares in the town square.\n\n*The air carries the scent of fresh bread from the bakery and the metallic tang of the blacksmith's forge.*\n\n**Your Current Situation:**\nYou're at the **town's main gate**, where a weathered wooden sign reads \"Welcome to Millhaven - Population 847.\" A few travelers and merchants are coming and going, their wagons creaking under the weight of trade goods.\n\nTo your immediate options:\n- **North**: The town square and market district\n- **East**: The residential quarter with modest homes\n- **West**: The crafters' district (blacksmith, fletcher, etc.)  \n- **South**: The road leading back to the countryside\n- **Center**: The **Prancing Pony Inn** - you can see its wooden sign swaying in the breeze\n\n*You notice a few townspeople glancing your way with curious but friendly expressions. A guard in simple leather armor nods respectfully as he patrols past.*\n\nWhat would you like to do? Where does your adventure begin?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>You find yourself standing at the edge of <strong>Millhaven</strong>, a modest trading town nestled in a valley between rolling green hills. The late afternoon sun casts long shadows across the cobblestone streets, and you can hear the distant sound of merchants hawking their wares in the town square.</p>\n\n<p><em>The air carries the scent of fresh bread from the bakery and the metallic tang of the blacksmith's forge.</em></p>\n\n<p><strong>Your Current Situation:</strong><br>\nYou're at the <strong>town's main gate</strong>, where a weathered wooden sign reads \"Welcome to Millhaven - Population 847.\" A few travelers and merchants are coming and going, their wagons creaking under the weight of trade goods.</p>\n\n<p>To your immediate options:<br>\n- <strong>North</strong>: The town square and market district<br>\n- <strong>East</strong>: The residential quarter with modest homes<br>\n- <strong>West</strong>: The crafters' district (blacksmith, fletcher, etc.)<br><br>\n- <strong>South</strong>: The road leading back to the countryside<br>\n- <strong>Center</strong>: The <strong>Prancing Pony Inn</strong> - you can see its wooden sign swaying in the breeze</p>\n\n<p><em>You notice a few townspeople glancing your way with curious but friendly expressions. A guard in simple leather armor nods respectfully as he patrols past.</em></p>\n\n<p>What would you like to do? Where does your adventure begin?</p>\n"], ["created_at", "2025-11-21 04:18:21.248330"], ["updated_at", "2025-11-21 04:18:21.248330"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA: {type: "dm_response", narrative: "<p>You find yourself standing at the edge of <strong>Millhaven</strong>, a modest trading town nestled in a valley between rolling green hills. The late afternoon sun casts long shadows across the cobblestone streets, and you can hear the distant sound of merchan...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>You find yourself standing at the edge of <strong>Millhaven</strong>, a modest trading town nestled in a valley between rolling green hills. The late afternoon sun casts long shadows across the cobblestone streets, and you can hear the distant sound of... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA)
TerminalDmChannel#send_message({"message" => "what class? what?"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.2ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 10], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:227:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 26], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (1.1ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:18:45.334634') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:18:45.336309') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:18:45.337131') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mCombat Load (0.3ms)[0m  [1m[34mSELECT "combats".* FROM "combats" INNER JOIN "combat_participants" ON "combat_participants"."discarded_at" IS NULL AND "combat_participants"."combat_id" = "combats"."id" WHERE "combats"."discarded_at" IS NULL AND "combats"."status" = $1 AND "combat_participants"."character_id" = $2 ORDER BY "combats"."id" ASC LIMIT $3[0m  [["status", "active"], ["character_id", 10], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:516:in 'AiDm::Orchestrator#find_active_combat'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.3ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:198:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.2ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:199:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (0.2ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Soldier"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:200:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (0.6ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Kael Swiftblade"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 10], ["dexterity", 10], ["constitution", 10], ["intelligence", 10], ["wisdom", 10], ["charisma", 10], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 26], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:18:48.908936"], ["updated_at", "2025-11-21 04:18:48.908936"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (2.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:18:48.908936"], ["item_id", 11], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (0.4ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 8], ["hit_points_max", 8], ["updated_at", "2025-11-21 04:18:48.913627"], ["id", 11]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:18:48.913627"], ["item_id", 11], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 11\nname: Kael Swiftblade\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 10\ndexterity: 10\nconstitution: 10\nintelligence: 10\nwisdom: 10\ncharisma: 10\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 6\ncampaign_id: 26\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:18:48.908936000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:18:48.908936000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:18:48.908936000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:220:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "28b376a04f4d14373e2c5dd3e29053f2"], ["id", 64], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (0.5ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 11], ["updated_at", "2025-11-21 04:18:48.917416"], ["id", 64]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:18:48.917416"], ["item_id", 64], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 64\ncharacter_id: 10\nuser_id: 6\nsession_token: 28b376a04f4d14373e2c5dd3e29053f2\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:17:01.158283000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:17:01.158283000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:17:50.053282000 Z\n  zone: *1\n  time: 2025-11-21 04:17:50.053282000 Z\ncampaign_id: 26\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:226:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (2.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mCharacterCombatTracker Load (0.3ms)[0m  [1m[34mSELECT "character_combat_trackers".* FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "character_combat_trackers" WHERE "character_combat_trackers"."character_id" = $1 LIMIT $2[0m  [["character_id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mCharacterCombatTracker Create (0.3ms)[0m  [1m[32mINSERT INTO "character_combat_trackers" ("character_id", "action_resources", "death_saves", "conditions", "resistances", "immunities", "vulnerabilities", "temp_hp", "exhaustion_level", "initiative_roll", "has_reaction", "has_bonus_action", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["character_id", 11], ["action_resources", "{}"], ["death_saves", "{\"successes\":0,\"failures\":0}"], ["conditions", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["temp_hp", 0], ["exhaustion_level", 0], ["initiative_roll", nil], ["has_reaction", true], ["has_bonus_action", true], ["created_at", "2025-11-21 04:18:48.925350"], ["updated_at", "2025-11-21 04:18:48.925350"]]
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:1106:in 'AiDm::ToolExecutor#character_combat_tracker'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mDmActionAuditLog Create (3.9ms)[0m  [1m[32mINSERT INTO "dm_action_audit_logs" ("terminal_session_id", "character_id", "dm_pending_action_id", "tool_name", "parameters", "result", "execution_status", "state_before", "state_after", "conversation_turn", "trigger_source", "created_at", "updated_at", "execution_time_ms") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["terminal_session_id", 64], ["character_id", 11], ["dm_pending_action_id", nil], ["tool_name", "create_character"], ["parameters", "{\"name\":\"Kael Swiftblade\",\"race\":\"Human\",\"character_class\":\"Fighter\",\"background\":\"Soldier\"}"], ["result", "{\"success\":true,\"message\":\"Created character Kael Swiftblade\",\"character\":{\"id\":11,\"name\":\"Kael Swiftblade\",\"race\":null,\"class\":null,\"level\":1,\"hp\":\"8/8\"}}"], ["execution_status", "executed"], ["state_before", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["state_after", "{\"hp\":8,\"max_hp\":8,\"gold\":0,\"experience\":null,\"level\":1,\"conditions\":[],\"ability_scores\":{\"strength\":10,\"dexterity\":10,\"constitution\":10,\"intelligence\":10,\"wisdom\":10,\"charisma\":10}}"], ["conversation_turn", 6], ["trigger_source", "ai"], ["created_at", "2025-11-21 04:18:48.926802"], ["updated_at", "2025-11-21 04:18:48.926802"], ["execution_time_ms", 17]]
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/ai_dm/tool_executor.rb:142:in 'AiDm::ToolExecutor#execute_immediately'
[ActionCable] Broadcasting to terminal_session_64: {type: "state_change", tool_name: "create_character", result: {success: true, message: "Created character Kael Swiftblade", character: {id: 11, name: "Kael Swiftblade", race: nil, class: nil, level: 1, hp: "8/8"}}, timestamp: "2025-11-21T04:18:48Z"}
TerminalDmChannel transmitting {"type" => "state_change", "tool_name" => "create_character", "result" => {"success" => true, "message" => "Created character Kael Swiftblade", "character" => {"id" => 11, "name" => "Kael Swiftblade", "race" => nil, "class" => nil, "level" => 1, "hp" => "8/8"}}, "timestamp" => "2025-11-21T04:18:4... (via streamed from terminal_session_64)
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "what class? what?"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>what class? what?</p>\n"], ["created_at", "2025-11-21 04:18:48.933703"], ["updated_at", "2025-11-21 04:18:48.933703"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (3.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "Ah, you're right! I need to actually set up your character properly first. Let me create a quick, action-ready character for you:"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Ah, you're right! I need to actually set up your character properly first. Let me create a quick, action-ready character for you:</p>\n"], ["created_at", "2025-11-21 04:18:48.936011"], ["updated_at", "2025-11-21 04:18:48.936011"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA: {type: "dm_response", narrative: "<p>Ah, you're right! I need to actually set up your character properly first. Let me create a quick, action-ready character for you:</p>\n", is_html: true, tool_results: [{success: true, message: "Created character Kael Swiftblade", character: {id: 11, name: "Kae...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Ah, you're right! I need to actually set up your character properly first. Let me create a quick, action-ready character for you:</p>\n", "is_html" => true, "tool_results" => [{"success" => true, "message" => "Created character Kael Swiftblade", "chara... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA)
TerminalDmChannel#send_message({"message" => "ok good so now what do I have"})
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 64], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mCharacterInventory Load (0.3ms)[0m  [1m[34mSELECT "character_inventories".* FROM "character_inventories" WHERE "character_inventories"."discarded_at" IS NULL AND "character_inventories"."character_id" = $1 LIMIT $2[0m  [["character_id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:530:in 'AiDm::Orchestrator#inventory_context'
  [1m[36mCharacterSpellManager Load (0.2ms)[0m  [1m[34mSELECT "character_spell_managers".* FROM "character_spell_managers" WHERE "character_spell_managers"."character_id" = $1 LIMIT $2[0m  [["character_id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:576:in 'AiDm::Orchestrator#spell_manager_context'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."character_id" = $1 AND "quest_logs"."status" = $2[0m  [["character_id", 11], ["status", "active"]]
  ↳ app/services/ai_dm/orchestrator.rb:227:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 26], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:19:16.269897') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:19:16.270925') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:19:16.271640') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mCombat Load (0.4ms)[0m  [1m[34mSELECT "combats".* FROM "combats" INNER JOIN "combat_participants" ON "combat_participants"."discarded_at" IS NULL AND "combat_participants"."combat_id" = "combats"."id" WHERE "combats"."discarded_at" IS NULL AND "combats"."status" = $1 AND "combat_participants"."character_id" = $2 ORDER BY "combats"."id" ASC LIMIT $3[0m  [["status", "active"], ["character_id", 11], ["LIMIT", 1]]
  ↳ app/services/ai_dm/orchestrator.rb:516:in 'AiDm::Orchestrator#find_active_combat'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 64], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "ok good so now what do I have"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>ok good so now what do I have</p>\n"], ["created_at", "2025-11-21 04:19:25.819563"], ["updated_at", "2025-11-21 04:19:25.819563"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (3.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 64], ["content", "**Kael Swiftblade** - Your Character Sheet:\n\n**Race & Class:** *Still need to set these up properly*\n\n**Current Stats:**\n- **HP:** 8/8\n- **AC:** 10 (no armor yet)\n- **Gold:** 0 gp\n- **Level:** 1\n- **XP:** 0\n\n**Ability Scores:** *(Need to be properly assigned)*\n- All currently at 10 (-5 modifier) - this needs fixing!\n\n**Equipment:** *Empty hands and basic clothes*\n\n---\n\n**We need to quickly set you up properly!** \n\nLet me create you a ready-to-adventure character. How about:\n\n**Human Fighter** - Classic, versatile, great for jumping into action\n- Good with weapons and armor\n- Tough and reliable\n- Second Wind for self-healing\n\nDoes that work, or would you prefer:\n- **Elf Ranger** (archer/tracker)  \n- **Dwarf Cleric** (healer/support)\n- **Halfling Rogue** (stealth/skills)\n\nJust pick one and I'll get you properly equipped and ready to explore Millhaven!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><strong>Kael Swiftblade</strong> - Your Character Sheet:</p>\n\n<p><strong>Race &amp; Class:</strong> <em>Still need to set these up properly</em></p>\n\n<p><strong>Current Stats:</strong><br>\n- <strong>HP:</strong> 8/8<br>\n- <strong>AC:</strong> 10 (no armor yet)<br>\n- <strong>Gold:</strong> 0 gp<br>\n- <strong>Level:</strong> 1<br>\n- <strong>XP:</strong> 0</p>\n\n<p><strong>Ability Scores:</strong> <em>(Need to be properly assigned)</em><br>\n- All currently at 10 (-5 modifier) - this needs fixing!</p>\n\n<p><strong>Equipment:</strong> <em>Empty hands and basic clothes</em></p>\n\n<hr>\n\n<p><strong>We need to quickly set you up properly!</strong> </p>\n\n<p>Let me create you a ready-to-adventure character. How about:</p>\n\n<p><strong>Human Fighter</strong> - Classic, versatile, great for jumping into action<br>\n- Good with weapons and armor<br>\n- Tough and reliable<br>\n- Second Wind for self-healing</p>\n\n<p>Does that work, or would you prefer:<br>\n- <strong>Elf Ranger</strong> (archer/tracker)<br><br>\n- <strong>Dwarf Cleric</strong> (healer/support)<br>\n- <strong>Halfling Rogue</strong> (stealth/skills)</p>\n\n<p>Just pick one and I'll get you properly equipped and ready to explore Millhaven!</p>\n"], ["created_at", "2025-11-21 04:19:25.823131"], ["updated_at", "2025-11-21 04:19:25.823131"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA: {type: "dm_response", narrative: "<p><strong>Kael Swiftblade</strong> - Your Character Sheet:</p>\n\n<p><strong>Race &amp; Class:</strong> <em>Still need to set these up properly</em></p>\n\n<p><strong>Current Stats:</strong><br>\n- <strong>HP:</strong> 8/8<br>\n- <strong>AC:</strong> 10 (no armo...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><strong>Kael Swiftblade</strong> - Your Character Sheet:</p>\n\n<p><strong>Race &amp; Class:</strong> <em>Still need to set these up properly</em></p>\n\n<p><strong>Current Stats:</strong><br>\n- <strong>HP:</strong> 8/8<br>\n- <strong>AC:</strong> 10 ... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA)
Finished "/cable" [WebSocket] for ::1 at 2025-11-20 20:31:15 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel stopped streaming from terminal_session_62
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:31:15 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA
TerminalDmChannel stopped streaming from terminal_session_64
Started GET "/cable" for ::1 at 2025-11-20 20:31:16 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/cable" for 127.0.0.1 at 2025-11-20 20:31:16 -0800
  [1m[35m (17.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:31:16 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (2.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:31:16 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (2.9ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 64], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA
TerminalDmChannel is streaming from terminal_session_64
  [1m[36mDmPendingAction Load (1.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 64, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/cable" for ::1 at 2025-11-20 20:31:25 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:31:25 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 62], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel is streaming from terminal_session_62
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:230:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 62, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

Started GET "/" for ::1 at 2025-11-20 20:34:20 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as */*
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_a3f9c93953cbf8f2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mCACHE User Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email" = $1 LIMIT $2[0m  [["email", "guest_a3f9c93953cbf8f2@terminal-dnd.local"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Exists? (2.6ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "guest_a3f9c93953cbf8f2"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mUser Create (1.1ms)[0m  [1m[32mINSERT INTO "users" ("email", "password_digest", "role", "discarded_at", "username", "bio", "avatar_url", "experience_points", "level", "preferences", "timezone", "last_active_at", "deleted_at", "created_at", "updated_at", "encrypted_password", "reset_password_token", "reset_password_sent_at", "remember_created_at", "sign_in_count", "current_sign_in_at", "last_sign_in_at", "current_sign_in_ip", "last_sign_in_ip", "guest", "display_name", "discord_id", "discord_username", "discord_discriminator", "discord_avatar", "discord_access_token", "discord_refresh_token", "discord_token_expires_at", "ai_tokens_used", "ai_tokens_limit", "ai_tokens_reset_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36) RETURNING "id"[0m  [["email", "guest_a3f9c93953cbf8f2@terminal-dnd.local"], ["password_digest", nil], ["role", "user"], ["discarded_at", nil], ["username", "guest_a3f9c93953cbf8f2"], ["bio", nil], ["avatar_url", nil], ["experience_points", nil], ["level", nil], ["preferences", nil], ["timezone", nil], ["last_active_at", nil], ["deleted_at", nil], ["created_at", "2025-11-21 04:34:20.625983"], ["updated_at", "2025-11-21 04:34:20.625983"], ["encrypted_password", "$2a$12$lYk8yexdJI9H6FD.dxCb1O/cGJdkRgwkyvNqeOXt2nXwisUExKBBi"], ["reset_password_token", nil], ["reset_password_sent_at", nil], ["remember_created_at", nil], ["sign_in_count", 0], ["current_sign_in_at", nil], ["last_sign_in_at", nil], ["current_sign_in_ip", nil], ["last_sign_in_ip", nil], ["guest", true], ["display_name", nil], ["discord_id", nil], ["discord_username", nil], ["discord_discriminator", nil], ["discord_avatar", nil], ["discord_access_token", nil], ["discord_refresh_token", nil], ["discord_token_expires_at", nil], ["ai_tokens_used", 0], ["ai_tokens_limit", 100000], ["ai_tokens_reset_at", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:34:20.625983"], ["item_id", 32], ["item_type", "User"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (2.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:143:in 'TerminalController#create_guest_user'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (2.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "306d7c7a9d0d8aaa0e04cb56b148c89a"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (2.4ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 32], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:34:20.645898"], ["updated_at", "2025-11-21 04:34:20.645898"], ["session_token", "306d7c7a9d0d8aaa0e04cb56b148c89a"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:34:20.645898"], ["item_id", 65], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.5ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_a3f9c93953cbf8f2"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:34:20.661494"], ["updated_at", "2025-11-21 04:34:20.669159"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (2.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:34:20.669159"], ["item_id", 27], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "306d7c7a9d0d8aaa0e04cb56b148c89a"], ["id", 65], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (4.3ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:34:20.680517"], ["campaign_id", 27], ["id", 65]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:34:20.680517"], ["item_id", 65], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 65\nuser_id: 32\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:34:20.645898000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:34:20.645898000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:34:20.645898000 Z\nsession_token: 306d7c7a9d0d8aaa0e04cb56b148c89a\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (2.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 65], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 65], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 4.3ms | Allocations: 2019)
  Rendered layout layouts/terminal.html.erb (Duration: 28.5ms | Allocations: 37366)
Completed 200 OK in 424ms (Views: 28.5ms | ActiveRecord: 63.2ms | Allocations: 134832)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 20:34:27 -0800
  [1m[35m (2.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:34:27 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 64], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA
TerminalDmChannel is streaming from terminal_session_64
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 64], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 64, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/cable" for ::1 at 2025-11-20 20:34:34 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:34:34 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 62], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel is streaming from terminal_session_62
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 62, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:35:01 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82NA
TerminalDmChannel stopped streaming from terminal_session_64
Started GET "/" for 127.0.0.1 at 2025-11-20 20:35:01 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.7ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "5276f3c27cc3c64cdd4b5c1a4d06ca46"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.6ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:35:01.910925"], ["updated_at", "2025-11-21 04:35:01.910925"], ["session_token", "5276f3c27cc3c64cdd4b5c1a4d06ca46"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:01.910925"], ["item_id", 66], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.0ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_7026ef013676f38a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:35:01.916158"], ["updated_at", "2025-11-21 04:35:01.916448"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:01.916448"], ["item_id", 28], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "5276f3c27cc3c64cdd4b5c1a4d06ca46"], ["id", 66], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.2ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:35:01.921942"], ["campaign_id", 28], ["id", 66]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.0ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:01.921942"], ["item_id", 66], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 66\nuser_id: 6\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:35:01.910925000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:35:01.910925000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:35:01.910925000 Z\nsession_token: 5276f3c27cc3c64cdd4b5c1a4d06ca46\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 66], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.9ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 66], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.4ms | Allocations: 991)
  Rendered layout layouts/terminal.html.erb (Duration: 1.7ms | Allocations: 1375)
Completed 200 OK in 26ms (Views: 1.5ms | ActiveRecord: 7.3ms | Allocations: 16468)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 20:35:01 -0800
  [1m[35m (3.2ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:35:01 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 66], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Ng
TerminalDmChannel is streaming from terminal_session_66
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 66], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 66, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "lets create a dwarf sorcerer"})
  [1m[36mCampaign Load (0.3ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 28], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 66], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 66], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.9ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 28], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (2.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:35:24.901866') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 66], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:35:24.908981') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 66], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:35:24.910060') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 66], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 66], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (0.6ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Dwarf"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.3ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL ORDER BY "races"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.7ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Sorcerer"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL ORDER BY "character_classes"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:208:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.3ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Dwarf Sorcerer"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 15], ["dexterity", 14], ["constitution", 13], ["intelligence", 12], ["wisdom", 10], ["charisma", 8], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 28], ["race_id", nil], ["character_class_id", nil], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:35:28.011325"], ["updated_at", "2025-11-21 04:35:28.011325"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:207:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (1.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:28.011325"], ["item_id", 12], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:207:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Update (1.0ms)[0m  [1m[33mUPDATE "characters" SET "hit_points_current" = $1, "hit_points_max" = $2, "updated_at" = $3 WHERE "characters"."id" = $4[0m  [["hit_points_current", 9], ["hit_points_max", 9], ["updated_at", "2025-11-21 04:35:28.017229"], ["id", 12]]
  ↳ app/services/ai_dm/tool_executor.rb:225:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:28.017229"], ["item_id", 12], ["item_type", "Character"], ["event", "update"], ["object", "---\nid: 12\nname: Dwarf Sorcerer\nlevel: 1\nexperience:\nproficiency_bonus:\nstrength: 15\ndexterity: 14\nconstitution: 13\nintelligence: 12\nwisdom: 10\ncharisma: 8\nhit_points_current:\nhit_points_max:\ntemporary_hit_points:\narmor_class:\ninitiative_bonus:\nspeed:\nalignment:\npersonality_traits:\nideals:\nbonds:\nflaws:\nbackstory:\nskills:\nproficiencies:\nconditions:\navatar_url:\nvisibility:\ndeleted_at:\nuser_id: 6\ncampaign_id: 28\nrace_id:\ncharacter_class_id:\nbackground_id:\ncharacter_voice:\nai_personality_profile: \"{}\"\ncatchphrases: \"[]\"\nhomebrew_modifications: \"{}\"\ncustom_features: \"[]\"\nhouse_rules: \"{}\"\nquick_actions: \"[]\"\nfavorite_spells: \"[]\"\ncombat_tactics: \"[]\"\ntheme_preferences: \"{}\"\nportrait_url:\ntoken_url:\nlast_session_notes:\nsession_count: 0\ntotal_playtime_hours: !ruby/object:BigDecimal 9:0.0\nfaction_affiliations: \"{}\"\nfaction_reputations: \"{}\"\ncurrent_hp:\nmax_hp:\ntemporary_hp: 0\ndeath_save_successes: 0\ndeath_save_failures: 0\nspell_slots: \"{}\"\nconcentration_spell_id:\ndamage_resistances: \"[]\"\ndamage_immunities: \"[]\"\ndamage_vulnerabilities: \"[]\"\nactive_effects: \"[]\"\nresistances: \"[]\"\nimmunities: \"[]\"\nvulnerabilities: \"[]\"\nhit_dice_used: 0\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:35:28.011325000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:35:28.011325000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:35:28.011325000 Z\ndiscarded_at:\ngold: 0\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:225:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "5276f3c27cc3c64cdd4b5c1a4d06ca46"], ["id", 66], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:231:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTerminalSession Update (2.8ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "character_id" = $1, "updated_at" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["character_id", 12], ["updated_at", "2025-11-21 04:35:28.021943"], ["id", 66]]
  ↳ app/services/ai_dm/tool_executor.rb:231:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:35:28.021943"], ["item_id", 66], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 66\ncharacter_id:\nuser_id: 6\nsession_token: 5276f3c27cc3c64cdd4b5c1a4d06ca46\ntitle: New Adventure\nmode: creation\nactive: true\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:35:01.910925000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:35:01.910925000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:35:01.921942000 Z\n  zone: *1\n  time: 2025-11-21 04:35:01.921942000 Z\ncampaign_id: 28\n"]]
  ↳ app/services/ai_dm/tool_executor.rb:231:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'name' for nil
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:234:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 66], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.5ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 66], ["content", "lets create a dwarf sorcerer"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>lets create a dwarf sorcerer</p>\n"], ["created_at", "2025-11-21 04:35:28.031002"], ["updated_at", "2025-11-21 04:35:28.031002"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.8ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 66], ["content", "I'll help you create a dwarf sorcerer! Let me set up the basic character framework for you."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll help you create a dwarf sorcerer! Let me set up the basic character framework for you.</p>\n"], ["created_at", "2025-11-21 04:35:28.035125"], ["updated_at", "2025-11-21 04:35:28.035125"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Ng: {type: "dm_response", narrative: "<p>I'll help you create a dwarf sorcerer! Let me set up the basic character framework for you.</p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'name' for nil", errors: ["undefined method 'name' for nil"], tool_name: "create_charact...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll help you create a dwarf sorcerer! Let me set up the basic character framework for you.</p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undefined method 'name' for nil", "errors" => ["undefined method 'name' for nil"]... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Ng)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mRace Load (0.5ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mRace Count (1.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "races" WHERE "races"."discarded_at" IS NULL[0m
  [1m[36mCharacterClass Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mRace Create (3.6ms)[0m  [1m[32mINSERT INTO "races" ("name", "size", "speed", "ability_increases", "traits", "languages", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"[0m  [["name", "Human"], ["size", nil], ["speed", 30], ["ability_increases", nil], ["traits", nil], ["languages", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.723255"], ["updated_at", "2025-11-21 04:36:57.723255"]]
  [1m[36mPaperTrail::Version Create (0.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.723255"], ["item_id", 1], ["item_type", "Race"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mRace Create (0.8ms)[0m  [1m[32mINSERT INTO "races" ("name", "size", "speed", "ability_increases", "traits", "languages", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"[0m  [["name", "Elf"], ["size", nil], ["speed", 30], ["ability_increases", nil], ["traits", nil], ["languages", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.742130"], ["updated_at", "2025-11-21 04:36:57.742130"]]
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.742130"], ["item_id", 2], ["item_type", "Race"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mRace Create (0.9ms)[0m  [1m[32mINSERT INTO "races" ("name", "size", "speed", "ability_increases", "traits", "languages", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"[0m  [["name", "Dwarf"], ["size", nil], ["speed", 25], ["ability_increases", nil], ["traits", nil], ["languages", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.744931"], ["updated_at", "2025-11-21 04:36:57.744931"]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.744931"], ["item_id", 3], ["item_type", "Race"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mRace Create (0.9ms)[0m  [1m[32mINSERT INTO "races" ("name", "size", "speed", "ability_increases", "traits", "languages", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"[0m  [["name", "Halfling"], ["size", nil], ["speed", 25], ["ability_increases", nil], ["traits", nil], ["languages", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.748141"], ["updated_at", "2025-11-21 04:36:57.748141"]]
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.748141"], ["item_id", 4], ["item_type", "Race"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Create (2.3ms)[0m  [1m[32mINSERT INTO "character_classes" ("name", "hit_die", "primary_ability", "saving_throw_proficiencies", "skill_proficiencies", "armor_proficiencies", "weapon_proficiencies", "starting_equipment", "class_features", "spellcasting_ability", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["name", "Fighter"], ["hit_die", 0], ["primary_ability", nil], ["saving_throw_proficiencies", nil], ["skill_proficiencies", nil], ["armor_proficiencies", nil], ["weapon_proficiencies", nil], ["starting_equipment", nil], ["class_features", nil], ["spellcasting_ability", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.782935"], ["updated_at", "2025-11-21 04:36:57.782935"]]
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.782935"], ["item_id", 1], ["item_type", "CharacterClass"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Create (1.0ms)[0m  [1m[32mINSERT INTO "character_classes" ("name", "hit_die", "primary_ability", "saving_throw_proficiencies", "skill_proficiencies", "armor_proficiencies", "weapon_proficiencies", "starting_equipment", "class_features", "spellcasting_ability", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["name", "Wizard"], ["hit_die", 0], ["primary_ability", nil], ["saving_throw_proficiencies", nil], ["skill_proficiencies", nil], ["armor_proficiencies", nil], ["weapon_proficiencies", nil], ["starting_equipment", nil], ["class_features", nil], ["spellcasting_ability", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.788773"], ["updated_at", "2025-11-21 04:36:57.788773"]]
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.788773"], ["item_id", 2], ["item_type", "CharacterClass"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Create (0.9ms)[0m  [1m[32mINSERT INTO "character_classes" ("name", "hit_die", "primary_ability", "saving_throw_proficiencies", "skill_proficiencies", "armor_proficiencies", "weapon_proficiencies", "starting_equipment", "class_features", "spellcasting_ability", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["name", "Rogue"], ["hit_die", 0], ["primary_ability", nil], ["saving_throw_proficiencies", nil], ["skill_proficiencies", nil], ["armor_proficiencies", nil], ["weapon_proficiencies", nil], ["starting_equipment", nil], ["class_features", nil], ["spellcasting_ability", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.792681"], ["updated_at", "2025-11-21 04:36:57.792681"]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.792681"], ["item_id", 3], ["item_type", "CharacterClass"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Create (0.8ms)[0m  [1m[32mINSERT INTO "character_classes" ("name", "hit_die", "primary_ability", "saving_throw_proficiencies", "skill_proficiencies", "armor_proficiencies", "weapon_proficiencies", "starting_equipment", "class_features", "spellcasting_ability", "description", "discarded_at", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) RETURNING "id"[0m  [["name", "Cleric"], ["hit_die", 0], ["primary_ability", nil], ["saving_throw_proficiencies", nil], ["skill_proficiencies", nil], ["armor_proficiencies", nil], ["weapon_proficiencies", nil], ["starting_equipment", nil], ["class_features", nil], ["spellcasting_ability", nil], ["description", nil], ["discarded_at", nil], ["created_at", "2025-11-21 04:36:57.796270"], ["updated_at", "2025-11-21 04:36:57.796270"]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:36:57.796270"], ["item_id", 4], ["item_type", "CharacterClass"], ["event", "create"], ["object", nil]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:37:24 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Ng
TerminalDmChannel stopped streaming from terminal_session_66
Started GET "/" for 127.0.0.1 at 2025-11-20 20:37:24 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (2.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "86c9bf531badf42b60e8ab648996e338"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 04:37:24.665148"], ["updated_at", "2025-11-21 04:37:24.665148"], ["session_token", "86c9bf531badf42b60e8ab648996e338"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:37:24.665148"], ["item_id", 67], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.2ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_7026ef013676f38a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 04:37:24.679062"], ["updated_at", "2025-11-21 04:37:24.688054"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (1.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:37:24.688054"], ["item_id", 29], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (0.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "86c9bf531badf42b60e8ab648996e338"], ["id", 67], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (1.2ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 04:37:24.697486"], ["campaign_id", 29], ["id", 67]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:37:24.697486"], ["item_id", 67], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 67\nuser_id: 6\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 04:37:24.665148000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:37:24.665148000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 04:37:24.665148000 Z\nsession_token: 86c9bf531badf42b60e8ab648996e338\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 67], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (0.8ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 67], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 1.9ms | Allocations: 2013)
  Rendered layout layouts/terminal.html.erb (Duration: 10.7ms | Allocations: 34957)
Completed 200 OK in 123ms (Views: 11.1ms | ActiveRecord: 48.8ms | Allocations: 123443)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 20:37:24 -0800
  [1m[35m (5.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 20:37:24 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 67], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw
TerminalDmChannel is streaming from terminal_session_67
  [1m[36mDmPendingAction Load (0.1ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 67, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/cable" for ::1 at 2025-11-20 20:37:32 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for ::1 at 2025-11-20 20:37:32 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 4], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNA)
  [1m[36mTerminalSession Load (0.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 62], ["user_id", 4], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 62], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Mg
TerminalDmChannel is streaming from terminal_session_62
TerminalDmChannel transmitting {type: "connected", session_id: 62, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "create me Archibald, thief and watchmaker"})
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 29], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 67], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.5ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 29], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:38:04.712920') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:38:04.719724') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:38:04.720663') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.8ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/race.rb:15:in 'block in <class:Race>'
  [1m[36mRace Load (2.4ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (0.6ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Guild Artisan (Watchmaker)"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:204:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:211:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (0.9ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Archibald"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 15], ["dexterity", 14], ["constitution", 13], ["intelligence", 12], ["wisdom", 10], ["charisma", 8], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 29], ["race_id", 1], ["character_class_id", 3], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 04:38:08.902526"], ["updated_at", "2025-11-21 04:38:08.902526"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (1.5ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:38:08.902526"], ["item_id", 13], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gsub' for an instance of Integer
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:227:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.6ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "create me Archibald, thief and watchmaker"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>create me Archibald, thief and watchmaker</p>\n"], ["created_at", "2025-11-21 04:38:08.925345"], ["updated_at", "2025-11-21 04:38:08.925345"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "I'll create Archibald, a thief with a watchmaker background - what an intriguing combination of precise craftsmanship and nimble fingers!"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll create Archibald, a thief with a watchmaker background - what an intriguing combination of precise craftsmanship and nimble fingers!</p>\n"], ["created_at", "2025-11-21 04:38:08.928852"], ["updated_at", "2025-11-21 04:38:08.928852"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw: {type: "dm_response", narrative: "<p>I'll create Archibald, a thief with a watchmaker background - what an intriguing combination of precise craftsmanship and nimble fingers!</p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'gsub' for an instance of Integer", errors...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll create Archibald, a thief with a watchmaker background - what an intriguing combination of precise craftsmanship and nimble fingers!</p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undefined method 'gsub' for an inst... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacterClass Update All (1.6ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1 WHERE "character_classes"."discarded_at" IS NULL[0m  [["hit_die", nil]]
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.0ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 04:38:43.889678"], ["id", 1]]
  [1m[36mPaperTrail::Version Create (1.1ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:38:43.889678"], ["item_id", 1], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die:\nid: 1\nname: Fighter\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.782935000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.782935000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.782935000 Z\n  zone: *1\n  time: 2025-11-21 04:36:57.782935000 Z\n"]]
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Wizard"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.0ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 04:38:43.904216"], ["id", 2]]
  [1m[36mPaperTrail::Version Create (0.6ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:38:43.904216"], ["item_id", 2], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die:\nid: 2\nname: Wizard\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.788773000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.788773000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.788773000 Z\n  zone: *1\n  time: 2025-11-21 04:36:57.788773000 Z\n"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.3ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 04:38:43.922489"], ["id", 3]]
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:38:43.922489"], ["item_id", 3], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die:\nid: 3\nname: Rogue\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.792681000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.792681000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.792681000 Z\n  zone: *1\n  time: 2025-11-21 04:36:57.792681000 Z\n"]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Cleric"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (0.9ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 04:38:43.927642"], ["id", 4]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 04:38:43.927642"], ["item_id", 4], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die:\nid: 4\nname: Cleric\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.796270000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.796270000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.796270000 Z\n  zone: *1\n  time: 2025-11-21 04:36:57.796270000 Z\n"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
TerminalDmChannel#quick_action({"params" => {}})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 67], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 29], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:39:35.702752') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.8ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:39:35.703940') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:39:35.705074') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (2.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "I quick action."], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I quick action.</p>\n"], ["created_at", "2025-11-21 04:39:40.987409"], ["updated_at", "2025-11-21 04:39:40.987409"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "I need a bit more detail to help you with a quick action! Could you clarify:\n\n- Are we in combat and you want to use your **bonus action**?\n- Are you looking to perform a quick skill check or ability?\n- Do you want to do something specific with Archibald?\n\nSince we just created your character, we're not currently in combat, so I want to make sure I understand what kind of quick action you'd like to take. What would you like Archibald to do?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I need a bit more detail to help you with a quick action! Could you clarify:</p>\n\n<ul>\n<li>Are we in combat and you want to use your <strong>bonus action</strong>?</li>\n<li>Are you looking to perform a quick skill check or ability?</li>\n<li>Do you want to do something specific with Archibald?</li>\n</ul>\n\n<p>Since we just created your character, we're not currently in combat, so I want to make sure I understand what kind of quick action you'd like to take. What would you like Archibald to do?</p>\n"], ["created_at", "2025-11-21 04:39:40.993852"], ["updated_at", "2025-11-21 04:39:40.993852"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw: {type: "dm_response", narrative: "<p>I need a bit more detail to help you with a quick action! Could you clarify:</p>\n\n<ul>\n<li>Are we in combat and you want to use your <strong>bonus action</strong>?</li>\n<li>Are you looking to perform a quick skill check or ability?</li>\n<li>Do you want to...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I need a bit more detail to help you with a quick action! Could you clarify:</p>\n\n<ul>\n<li>Are we in combat and you want to use your <strong>bonus action</strong>?</li>\n<li>Are you looking to perform a quick skill check or ability?</li>\n<li>Do you... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw)
TerminalDmChannel#send_message({"message" => "what can i do? what do i have"})
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 67], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 29], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 02:40:16.127156') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 00:40:16.128073') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 00:40:16.129096') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 67], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.8ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 67], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.2ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "what can i do? what do i have"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>what can i do? what do i have</p>\n"], ["created_at", "2025-11-21 04:40:25.249933"], ["updated_at", "2025-11-21 04:40:25.249933"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 67], ["content", "Let me show you what **Archibald** has at his disposal as a 1st level Rogue with a Guild Artisan (Watchmaker) background:\n\n## **Your Abilities**\n- **Strength:** 10 (+0)\n- **Dexterity:** 15 (+2) \n- **Constitution:** 14 (+2)\n- **Intelligence:** 13 (+1)\n- **Wisdom:** 12 (+1)\n- **Charisma:** 8 (-1)\n\n## **Combat Stats**\n- **Armor Class:** 12 (Leather Armor + Dex)\n- **Hit Points:** 10 \n- **Speed:** 30 feet\n- **Proficiency Bonus:** +2\n\n## **Skills** (Proficient)\n- **Sleight of Hand** (+4) - Perfect for pickpocketing and fine manipulation\n- **Stealth** (+4) - Moving unseen\n- **Thieves' Tools** (+4) - Lock picking, trap disarming\n- **Insight** (+3) - Reading people's motives\n- **Persuasion** (+1) - From your guild connections\n\n## **Equipment**\n- Leather armor\n- Shortsword\n- Shortbow with 20 arrows\n- Thieves' tools\n- Watchmaker's tools\n- Fine clothes\n- Signet ring of your guild\n- 15 gold pieces\n\n## **Special Abilities**\n- **Sneak Attack:** Extra 1d6 damage when you have advantage or an ally is adjacent to your target\n- **Expertise:** Double proficiency on Thieves' Tools and Sleight of Hand\n- **Thieves' Cant:** Secret language of rogues and criminals\n\nWhat would you like to do with these capabilities?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Let me show you what <strong>Archibald</strong> has at his disposal as a 1st level Rogue with a Guild Artisan (Watchmaker) background:</p>\n\n<h2><strong>Your Abilities</strong></h2>\n\n<ul>\n<li><strong>Strength:</strong> 10 (+0)</li>\n<li><strong>Dexterity:</strong> 15 (+2) </li>\n<li><strong>Constitution:</strong> 14 (+2)</li>\n<li><strong>Intelligence:</strong> 13 (+1)</li>\n<li><strong>Wisdom:</strong> 12 (+1)</li>\n<li><strong>Charisma:</strong> 8 (-1)</li>\n</ul>\n\n<h2><strong>Combat Stats</strong></h2>\n\n<ul>\n<li><strong>Armor Class:</strong> 12 (Leather Armor + Dex)</li>\n<li><strong>Hit Points:</strong> 10 </li>\n<li><strong>Speed:</strong> 30 feet</li>\n<li><strong>Proficiency Bonus:</strong> +2</li>\n</ul>\n\n<h2><strong>Skills</strong> (Proficient)</h2>\n\n<ul>\n<li><strong>Sleight of Hand</strong> (+4) - Perfect for pickpocketing and fine manipulation</li>\n<li><strong>Stealth</strong> (+4) - Moving unseen</li>\n<li><strong>Thieves' Tools</strong> (+4) - Lock picking, trap disarming</li>\n<li><strong>Insight</strong> (+3) - Reading people's motives</li>\n<li><strong>Persuasion</strong> (+1) - From your guild connections</li>\n</ul>\n\n<h2><strong>Equipment</strong></h2>\n\n<ul>\n<li>Leather armor</li>\n<li>Shortsword</li>\n<li>Shortbow with 20 arrows</li>\n<li>Thieves' tools</li>\n<li>Watchmaker's tools</li>\n<li>Fine clothes</li>\n<li>Signet ring of your guild</li>\n<li>15 gold pieces</li>\n</ul>\n\n<h2><strong>Special Abilities</strong></h2>\n\n<ul>\n<li><strong>Sneak Attack:</strong> Extra 1d6 damage when you have advantage or an ally is adjacent to your target</li>\n<li><strong>Expertise:</strong> Double proficiency on Thieves' Tools and Sleight of Hand</li>\n<li><strong>Thieves' Cant:</strong> Secret language of rogues and criminals</li>\n</ul>\n\n<p>What would you like to do with these capabilities?</p>\n"], ["created_at", "2025-11-21 04:40:25.254429"], ["updated_at", "2025-11-21 04:40:25.254429"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw: {type: "dm_response", narrative: "<p>Let me show you what <strong>Archibald</strong> has at his disposal as a 1st level Rogue with a Guild Artisan (Watchmaker) background:</p>\n\n<h2><strong>Your Abilities</strong></h2>\n\n<ul>\n<li><strong>Strength:</strong> 10 (+0)</li>\n<li><strong>Dexterity:<...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Let me show you what <strong>Archibald</strong> has at his disposal as a 1st level Rogue with a Guild Artisan (Watchmaker) background:</p>\n\n<h2><strong>Your Abilities</strong></h2>\n\n<ul>\n<li><strong>Strength:</strong> 10 (+0)</li>\n<li><strong>Dex... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw)
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:06:04 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82Nw
TerminalDmChannel stopped streaming from terminal_session_67
Started GET "/" for 127.0.0.1 at 2025-11-20 21:06:04 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (21.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (2.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.9ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (4.2ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "79aa74533d3654d49d5194102f62cce1"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (1.8ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 05:06:04.560149"], ["updated_at", "2025-11-21 05:06:04.560149"], ["session_token", "79aa74533d3654d49d5194102f62cce1"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (5.7ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:06:04.560149"], ["item_id", 68], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (3.2ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_7026ef013676f38a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 05:06:04.576690"], ["updated_at", "2025-11-21 05:06:04.581022"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:06:04.581022"], ["item_id", 30], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.0ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "79aa74533d3654d49d5194102f62cce1"], ["id", 68], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (3.1ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 05:06:04.589447"], ["campaign_id", 30], ["id", 68]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:06:04.589447"], ["item_id", 68], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 68\nuser_id: 6\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 05:06:04.560149000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 05:06:04.560149000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 05:06:04.560149000 Z\nsession_token: 79aa74533d3654d49d5194102f62cce1\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 68], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.5ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 68], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.9ms | Allocations: 2169)
  Rendered layout layouts/terminal.html.erb (Duration: 24.1ms | Allocations: 37643)
Completed 200 OK in 109ms (Views: 23.8ms | ActiveRecord: 21.3ms | Allocations: 122611)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 21:06:04 -0800
  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:06:04 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Unable to process TerminalDmChannel#show_character
TerminalDmChannel#send_message({"message" => "lets create a rogue named dartmouth"})
  [1m[36mCampaign Load (0.4ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 30], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 68], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.2ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 30], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (1.9ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:14:56.849356') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (2.2ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:14:56.854530') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:14:56.857404') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.8ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.6ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:211:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (1.1ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Dartmouth"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 15], ["dexterity", 14], ["constitution", 13], ["intelligence", 12], ["wisdom", 10], ["charisma", 8], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 30], ["race_id", 1], ["character_class_id", 3], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 05:14:59.980438"], ["updated_at", "2025-11-21 05:14:59.980438"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:14:59.980438"], ["item_id", 14], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gsub' for an instance of Integer
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:227:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (2.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "lets create a rogue named dartmouth"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>lets create a rogue named dartmouth</p>\n"], ["created_at", "2025-11-21 05:14:59.987591"], ["updated_at", "2025-11-21 05:14:59.987591"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "I'll create a rogue character named Dartmouth for you! Let me set up the basic character framework."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I'll create a rogue character named Dartmouth for you! Let me set up the basic character framework.</p>\n"], ["created_at", "2025-11-21 05:14:59.992708"], ["updated_at", "2025-11-21 05:14:59.992708"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA: {type: "dm_response", narrative: "<p>I'll create a rogue character named Dartmouth for you! Let me set up the basic character framework.</p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'gsub' for an instance of Integer", errors: ["undefined method 'gsub' for an ins...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I'll create a rogue character named Dartmouth for you! Let me set up the basic character framework.</p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undefined method 'gsub' for an instance of Integer", "errors" => ["undefi... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA)
TerminalDmChannel#quick_action({"params" => {}})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 68], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 30], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:15:05.076221') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.6ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:15:05.077254') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.5ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:15:05.078450') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (3.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.4ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "I quick action."], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I quick action.</p>\n"], ["created_at", "2025-11-21 05:15:10.385928"], ["updated_at", "2025-11-21 05:15:10.385928"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (4.3ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "I need a bit more information to create your rogue character Dartmouth. To use the character creation tool, I need to know:\n\n**Required information:**\n- **Race** - What race would you like Dartmouth to be? (Human, Elf, Halfling, Tiefling, etc.)\n\n**Optional information:**\n- **Background** - What was Dartmouth's life before becoming an adventurer? (Criminal, Folk Hero, Noble, etc.)\n\nOnce you provide the race, I can create Dartmouth as a rogue and we can get started with your adventure!\n\n*The character creation process is quick once we have these details sorted out.*"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>I need a bit more information to create your rogue character Dartmouth. To use the character creation tool, I need to know:</p>\n\n<p><strong>Required information:</strong><br>\n- <strong>Race</strong> - What race would you like Dartmouth to be? (Human, Elf, Halfling, Tiefling, etc.)</p>\n\n<p><strong>Optional information:</strong><br>\n- <strong>Background</strong> - What was Dartmouth's life before becoming an adventurer? (Criminal, Folk Hero, Noble, etc.)</p>\n\n<p>Once you provide the race, I can create Dartmouth as a rogue and we can get started with your adventure!</p>\n\n<p><em>The character creation process is quick once we have these details sorted out.</em></p>\n"], ["created_at", "2025-11-21 05:15:10.389492"], ["updated_at", "2025-11-21 05:15:10.389492"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA: {type: "dm_response", narrative: "<p>I need a bit more information to create your rogue character Dartmouth. To use the character creation tool, I need to know:</p>\n\n<p><strong>Required information:</strong><br>\n- <strong>Race</strong> - What race would you like Dartmouth to be? (Human, Elf, H...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>I need a bit more information to create your rogue character Dartmouth. To use the character creation tool, I need to know:</p>\n\n<p><strong>Required information:</strong><br>\n- <strong>Race</strong> - What race would you like Dartmouth to be? (Human... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA)
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacterClass Load (0.8ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

TerminalDmChannel#send_message({"message" => "noble human"})
  [1m[36mNarrativeOutput Load (0.4ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 68], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.3ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 30], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:15:39.556427') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.3ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:15:39.557226') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:15:39.557948') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 68], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (0.4ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (3.3ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Noble"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:204:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (0.7ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Dartmouth"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 15], ["dexterity", 14], ["constitution", 13], ["intelligence", 12], ["wisdom", 10], ["charisma", 8], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 30], ["race_id", 1], ["character_class_id", 3], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 05:15:42.768271"], ["updated_at", "2025-11-21 05:15:42.768271"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:15:42.768271"], ["item_id", 15], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gsub' for an instance of Integer
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:227:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (1.9ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (1.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "noble human"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>noble human</p>\n"], ["created_at", "2025-11-21 05:15:42.775453"], ["updated_at", "2025-11-21 05:15:42.775453"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 68], ["content", "Perfect! Let me create Dartmouth, a noble human rogue for you."], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Perfect! Let me create Dartmouth, a noble human rogue for you.</p>\n"], ["created_at", "2025-11-21 05:15:42.778048"], ["updated_at", "2025-11-21 05:15:42.778048"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA: {type: "dm_response", narrative: "<p>Perfect! Let me create Dartmouth, a noble human rogue for you.</p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'gsub' for an instance of Integer", errors: ["undefined method 'gsub' for an instance of Integer"], tool_name: "creat...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Perfect! Let me create Dartmouth, a noble human rogue for you.</p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undefined method 'gsub' for an instance of Integer", "errors" => ["undefined method 'gsub' for an instance of ... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA)
Unable to process TerminalDmChannel#show_character
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacterClass Load (0.7ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.5ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 05:16:04.099189"], ["id", 1]]
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:16:04.099189"], ["item_id", 1], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: 0\nid: 1\nname: Fighter\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.782935000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.782935000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:38:43.889678000 Z\n  zone: *1\n  time: 2025-11-21 04:38:43.889678000 Z\n"]]
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (1.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Wizard"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.0ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 05:16:04.118228"], ["id", 2]]
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:16:04.118228"], ["item_id", 2], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: 0\nid: 2\nname: Wizard\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.788773000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.788773000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:38:43.904216000 Z\n  zone: *1\n  time: 2025-11-21 04:38:43.904216000 Z\n"]]
  [1m[36mTRANSACTION (2.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.0ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 05:16:04.139530"], ["id", 3]]
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:16:04.139530"], ["item_id", 3], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: 0\nid: 3\nname: Rogue\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.792681000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.792681000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:38:43.922489000 Z\n  zone: *1\n  time: 2025-11-21 04:38:43.922489000 Z\n"]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.2ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Cleric"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (0.7ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", 0], ["updated_at", "2025-11-21 05:16:04.144348"], ["id", 4]]
  [1m[36mPaperTrail::Version Create (0.2ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:16:04.144348"], ["item_id", 4], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: 0\nid: 4\nname: Cleric\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.796270000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.796270000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:38:43.927642000 Z\n  zone: *1\n  time: 2025-11-21 04:38:43.927642000 Z\n"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.6ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL[0m
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.2ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to ChangeHitDieToString (20251121051624)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (11.7ms)[0m  [1m[35mALTER TABLE "character_classes" ALTER COLUMN "hit_die" TYPE character varying[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.4ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251121051624') RETURNING "version"[0m
  [1m[36mTRANSACTION (2.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:36:18 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-20 21:36:18 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mActiveRecord::SchemaMigration Load (1.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (70.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:36:18 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (3.1ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[36mCharacterClass Load (0.7ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Fighter"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.6ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", "d10"], ["updated_at", "2025-11-21 05:36:20.599208"], ["id", 1]]
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:20.599208"], ["item_id", 1], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: '0'\nid: 1\nname: Fighter\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.782935000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.782935000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 05:16:04.099189000 Z\n  zone: *1\n  time: 2025-11-21 05:16:04.099189000 Z\n"]]
  [1m[36mTRANSACTION (2.1ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.4ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Wizard"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.2ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", "d6"], ["updated_at", "2025-11-21 05:36:20.635835"], ["id", 2]]
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:20.635835"], ["item_id", 2], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: '0'\nid: 2\nname: Wizard\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.788773000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.788773000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 05:16:04.118228000 Z\n  zone: *1\n  time: 2025-11-21 05:16:04.118228000 Z\n"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.2ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Rogue"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (1.2ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", "d8"], ["updated_at", "2025-11-21 05:36:20.652843"], ["id", 3]]
  [1m[36mPaperTrail::Version Create (0.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:20.652843"], ["item_id", 3], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: '0'\nid: 3\nname: Rogue\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.792681000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.792681000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 05:16:04.139530000 Z\n  zone: *1\n  time: 2025-11-21 05:16:04.139530000 Z\n"]]
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.8ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Cleric"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mCharacterClass Update (0.8ms)[0m  [1m[33mUPDATE "character_classes" SET "hit_die" = $1, "updated_at" = $2 WHERE "character_classes"."id" = $3[0m  [["hit_die", "d8"], ["updated_at", "2025-11-21 05:36:20.659156"], ["id", 4]]
  [1m[36mPaperTrail::Version Create (0.8ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:20.659156"], ["item_id", 4], ["item_type", "CharacterClass"], ["event", "update"], ["object", "---\nhit_die: '0'\nid: 4\nname: Cleric\nprimary_ability:\nsaving_throw_proficiencies:\nskill_proficiencies:\narmor_proficiencies:\nweapon_proficiencies:\nstarting_equipment:\nclass_features:\nspellcasting_ability:\ndescription:\ndiscarded_at:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 04:36:57.796270000 Z\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 04:36:57.796270000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: 2025-11-21 05:16:04.144348000 Z\n  zone: *1\n  time: 2025-11-21 05:16:04.144348000 Z\n"]]
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mCharacterClass Load (0.3ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL[0m
Started GET "/" for 127.0.0.1 at 2025-11-20 21:36:40 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Processing by TerminalController#show as HTML
  [1m[36mUser Load (1.8ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:135:in 'TerminalController#guest_user'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mBEGIN[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Exists? (1.9ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 LIMIT $2[0m  [["session_token", "cb74f8c9dbf55a629f5a7478664dc647"], ["LIMIT", 1]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mTerminalSession Create (3.0ms)[0m  [1m[32mINSERT INTO "terminal_sessions" ("user_id", "title", "mode", "active", "character_id", "dungeon_map_id", "solo_session_id", "map_render_mode", "show_map_panel", "command_history", "settings", "discord_channel_id", "discord_guild_id", "discord_thread_id", "created_at", "updated_at", "session_token", "campaign_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18) RETURNING "id"[0m  [["user_id", 6], ["title", "New Adventure"], ["mode", "creation"], ["active", true], ["character_id", nil], ["dungeon_map_id", nil], ["solo_session_id", nil], ["map_render_mode", "ascii"], ["show_map_panel", true], ["command_history", "[]"], ["settings", "{}"], ["discord_channel_id", nil], ["discord_guild_id", nil], ["discord_thread_id", nil], ["created_at", "2025-11-21 05:36:40.055714"], ["updated_at", "2025-11-21 05:36:40.055714"], ["session_token", "cb74f8c9dbf55a629f5a7478664dc647"], ["campaign_id", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mPaperTrail::Version Create (1.4ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:40.055714"], ["item_id", 69], ["item_type", "TerminalSession"], ["event", "create"], ["object", nil]]
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mCampaign Create (1.6ms)[0m  [1m[32mINSERT INTO "campaigns" ("name", "description", "status", "visibility", "dm_id", "theme", "world_time", "current_location", "settings", "house_rules", "max_players", "timezone", "session_frequency", "ai_assistant_enabled", "deleted_at", "world_id", "min_level", "max_level", "category", "tags", "discarded_at", "template_id", "looking_for_players", "player_capacity", "play_style", "next_session_at", "created_at", "updated_at", "world_state") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29) RETURNING "id"[0m  [["name", "Terminal Session - guest_7026ef013676f38a"], ["description", "Auto-generated campaign for terminal/solo play"], ["status", nil], ["visibility", "private"], ["dm_id", nil], ["theme", nil], ["world_time", nil], ["current_location", nil], ["settings", nil], ["house_rules", nil], ["max_players", nil], ["timezone", nil], ["session_frequency", nil], ["ai_assistant_enabled", nil], ["deleted_at", nil], ["world_id", nil], ["min_level", 1], ["max_level", 20], ["category", nil], ["tags", "[]"], ["discarded_at", nil], ["template_id", nil], ["looking_for_players", nil], ["player_capacity", nil], ["play_style", nil], ["next_session_at", nil], ["created_at", "2025-11-21 05:36:40.069561"], ["updated_at", "2025-11-21 05:36:40.074581"], ["world_state", "{}"]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:40.074581"], ["item_id", 31], ["item_type", "Campaign"], ["event", "create"], ["object", nil]]
  ↳ app/models/terminal_session.rb:108:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Exists? (1.1ms)[0m  [1m[34mSELECT 1 AS one FROM "terminal_sessions" WHERE "terminal_sessions"."session_token" = $1 AND "terminal_sessions"."id" != $2 LIMIT $3[0m  [["session_token", "cb74f8c9dbf55a629f5a7478664dc647"], ["id", 69], ["LIMIT", 1]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTerminalSession Update (2.4ms)[0m  [1m[33mUPDATE "terminal_sessions" SET "updated_at" = $1, "campaign_id" = $2 WHERE "terminal_sessions"."id" = $3[0m  [["updated_at", "2025-11-21 05:36:40.081292"], ["campaign_id", 31], ["id", 69]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mPaperTrail::Version Create (0.9ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:36:40.081292"], ["item_id", 69], ["item_type", "TerminalSession"], ["event", "update"], ["object", "---\nid: 69\nuser_id: 6\ntitle: New Adventure\nmode: creation\nactive: true\ncharacter_id:\ndungeon_map_id:\nsolo_session_id:\nmap_render_mode: ascii\nshow_map_panel: true\ncommand_history: \"[]\"\nsettings: \"{}\"\ndiscord_channel_id:\ndiscord_guild_id:\ndiscord_thread_id:\ncreated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: &1 2025-11-21 05:36:40.055714000 Z\n  zone: &2 !ruby/object:ActiveSupport::TimeZone\n    name: Etc/UTC\n  time: 2025-11-21 05:36:40.055714000 Z\nupdated_at: !ruby/object:ActiveSupport::TimeWithZone\n  utc: *1\n  zone: *2\n  time: 2025-11-21 05:36:40.055714000 Z\nsession_token: cb74f8c9dbf55a629f5a7478664dc647\ncampaign_id:\n"]]
  ↳ app/models/terminal_session.rb:113:in 'TerminalSession#ensure_campaign'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/controllers/terminal_controller.rb:105:in 'TerminalController#set_or_create_session'
  [1m[36mNarrativeOutput Load (1.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 69], ["LIMIT", 50]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  Rendering layout layouts/terminal.html.erb
  Rendering terminal/show.html.erb within layouts/terminal
  [1m[36mQuickAction Load (1.3ms)[0m  [1m[34mSELECT "quick_actions".* FROM "quick_actions" WHERE "quick_actions"."terminal_session_id" = $1 AND "quick_actions"."is_available" = $2 ORDER BY "quick_actions"."sort_order" ASC[0m  [["terminal_session_id", 69], ["is_available", true]]
  ↳ app/views/terminal/show.html.erb:101:in 'Enumerable#each_with_index'
  Rendered terminal/show.html.erb within layouts/terminal (Duration: 3.3ms | Allocations: 2166)
  Rendered layout layouts/terminal.html.erb (Duration: 14.6ms | Allocations: 35432)
Completed 200 OK in 73ms (Views: 14.6ms | ActiveRecord: 13.8ms | Allocations: 86165)


Started GET "/cable" for 127.0.0.1 at 2025-11-20 21:36:40 -0800
  [1m[35m (1.0ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:36:40 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel#send_message({"message" => "hello!"})
  [1m[36mCampaign Load (0.8ms)[0m  [1m[34mSELECT "campaigns".* FROM "campaigns" WHERE "campaigns"."discarded_at" IS NULL AND "campaigns"."id" = $1 LIMIT $2[0m  [["id", 31], ["LIMIT", 1]]
  ↳ app/services/ai_dm/dm_decision_engine.rb:19:in 'AiDm::DmDecisionEngine#initialize'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 69], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.8ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (1.2ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 31], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (2.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:36:45.839631') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.5ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:36:45.847186') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:36:45.848867') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.0ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.0ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "hello!"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>hello!</p>\n"], ["created_at", "2025-11-21 05:36:53.222896"], ["updated_at", "2025-11-21 05:36:53.222896"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (1.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.6ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.0ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "Hello there, adventurer! Welcome to the realm of endless possibilities! \n\n*The air shimmers with magical potential as you step into this new world of adventure.*\n\nI'm your **Dungeon Master**, ready to guide you through epic quests, treacherous dungeons, and memorable encounters. Whether you're a seasoned veteran of the tabletop or just beginning your journey into D&D 5th Edition, we'll craft an amazing story together.\n\n**What would you like to do first?**\n\n- **Create a new character** - Let's build your hero from the ground up\n- **Begin an adventure** - Jump right into the action with a pre-made character\n- **Explore the world** - Learn about the setting and available campaigns\n- **Ask questions** - Get help with rules, mechanics, or anything D&D related\n\n*The dice are ready, the adventure awaits...*\n\nWhat calls to you, brave soul?"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p>Hello there, adventurer! Welcome to the realm of endless possibilities! </p>\n\n<p><em>The air shimmers with magical potential as you step into this new world of adventure.</em></p>\n\n<p>I'm your <strong>Dungeon Master</strong>, ready to guide you through epic quests, treacherous dungeons, and memorable encounters. Whether you're a seasoned veteran of the tabletop or just beginning your journey into D&amp;D 5th Edition, we'll craft an amazing story together.</p>\n\n<p><strong>What would you like to do first?</strong></p>\n\n<ul>\n<li><strong>Create a new character</strong> - Let's build your hero from the ground up</li>\n<li><strong>Begin an adventure</strong> - Jump right into the action with a pre-made character</li>\n<li><strong>Explore the world</strong> - Learn about the setting and available campaigns</li>\n<li><strong>Ask questions</strong> - Get help with rules, mechanics, or anything D&amp;D related</li>\n</ul>\n\n<p><em>The dice are ready, the adventure awaits...</em></p>\n\n<p>What calls to you, brave soul?</p>\n"], ["created_at", "2025-11-21 05:36:53.232869"], ["updated_at", "2025-11-21 05:36:53.232869"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ: {type: "dm_response", narrative: "<p>Hello there, adventurer! Welcome to the realm of endless possibilities! </p>\n\n<p><em>The air shimmers with magical potential as you step into this new world of adventure.</em></p>\n\n<p>I'm your <strong>Dungeon Master</strong>, ready to guide you through epi...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p>Hello there, adventurer! Welcome to the realm of endless possibilities! </p>\n\n<p><em>The air shimmers with magical potential as you step into this new world of adventure.</em></p>\n\n<p>I'm your <strong>Dungeon Master</strong>, ready to guide you thr... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ)
TerminalDmChannel#quick_action({"params" => {}})
  [1m[36mNarrativeOutput Load (1.0ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 69], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (2.1ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 31], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:37:33.183578') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:37:33.185460') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.7ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:37:33.187224') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.3ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (6.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "I quick action."], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I quick action.</p>\n"], ["created_at", "2025-11-21 05:37:42.265673"], ["updated_at", "2025-11-21 05:37:42.265673"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (1.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.5ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (2.7ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "*The tavern door bursts open with a thunderous crash!*\n\nA **hooded figure** stumbles in, clutching a bleeding wound on their arm. Rain and wind whip through the doorway as they scan the room desperately.\n\n\"Please!\" they gasp, \"*They're coming!* The **Shadow Cult** has found the artifact - we need someone brave enough to—\"\n\n*CRASH!*\n\nThe window explodes inward as three **dark-cloaked assassins** leap through, obsidian daggers gleaming in the firelight. The other patrons scream and dive for cover.\n\nThe wounded figure locks eyes with you: **\"Help me, and I'll share the secret of the *Sunblade's* resting place!\"**\n\n---\n\n**INITIATIVE TIME!**\n\nI need you to quickly tell me:\n- **What kind of character are you?** (Fighter with a sword? Wizard with spells? Rogue with daggers? Just give me the basics!)\n- **What's your first move?** (Attack the assassins? Protect the stranger? Cast a spell? Dive for cover?)\n\n*The assassins raise their weapons - there's no time to waste!*\n\n🎲 *Ready for some fast-paced combat?*"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><em>The tavern door bursts open with a thunderous crash!</em></p>\n\n<p>A <strong>hooded figure</strong> stumbles in, clutching a bleeding wound on their arm. Rain and wind whip through the doorway as they scan the room desperately.</p>\n\n<p>\"Please!\" they gasp, \"<em>They're coming!</em> The <strong>Shadow Cult</strong> has found the artifact - we need someone brave enough to—\"</p>\n\n<p><em>CRASH!</em></p>\n\n<p>The window explodes inward as three <strong>dark-cloaked assassins</strong> leap through, obsidian daggers gleaming in the firelight. The other patrons scream and dive for cover.</p>\n\n<p>The wounded figure locks eyes with you: <strong>\"Help me, and I'll share the secret of the <em>Sunblade's</em> resting place!\"</strong></p>\n\n<hr>\n\n<p><strong>INITIATIVE TIME!</strong></p>\n\n<p>I need you to quickly tell me:<br>\n- <strong>What kind of character are you?</strong> (Fighter with a sword? Wizard with spells? Rogue with daggers? Just give me the basics!)<br>\n- <strong>What's your first move?</strong> (Attack the assassins? Protect the stranger? Cast a spell? Dive for cover?)</p>\n\n<p><em>The assassins raise their weapons - there's no time to waste!</em></p>\n\n<p>🎲 <em>Ready for some fast-paced combat?</em></p>\n"], ["created_at", "2025-11-21 05:37:42.278475"], ["updated_at", "2025-11-21 05:37:42.278475"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ: {type: "dm_response", narrative: "<p><em>The tavern door bursts open with a thunderous crash!</em></p>\n\n<p>A <strong>hooded figure</strong> stumbles in, clutching a bleeding wound on their arm. Rain and wind whip through the doorway as they scan the room desperately.</p>\n\n<p>\"Please!\" they ...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><em>The tavern door bursts open with a thunderous crash!</em></p>\n\n<p>A <strong>hooded figure</strong> stumbles in, clutching a bleeding wound on their arm. Rain and wind whip through the doorway as they scan the room desperately.</p>\n\n<p>\"Please!... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ)
TerminalDmChannel#send_message({"message" => "I want to multiclass paladin barbarian"})
  [1m[36mNarrativeOutput Load (0.9ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 ORDER BY "narrative_outputs"."created_at" DESC LIMIT $2[0m  [["terminal_session_id", 69], ["LIMIT", 10]]
  ↳ app/models/terminal_session.rb:49:in 'TerminalSession#recent_narrative'
  [1m[36mDmPendingAction Count (0.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:226:in 'AiDm::Orchestrator#game_state_context'
  [1m[36mQuestLog Load (0.8ms)[0m  [1m[34mSELECT "quest_logs".* FROM "quest_logs" WHERE "quest_logs"."discarded_at" IS NULL AND "quest_logs"."campaign_id" = $1 AND "quest_logs"."status" IN ($2, $3) AND (presentation_count > 0 OR consequence_applied = true OR resolution_type IS NOT NULL)[0m  [["campaign_id", 31], ["status", "active"], ["status", "available"]]
  ↳ app/services/ai_dm/orchestrator.rb:244:in 'Enumerable#map'
  [1m[36mDmActionAuditLog Load (0.6ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 03:38:23.862464') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 20]]
  ↳ app/services/content/pacing_analyzer.rb:107:in 'Content::PacingAnalyzer#fetch_recent_actions'
  [1m[36mNarrativeOutput Load (0.7ms)[0m  [1m[34mSELECT "narrative_outputs".* FROM "narrative_outputs" WHERE "narrative_outputs"."terminal_session_id" = $1 AND "narrative_outputs"."content_type" = $2 AND (created_at >= '2025-11-21 01:38:23.863779') ORDER BY "narrative_outputs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["content_type", "player"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:179:in 'Player::IntentAnalyzer#fetch_player_messages'
  [1m[36mDmActionAuditLog Load (0.4ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 AND (created_at >= '2025-11-21 01:38:23.865066') ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 30]]
  ↳ app/services/player/intent_analyzer.rb:192:in 'Player::IntentAnalyzer#fetch_dm_actions'
  [1m[36mDmActionAuditLog Load (0.2ms)[0m  [1m[34mSELECT "dm_action_audit_logs".* FROM "dm_action_audit_logs" WHERE "dm_action_audit_logs"."terminal_session_id" = $1 AND "dm_action_audit_logs"."execution_status" = $2 ORDER BY "dm_action_audit_logs"."created_at" DESC LIMIT $3[0m  [["terminal_session_id", 69], ["execution_status", "executed"], ["LIMIT", 10]]
  ↳ app/services/ai_dm/orchestrator.rb:376:in 'Enumerable#map'
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mRace Load (1.2ms)[0m  [1m[34mSELECT "races".* FROM "races" WHERE "races"."discarded_at" IS NULL AND "races"."name" = $1 LIMIT $2[0m  [["name", "Human"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:202:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.8ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL AND "character_classes"."name" = $1 LIMIT $2[0m  [["name", "Paladin"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacterClass Load (0.5ms)[0m  [1m[34mSELECT "character_classes".* FROM "character_classes" WHERE "character_classes"."discarded_at" IS NULL ORDER BY "character_classes"."id" ASC LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:203:in 'AiDm::ToolExecutor#create_character'
  [1m[36mBackground Load (0.7ms)[0m  [1m[34mSELECT "backgrounds".* FROM "backgrounds" WHERE "backgrounds"."discarded_at" IS NULL AND "backgrounds"."name" = $1 LIMIT $2[0m  [["name", "Soldier"], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:204:in 'AiDm::ToolExecutor#create_character'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/services/ai_dm/tool_executor.rb:211:in 'AiDm::ToolExecutor#create_character'
  [1m[36mCharacter Create (3.2ms)[0m  [1m[32mINSERT INTO "characters" ("name", "level", "experience", "proficiency_bonus", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "hit_points_current", "hit_points_max", "temporary_hit_points", "armor_class", "initiative_bonus", "speed", "alignment", "personality_traits", "ideals", "bonds", "flaws", "backstory", "skills", "proficiencies", "conditions", "avatar_url", "visibility", "deleted_at", "user_id", "campaign_id", "race_id", "character_class_id", "background_id", "character_voice", "ai_personality_profile", "catchphrases", "homebrew_modifications", "custom_features", "house_rules", "quick_actions", "favorite_spells", "combat_tactics", "theme_preferences", "portrait_url", "token_url", "last_session_notes", "session_count", "total_playtime_hours", "faction_affiliations", "faction_reputations", "current_hp", "max_hp", "temporary_hp", "death_save_successes", "death_save_failures", "spell_slots", "concentration_spell_id", "damage_resistances", "damage_immunities", "damage_vulnerabilities", "active_effects", "resistances", "immunities", "vulnerabilities", "hit_dice_used", "created_at", "updated_at", "discarded_at", "gold") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30, $31, $32, $33, $34, $35, $36, $37, $38, $39, $40, $41, $42, $43, $44, $45, $46, $47, $48, $49, $50, $51, $52, $53, $54, $55, $56, $57, $58, $59, $60, $61, $62, $63, $64, $65, $66, $67, $68, $69) RETURNING "id"[0m  [["name", "Tempest Ironwill"], ["level", 1], ["experience", nil], ["proficiency_bonus", nil], ["strength", 15], ["dexterity", 14], ["constitution", 13], ["intelligence", 12], ["wisdom", 10], ["charisma", 8], ["hit_points_current", nil], ["hit_points_max", nil], ["temporary_hit_points", nil], ["armor_class", nil], ["initiative_bonus", nil], ["speed", nil], ["alignment", nil], ["personality_traits", nil], ["ideals", nil], ["bonds", nil], ["flaws", nil], ["backstory", nil], ["skills", nil], ["proficiencies", nil], ["conditions", nil], ["avatar_url", nil], ["visibility", nil], ["deleted_at", nil], ["user_id", 6], ["campaign_id", 31], ["race_id", 1], ["character_class_id", 1], ["background_id", nil], ["character_voice", nil], ["ai_personality_profile", "{}"], ["catchphrases", "[]"], ["homebrew_modifications", "{}"], ["custom_features", "[]"], ["house_rules", "{}"], ["quick_actions", "[]"], ["favorite_spells", "[]"], ["combat_tactics", "[]"], ["theme_preferences", "{}"], ["portrait_url", nil], ["token_url", nil], ["last_session_notes", nil], ["session_count", 0], ["total_playtime_hours", "0.0"], ["faction_affiliations", "{}"], ["faction_reputations", "{}"], ["current_hp", nil], ["max_hp", nil], ["temporary_hp", 0], ["death_save_successes", 0], ["death_save_failures", 0], ["spell_slots", "{}"], ["concentration_spell_id", nil], ["damage_resistances", "[]"], ["damage_immunities", "[]"], ["damage_vulnerabilities", "[]"], ["active_effects", "[]"], ["resistances", "[]"], ["immunities", "[]"], ["vulnerabilities", "[]"], ["hit_dice_used", 0], ["created_at", "2025-11-21 05:38:28.905888"], ["updated_at", "2025-11-21 05:38:28.905888"], ["discarded_at", nil], ["gold", 0]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mPaperTrail::Version Create (0.3ms)[0m  [1m[32mINSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"[0m  [["whodunnit", nil], ["created_at", "2025-11-21 05:38:28.905888"], ["item_id", 16], ["item_type", "Character"], ["event", "create"], ["object", nil]]
  ↳ app/services/ai_dm/tool_executor.rb:210:in 'AiDm::ToolExecutor#create_character'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[31mROLLBACK[0m
  ↳ app/services/ai_dm/tool_executor.rb:62:in 'AiDm::ToolExecutor#execute_immediately'
Tool execution failed: undefined method 'gsub' for an instance of Integer
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:227:in 'AiDm::ToolExecutor#create_character'
/private/tmp/terminal-dnd/app/app/services/ai_dm/tool_executor.rb:65:in 'block in AiDm::ToolExecutor#execute_immediately'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:535:in 'block in ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activesupport-7.1.6/lib/active_support/concurrency/null_lock.rb:9:in 'ActiveSupport::Concurrency::NullLock#synchronize'
/opt/homebrew/lib/ruby/gems/3.4.0/gems/activerecord-7.1.6/lib/active_record/connection_adapters/abstract/transaction.rb:532:in 'ActiveRecord::ConnectionAdapters::TransactionManager#within_new_transaction'
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/services/ai_dm/orchestrator.rb:466:in 'Enumerable#map'
  [1m[36mTRANSACTION (1.3ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (3.1ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "I want to multiclass paladin barbarian"], ["content_type", "player"], ["clickable_elements", "[]"], ["rendered_html", "<p>I want to multiclass paladin barbarian</p>\n"], ["created_at", "2025-11-21 05:38:28.914582"], ["updated_at", "2025-11-21 05:38:28.914582"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mNarrativeOutput Create (0.9ms)[0m  [1m[32mINSERT INTO "narrative_outputs" ("terminal_session_id", "content", "content_type", "clickable_elements", "rendered_html", "created_at", "updated_at", "memory_hints", "speaker", "related_room_id", "related_npc_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING "id"[0m  [["terminal_session_id", 69], ["content", "**Excellent choice!** A **Paladin/Barbarian** - divine fury incarnate! \n\n*Lightning quick, let me set you up for this fight:*"], ["content_type", "dm"], ["clickable_elements", "[]"], ["rendered_html", "<p><strong>Excellent choice!</strong> A <strong>Paladin/Barbarian</strong> - divine fury incarnate! </p>\n\n<p><em>Lightning quick, let me set you up for this fight:</em></p>\n"], ["created_at", "2025-11-21 05:38:28.919634"], ["updated_at", "2025-11-21 05:38:28.919634"], ["memory_hints", "[]"], ["speaker", nil], ["related_room_id", nil], ["related_npc_id", nil]]
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
  [1m[36mTRANSACTION (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/models/terminal_session.rb:80:in 'TerminalSession#add_narrative'
[ActionCable] Broadcasting to terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ: {type: "dm_response", narrative: "<p><strong>Excellent choice!</strong> A <strong>Paladin/Barbarian</strong> - divine fury incarnate! </p>\n\n<p><em>Lightning quick, let me set you up for this fight:</em></p>\n", is_html: true, tool_results: [{success: false, error: "undefined method 'gsub' for a...
TerminalDmChannel transmitting {"type" => "dm_response", "narrative" => "<p><strong>Excellent choice!</strong> A <strong>Paladin/Barbarian</strong> - divine fury incarnate! </p>\n\n<p><em>Lightning quick, let me set you up for this fight:</em></p>\n", "is_html" => true, "tool_results" => [{"success" => false, "error" => "undef... (via streamed from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ)
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:51:21 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-20 21:51:22 -0800
  [1m[35m (1.5ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 21:51:22 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (0.6ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 22:10:53 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-20 22:10:54 -0800
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (1.1ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 22:10:54 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.4ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Started GET "/cable" for 127.0.0.1 at 2025-11-20 22:11:02 -0800
  [1m[35m (1.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 22:11:02 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.5ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 22:28:28 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-20 22:28:29 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 22:28:29 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.6ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is transmitting the subscription confirmation
TerminalDmChannel is streaming from terminal_session_69
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 23:31:31 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-20 23:31:32 -0800
  [1m[35m (15.8ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-20 23:31:32 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (1.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:23:29 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-21 00:23:30 -0800
  [1m[35m (17.4ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:23:30 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (1.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:40:32 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-21 00:40:33 -0800
  [1m[35m (1.6ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:40:33 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (2.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.5ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (0.5ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:40:34 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-21 00:40:35 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 00:40:35 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 01:29:48 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-21 01:29:49 -0800
  [1m[35m (13.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 01:29:49 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.2ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (1.0ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 03:16:24 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel stopped streaming from terminal_session_69
Started GET "/cable" for 127.0.0.1 at 2025-11-21 03:16:25 -0800
  [1m[35m (21.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 03:16:25 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.6ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 69], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OQ
TerminalDmChannel is streaming from terminal_session_69
  [1m[36mDmPendingAction Load (1.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 69], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 69, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 03:52:06 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-21 03:52:07 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 03:52:07 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
  [1m[36mDmPendingAction Load (0.4ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 04:12:14 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-21 04:12:15 -0800
  [1m[35m (15.7ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 04:12:15 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (1.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
  [1m[36mDmPendingAction Load (1.2ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is transmitting the subscription confirmation
Finished "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 04:28:08 -0800
TerminalDmChannel stopped streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel stopped streaming from terminal_session_68
Started GET "/cable" for 127.0.0.1 at 2025-11-21 04:28:09 -0800
  [1m[35m (1.3ms)[0m  [1m[34mSELECT "flipper_features"."key" AS feature_key, "flipper_gates"."key", "flipper_gates"."value" FROM "flipper_features" LEFT OUTER JOIN "flipper_gates" ON "flipper_features"."key" = "flipper_gates"."feature_key"[0m
Started GET "/cable" [WebSocket] for 127.0.0.1 at 2025-11-21 04:28:09 -0800
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, Upgrade, HTTP_UPGRADE: websocket)
  [1m[36mUser Load (0.4ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" IS NULL LIMIT $1[0m  [["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:15:in 'ApplicationCable::Connection#find_verified_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."discarded_at" IS NULL AND "users"."id" = $1 LIMIT $2[0m  [["id", 6], ["LIMIT", 1]]
  ↳ app/channels/application_cable/connection.rb:22:in 'ApplicationCable::Connection#find_verified_user'
Registered connection (Z2lkOi8vdGVybWluYWwtZG5kL1VzZXIvNg)
  [1m[36mTerminalSession Load (0.3ms)[0m  [1m[34mSELECT "terminal_sessions".* FROM "terminal_sessions" WHERE "terminal_sessions"."id" = $1 AND "terminal_sessions"."user_id" = $2 LIMIT $3[0m  [["id", 68], ["user_id", 6], ["LIMIT", 1]]
  ↳ app/channels/terminal_dm_channel.rb:7:in 'TerminalDmChannel#subscribed'
  [1m[36mDmPendingAction Load (0.3ms)[0m  [1m[34mSELECT "dm_pending_actions".* FROM "dm_pending_actions" WHERE "dm_pending_actions"."terminal_session_id" = $1 AND "dm_pending_actions"."status" = $2[0m  [["terminal_session_id", 68], ["status", "pending"]]
  ↳ app/channels/terminal_dm_channel.rb:239:in 'Enumerable#map'
TerminalDmChannel transmitting {type: "connected", session_id: 68, mode: "creation", pending_approvals: []}
TerminalDmChannel is streaming from terminal_dm:Z2lkOi8vdGVybWluYWwtZG5kL1Rlcm1pbmFsU2Vzc2lvbi82OA
TerminalDmChannel is streaming from terminal_session_68
TerminalDmChannel is transmitting the subscription confirmation
DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

DEPRECATION WARNING: `Rails.application.secrets` is deprecated in favor of `Rails.application.credentials` and will be removed in Rails 7.2. (called from <main> at /private/tmp/terminal-dnd/app/config/environment.rb:5)
[Discord] Bot credentials not configured.
To enable Discord integration, add to credentials:

discord:
  bot_token: your_bot_token
  client_id: your_client_id
  webhook_url: your_webhook_url (optional)

Run: rails credentials:edit

  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_try_advisory_lock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (1.6ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
Migrating to AddRoomContextToTerminalSessions (20251121151701)
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (3.6ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "current_room" character varying DEFAULT 'lobby'[0m
  [1m[35m (0.4ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "game_started_at" timestamp(6)[0m
  [1m[35m (1.4ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "character_locked" boolean DEFAULT FALSE[0m
  [1m[35m (0.6ms)[0m  [1m[35mALTER TABLE "terminal_sessions" ADD "room_history" jsonb DEFAULT '[]'[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.6ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20251121151701') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.7ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT pg_advisory_unlock(7554378444290738340)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
